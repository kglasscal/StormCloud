---
title: 'Severe Weather: Preparing for Emergency Response'
author: "Kevin Glass"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
    toc_float:
      toc_collapsed: yes
    theme: united
---

```{r knitr setup}

knitr::opts_chunk$set(echo = TRUE)
options(max.print = 1000)

```

**CSS Code**
The CSS is used to set colors, boxes and some text attributes.
```{css}
.comment {
  background-color : #EDFFE9 ;
  border           : 2px solid #1A8E00;
  font-weight      : bold;
}

.code {
  background-color : #E9E9E9 ;
  border           : 2px solid #000000;
  font-weight      : bold;
}

.test {
  background-color : #F8F8F8 ;
  border           : 2px solid #CDCDFF;
  font-weight      : bold;
}

.state {
  background-color : #F8F8F8;
  border           : 2px solid #FFFF8B;
  width            : 100%; 
  font-weight      : normal;
  font-size        : 10; 
}

.output {
  padding          : 3px;
  background-color : #FFFFF8;
  border           : 1px solid #FFDAA2;
  font-size        : 10; 
}

.pre {
  background-color : #FFFFF8;
  border           : 0px;
  font-size        : 14; 
}

.stateResult {
  background-color : #FFFAF2;
  padding          : 3px;
  border           : 1px solid #FFCB79;
  width            : 80%; 
  font-weight      : normal;
  font-size        : 10; 
}

.stateTable {
  width            : 80%; 
  margin-left      : auto; 
  margin-right     : auto;
}

.testResults {
  width            : 80%; 
  padding          : 3px;
  border           : 1px solid #FFC4C9;
  background-color : #FFF4F5;
  font-weight      : normal;
}

.testTable {
  width            : 80%; 
  border           : 1px solid #FFE6E8;
  margin-left      : auto; 
  margin-right     : auto;
}

.testCaption {
  width            : 80%; 
  font-size        : 10px; 
  border           : 1px solid #FFE6E8;
  margin-left      : auto; 
  margin-right     : auto;
}

.displayTable {
  width         : 80%; 
  font-size     : 8px; 
  font-weight   : normal; 
  margin-top    : 0px;
  margin-bottom : 10px; 
  margin-right  : 160px; 
  margin-left   : 170px;
}

```

# Synopsis

This project is designed to assist emergency response organizations to prepare for severe weather events in the United States. With tornadoes in the Midwest, hurricanes in the Gulf Coast and Eastern Seaboard, severe winter storms in the Mountain West, etc., require these organizations aid recovery from different types of damage in different geographical regions. The National Oceanographic and Atmospheric Agency (NOAA) Storm Events Database (SED) has captured data related to these events from 1950 to the present.

The point of this project is to take the SED data and condense it to a list of events that cause the worst human and economic damage. The R code embedded in this document will analyze SED data will clean the data, remove data points that do not contribute to the analysis, and ensure all event types names are changed to National Weather Service (NWS) Instruction 10-1605 (NWS Instruction). With the cleaned data frame, the code will copy the data frame and order by the human damage and the other by the economic damage. The code will use the ordered data frames to produce tables and images to give emergency managers and others a concise description of most damaging to the least damaging weather events.

# Data Processing

**Overview** The purpose of this project is to answer the following questions:

1.  **Across the United States, which types of events are most harmful with respect to population health?**
2.  **Across the United States, which types of events have the greatest economic consequences?**

To answer these questions, the project must take the contents of a 500 MB **storm data file** provided from the National Oceanographic and Atmospheric Agency (NOAA) Storm Events Database [b] and condense its contents to a the set of valid events as defined by the National Weather Service (NWS) Instruction 10-1605 [a]. The condensed data must be ordered from the most to least harmful to public health and to economic consequences.

With this data, this document will display tables showing how the events rank in terms of **casualties** ("...harmful with respect to population health") and in terms of **economic losses** ("the greatest economic consequences"). It will also display two bar plots of the data to visualize both casualties and economic losses and another plot to comparing casualties and economic losses.

**About the Data**

The **storm data file** is a csv file containing more than 900,000 records with thirty-seven columns defining each of the 900,000+ data points. There are several problems in the database:

1.  Misspellings of event type names.
2.  Event type names with whitespace in front of or behind the name. Names like " FLOOD " and "FLOOD" are different because of the leading and trailing spaces, removing them will change the first name match the second;
3.  Inconsistent use of capitalization. Names like "BLACK ICE" and "black ice" are different because of the use of upper case letters, converting them to a single case representation, changing them to all lower case will make first name match the second (NOTE: all upper case would also work as would other approaches.); 
4.idiosyncratic event names, like "?" and "high" have no equivalent names in the NWS event type name conventions, though they have an impact on the casualty and loss values in the final data set.

The time span of the data set ranges from 1950 to 2012 (the last date in the set is (11/28/2011), but not all of this data used the same collection criteria.The data collection criteria have changed three time since its inception. The first set of criteria were applicable from 1950 to 1955 and accounted for tornadoes only. The second set of criteria were applicable from 1955 to 1996 and added thunderstorm wind, and hail. The third set was applicable from 1996 onward. These now include the following event types:

Astronomical Low Tide, Avalanche, Blizzard, Coastal Flood, Cold/Wind Chill, Debris Flow, Dense Fog, Dense Smoke, Drought, Dust Devil, Dust Storm, Excessive Heat, Extreme Cold/Wind Chill, Flash Flood, Flood, Freezing Fog, Frost/Freeze, Funnel Cloud, Heat, Heavy Rain, Heavy Snow, High Surf, High Wind, Hurricane/Typhoon, Ice Storm, Lakeshore Flood, Lake-Effect Snow, Lightning, Marine Hail, Marine High Wind ,Marine Strong Wind, Marine Thunderstorm Wind, Rip Current, Seiche, Sleet, Storm Surge/Tide, Strong Wind, Thunderstorm Wind, Tornado, Tropical Depression, Tropical Storm, Tsunami, Volcanic Ash, Waterspout, Wildfire, Winter Storm, Winter Weather

```{=html}

<p style="">The analysis is restricted the to time span to 1996 to 2012.</p>

```

**Processing the Data**

The **storm data file** is a roughly 500 MB csv file with over 900,000 rows and 37 columns. The embedded R code will 
1. Reduce the number of columns it reads to seven, so the read will create a 902297 row by 7 column data frame.
2. Remove any row with all numerical values equal to zero. These rows will not contribute to the analysis the data, so there is no reason to keep them. 
3. Clean and convert all string values to lower case. This will simplify comparison functions.
4. Transform to the appropriate NWS Instruction type names.

The data analysis will produce a list of the most to least harmful events and list of the most economically damaging to the least damaging. Both of these lists will be presented as tables in the document. Also, both tables will be used to produce bar graphs to visualize the data. A third plot will show the relationship between the casualties and economic losses for each event type.

<hr style="background : black; height : 15px"/>

## Processing Code

### Required Libraries

```{r libraries, class.source="comment"}
### Required Libraries #########################################################
### This code block loads the tables required to run the complete code.
################################################################################
```
```{r class.source="code"}
library(knitr)
library(stringr)
library(dplyr)
library(rlist)
library(kableExtra)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(usefun)
```

### "Constants"

```{r constants, class.source="comment"}
### "Constants" ################################################################
### The following variables are used as constants, that is, the must not be 
### changed after they are assigned a value. For clarity, all "constant" 
### variables are spelled in all upper case letters to distinguish them from 
### other variables.
### 
### This code block will give a brief description of the constants and more 
### detailed will be provded in the code block using them.
################################################################################
```

```{r class.source="code"}
# The URL and STORM_DATA_FILE are assigned here
URL      = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
STORM_DATA_FILE = "storm.csv.bz2"

# The number of years in the data frame. This is used to convert values to 
# value per year.
PER_ANUM = 2012.0 - 1996.0

# Many constants are set up as arrays of two values. To make the meaning clear,
# the code uses the indices, rather than 1 or 2 to access the appropriate array
# element.
CASUALTY_IDX   = 1
ECONOMIC_IDX   = 2


# Kable tables
TABLE_FIELDS <-  c("c('EVTYPE', 'CASUALTIES', 'PERCENT', 'ACC_PERCENT')",
                  "c('EVTYPE', 'ECONOMIC_LOSSES', 'PERCENT', 'ACC_PERCENT')")

TABLE_LABELS <- list(
    c("Event Type", "Casualties/year", "Percent of Total", 
      "Accumulated Percent"),
    c("Event Type", "Economic Losses/year (in millions)", "Percent of Total", 
      "Accumulated Percent")
    )

DAMAGE_LABELS <- c("Casualties/year", "Economic Losses/year")
DAMAGE_ORDERING = c("desc(.$CASUALTIES)", "desc(.$ECONOMIC_LOSSES)")

# Barplots names 
BAR_SELECT  = c("c('EVTYPE', 'CASUALTIES')",
                  "c('EVTYPE', 'ECONOMIC_LOSSES')")

BAR_REORDER = c("reorder(EVTYPE, -CASUALTIES)",
                   "reorder(EVTYPE, -ECONOMIC_LOSSES)")

BAR_FIELD   = c("CASUALTIES", "ECONOMIC_LOSSES")
```

```{r class.source="comment"}
### Verification "Constants" ###################################################
### 
### Setting up Verification
### 
### To ensure the code produces correct results, most code blocks and functions
### include test code. The output of the code is necessary to explain the what 
### results mean and how they show the results are valid.
###
### However, some of the validation code can create a large volume of output, 
### so printing the entire output may obscure the code in the document. To avoid 
### this, the code uses "constants" to include or ignore the validation code. 
### When the completed document is produced, the validation code is prevented 
### from printing.
### 
### The validation code is the body of if-statements in various parts of the 
### code. The logical condition of each statement use the following constants:
### 
### 1. CORRECTNESS - these validation statements print some set of values before
###                  and/or after the transformation code is executed. This 
###                  allows the code developer to verify the transformation 
###                  worked for at least part of the code and they can determine 
###                  the state of the data frame, i.e., the size of the data 
###                  frame, the dimensions, and the number of unique event 
###                  names.
### 
### 1. CORRECTNESS & ALL_DATA - this statement is used only once. It is used to 
###                  load all of the data in the storm data file into a single
###                  data frame. The head of the data frame is printed to verify
###                  the title and first few rows were correctly loaded and to
###                  collect state information.
###                  
### VALIDATE_UNIFICATION - the unification process changes the event type names 
###                  from the storm data file to names from the NWS Information
###                  document. The VALIDATE_UNIFICATION statements will print 
###                  each unification and print the results. To verify the 
###                  process is running correctly each name is compared to the 
###                  pre-unification names. When they match correctly, then the
###                  function is working correctly.
### 
################################################################################
```

```{r class.source="code"}

CORRECTNESS               = FALSE
ALL_DATA                  = FALSE
VALIDATE_UNIFICATION      = FALSE

```

### Unify Names

```{r class.source="comment"}
### UnifyNames function ########################################################
### This function is called from Unify Event Types (Transformation 5). It might 
### not make sense without reading that transformation first. In any case it is 
### extremely long with little variation in each block. If the reader has 
### nothing better to do with their time, feel free read through the entire
### 1500 lines of code, but do so with some sort of stimulant.
### 
### Some of the data collectors did not adhere to the NWS Instruction naming 
### convention as a result, one event type could have several type names. The 
### following code is designed to force all event type names in the data frame 
### to conform to the NWS conventions using grepl statements.
###
### Side note on validation:
### To validate the correctness of each name unification
### 1. the name of all events were printed to "oldEvts.csv", 
### 2. each change was recorded as
###   1. regular expression, 
###   2. pre-change name, 
###   3. post change name. 
### 3. the changes were printed to "unify.csv"
### 4. the "oldEvents.csv" were compared to "unify.csv"
###   1. each set was ordered alphabetically by event
###   2. the first comparison made sure both sets had the same pre-change names
###   3. the second comparison made sure the expected name change matched the
###     the actual one.
### 
### The final output matched the expected output.
################################################################################
```

```{r UnifyNames, class.source="code"}
UnifyNames <- function(stormDF) {
  if (VALIDATE_UNIFICATION) {
    write.csv(stormDF$EVTYPE, "oldEvts.csv")
  }

  if (VALIDATE_UNIFICATION) {
    testDF <-
      data.frame(grep = character(0), start = character(0),
                 finish = character(0))
    start <- NULL
  }
  
# ==============================================================================
# For each event type starting with "thunders" or "tstm" change the type to the
# corresponding NWS event. These changes are:
# 
# 1. ^(thunders|tstm).*flood.* -> Flood
# 2. ^(thunders|tstm).*light.* -> Lightning
# 3. ^(thunders|tstm).*hail.*  -> Hail
# default -> Thunderstorm Wind
# 
# ==============================================================================
  tempVect <- which(grepl("^(thunders|tstm)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl(".*flood.*", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flood"
    } else if(grepl(".*light.*", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Lightning"
    } else if(grepl(".*hail.*", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Hail"
    } else {
      stormDF[temp, "EVTYPE"] <- "Thunderstorm Wind"
    }

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^(thunders|tstm)",
                                     start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "tun", "thu", "thundere", "thundert", "
# thundee", "severe t", "whirl", "tun", or "whirl" change the type to the
# corresponding NWS event. These changes are:
# 
# 1. ^tun       -> Thunderstorm Wind
# 2. ^thu       -> Thunderstorm Wind
# 3. ^thundere  -> Thunderstorm Wind
# 4. ^thundert  -> Thunderstorm Wind
# 5. ^thundee   -> Thunderstorm Wind
# 6. ^severe t  -> Thunderstorm Wind
# 7. ^whirl     -> Thunderstorm Wind
# ==============================================================================
  tempVect <- which(grepl("^(tun|thu|thundere|thundert|thundee|severe t|whirl)", 
                          stormDF$EVTYPE))

  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Thunderstorm Wind"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- 
         c("^(tun|thu|thundere|thundee|severe t|whirl)", start, 
           stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "hail" change the type to the corresponding 
# NWS event. These changes are:
# 
# 1. ^hail    -> Hail
# ==============================================================================
  tempVect <- which(grepl("^hail", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Hail"
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^hail", start, stormDF[temp, "EVTYPE"])
    }
  }
 

# ==============================================================================
# For each event type starting with "marine" change the type to the
# corresponding NWS event. These changes are:
# 
# 1. ^marine.*(thunderstorm|tstm).* -> Marine Thunderstorm Wind
# 2. ^marine.*strong.*               -> Marine Strong Wind
# 3. ^marine.*high.*                 -> Marine High Wind
# default -> Marine Hail
# ==============================================================================
  tempVect <- which(grepl("^marine", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl(".*(thunderstorm|tstm).*", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Marine Thunderstorm Wind"
    } else if(grepl(".*strong.*", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Marine Strong Wind"
    } else if(grepl(".*high.*", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Marine High Wind"
    } else {
      stormDF[temp, "EVTYPE"] <- "Marine Hail"
    }

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- 
        c("^marine", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "coastal", "tidal", or "astro" change the 
# type to the corresponding NWS event. These changes are:
# 
# 1. ^(coastal|tidal|astro).*low.*     -> Astronomical Low Tide
# 2. ^(coastal|tidal|astro).*erosion*  -> High Surf
# default -> Marine Coastal Flood
# ==============================================================================
  tempVect <- which(grepl("^(coastal|tidal|astro)", 
                          stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("low", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Astronomical Low Tide"
    } else if(grepl("erosion", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    } else {
      stormDF[temp, "EVTYPE"] <- "Coastal Flood"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(coastal|tidal|astro)",
                                  start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "blizzard" change the 
# type to the corresponding NWS event. These changes are:
# 
# 1. ^blizzard     -> Blizzard
# ==============================================================================
  tempVect <- which(grepl("^blizzard", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("low", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Astronomical Low Tide"
    } else if(grepl("erosion", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    } else {
      stormDF[temp, "EVTYPE"] <- "Coastal Flood"
    }

    stormDF[temp, "EVTYPE"] <- "Blizzard"

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^blizzard", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "lake", "tidal", or "astro" type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^lake.*effect.*     -> Lake-Effect Snow
# default -> Lakeshore Flood
# ^lake
# ==============================================================================
  tempVect <- which(grepl("^lake", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("effect", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Lake-Effect Snow"
    } else {
      stormDF[temp, "EVTYPE"] <- "Lakeshore Flood"
    }

    # stormDF[temp, "EVTYPE"] <-
    #   gsub(".*effect.*", "Lake-Effect Snow",
    #   gsub(".*flood.*", "Lakeshore Flood",
    #        stormDF[temp, "EVTYPE"]))

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^lake", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "flash" change the 
# type to the corresponding NWS event. These changes are:
# 
# 1. ^flash     -> Flash Flood
# ==============================================================================
  tempVect <- which(grepl("^flash", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    stormDF[temp, "EVTYPE"] <- "Flash Flood"

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^flash", start, stormDF[temp, "EVTYPE"])
    }
  }


# ==============================================================================
# For each event type starting with "flood" to the corresponding NWS event. 
# These changes are:
# 
# 1. ^flood.*flash.*     -> Flash Flood
# default -> Flood
# ==============================================================================
  tempVect <- which(grepl("^flood", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("flash", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flash Flood"
    } else {
      stormDF[temp, "EVTYPE"] <- "Flood"
    }

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^flood", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "rip", "grad", or "drown" change the 
# type to the corresponding NWS event. These changes are:
# 
# 1. ^(rip|grad|drown).*     -> Rip Current
# ==============================================================================
  tempVect <- which(grepl("^(rip|grad|drown)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    stormDF[temp, "EVTYPE"] <- "Rip Current"
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^rip", start, stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type starting with "sleet" to the corresponding NWS event. 
# These changes are:
# 
# 1. ^sleet.*ice storm.*     -> Ice Stor
# default -> Sleet
# ^sleet
# ==============================================================================
  tempVect <- which(grepl("^sleet", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("ice storm", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Ice Storm"
    } else {
      stormDF[temp, "EVTYPE"] <- "Sleet"
    }

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^sleet", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "avalan" change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^avalan.*     -> Avalanche
# ==============================================================================
  tempVect <- which(grepl("^avalan", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Avalanche"
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^avalan", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "torn", "gustnado", or "landspout" change 
# the type to the corresponding NWS event. These changes are:
# 
# 1. ^(torn|gustnado|landspout).*     -> Tornado
# ==============================================================================
  tempVect <- which(grepl("^(torn|gustnado|landspout)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Tornado"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(torn|gustnado|landspout)",
                                  start, stormDF[temp, "EVTYPE"])
    }
  }
# ==============================================================================
# For each event type starting with  "tsunami", "typhoon", "hurricane", 
# "depression", or "storm" change the type to the corresponding NWS event. 
# These changes are:
# 
# 1. ^tsunami                      -> Marine Thunderstorm Wind
# 2. ^(typhoon|hurricane)          -> Hurricane/Typhoon
# 3. ^(ts|ty|hu|tro).*depression.* -> Tropical Depression
# 3. ^(ts|ty|hu|tro).*storm.*      -> Tropical Storm
# default -> Marine High Wind
# ==============================================================================
  tempVect <- which(grepl("^(ts|ty|hu|tro)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("^tsunami", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Tsunami"
    } else if(grepl("^(typhoon|hurricane)", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Hurricane/Typhoon"
    } else if(grepl("depression", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Tropical Depression"
    } else if(grepl("storm", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Tropical Storm"
    } else {
      stormDF[temp, "EVTYPE"] <- "Marine High Wind"
    }

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^(ts|ty|hu|tro)", start, stormDF[temp, "EVTYPE"])
    }
  }
# ==============================================================================
# For each event type ending with  "fir(e|es)$", change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. fir(e|es)$   -> Wildfire
# ==============================================================================
  tempVect <- which(grepl("fir(e|es)$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
  
    stormDF[temp, "EVTYPE"] <- "Wildfire"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- 
         c("fir(e|es)", start, stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type starting with "light", or "lignt" change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^light.+freezing  -> Winter Weather
# 2. ^light.+          -> Heavy Rain
# 3. ^light.+snow.*    -> Winter Weather
# default              -> Lightning
# ==============================================================================
  tempVect <- which(grepl("^(light|lignt)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("freezing", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else if(grepl("heavy rain", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    } else if(grepl("snow", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else {
      stormDF[temp, "EVTYPE"] <- "Lightning"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(light|lignt)x", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "urban", change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^urban.+flood  -> Flood
# default           -> Flash Flood
# ==============================================================================
  tempVect <- which(grepl("^urban", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    if(grepl("flood", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flood"
    } else {
      stormDF[temp, "EVTYPE"] <- "Flash Flood"
    }
    
    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("^urban", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "extreme", change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^extreme.+heat -> Excessive Heat
# default           -> Extreme Cold/Wind Chill
# ==============================================================================
  tempVect <- which(grepl("^extreme", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("heat", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Excessive Heat"
    } else {
      stormDF[temp, "EVTYPE"] <- "Extreme Cold/Wind Chill"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^extreme", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "extended", change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^extended -> Cold/Wind Chill
# ==============================================================================
  tempVect <- which(grepl("^extended", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Cold/Wind Chill"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^extended", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "excessive" change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^excessive.+heat              -> Excessive Heat
# 2. ^excessive.+rainfall|wetness  -> Heavy Rain
# default                          -> Heavy Snow
# ==============================================================================
  tempVect <- which(grepl("^excessive", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    
    if(grepl("heat", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Excessive Heat"
    } else if(grepl("rainfall|wetness", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    } else {
      stormDF[temp, "EVTYPE"] <- "Heavy Snow"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^excessive", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "rough", or "hazardous" change the type to 
# the corresponding NWS event. These changes are:
# 
# 1. ^(rough|hazardous).+surf  -> High Surf
# default                      -> Marine Strong Wind
# ==============================================================================
  tempVect <- which(grepl("^(rough|hazardous)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("surf", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    } else {
      stormDF[temp, "EVTYPE"] <- "Marine Strong Wind"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^rough", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "waterspout", change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^extended -> Waterspout
# ==============================================================================
  tempVect <- which(grepl("^waterspout", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Waterspout"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^waterspout", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "cold", or "cool" change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^(cold|cool).+tornado           -> Excessive Heat
# 2. ^(cold|cool).+rainfall|wetness  -> Winter Weather
# default                            -> Cold/Wind Chill
# ==============================================================================
  tempVect <- which(grepl("^(cold|cool)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("tornado", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Tornado"
    } else if(grepl("snow", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else {
      stormDF[temp, "EVTYPE"] <- "Cold/Wind Chill"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(cold|cool)", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "frost", or freeze", change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^(frost|freeze) -> Frost/Freeze
# ==============================================================================
  tempVect <- which(grepl("^(frost|freeze)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Frost/Freeze"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(frost|freeze)", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "gusty" change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^gusty.+hail  -> Hail
# 2. ^gusty.+rain  -> Heavy Rain
# 3. ^gusty.+snow  -> Winter Weather
# default          -> High Wind
# ==============================================================================
  tempVect <- which(grepl("^gusty", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("hail", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Hail"
    } else if(grepl("rain", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    } else if(grepl("snow", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else {
      stormDF[temp, "EVTYPE"] <- "High Wind"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^gusty", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "heat", or "warm" change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^(heat|warm).+hail  -> Drought
# default                -> Heat
# ==============================================================================
  tempVect <- which(grepl("^(heat|warm)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("drought", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Drought"
    } else {
      stormDF[temp, "EVTYPE"] <- "Heat"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(heat|warm)", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "hypo, or "freeze", change the type to the 
# corresponding NWS event. These changes are:
# 
# 1. ^(hypo|low) -> Frost/Freeze
# ==============================================================================
  tempVect <- which(grepl("^(hypo|low)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Cold/Wind Chill"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(hypo|low)", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "heavy snow" change the type to the
# corresponding NWS event. These changes are:
#
# 1. ^heavy snow.+(wind|blizzard)  -> Blizzard
# 2. ^heavy snow.+flood            -> Flood
# default                          -> Heavy Snow
# ==============================================================================
  tempVect <- which(grepl("^heavy snow", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("(wind|blizzard)", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Blizzard"
    } else if(grepl("flood", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flood"
    } else {
      stormDF[temp, "EVTYPE"] <- "Heavy Snow"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^heavy snow", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "high.+wind" change the type to the
# corresponding NWS event. These changes are:
#
# 1. ^high.+wind.+(blizzard|snow)  -> Blizzard
# 2. ^high.+wind.+seas             -> Marine High Wind
# 3. ^high.+wind.+seas             -> Heavy Rain
# 4. ^high.+wind.+rain             -> Coastal Flood
# 5. ^high.+wind.+coastal          -> Cold/Wind Chill
# default                          -> High Wind
# ==============================================================================
  tempVect <- which(grepl("^high.+wind", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("blizzard|snow", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Blizzard"
    } else if(grepl("seas", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Marine High Wind"
    } else if(grepl("rain", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    } else if(grepl("coastal", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Coastal Flood"
    } else if(grepl("cold", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Cold/Wind Chill"
    } else {
      stormDF[temp, "EVTYPE"] <- "High Wind"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^high.+wind", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "(heavy|high).+surf" change the type to the
# corresponding NWS event. These changes are:
#
# 1. ^(heavy|high).+surf.+coastal  -> Coastal Flood
# default                          -> High Surf
# ==============================================================================
  tempVect <- which(grepl("^(heavy|high).+surf", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("coastal", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Coastal Flood"
    } else {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(heavy|high).+surf", start, 
                                      stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "(heavy|hvy).+(precipitation|rain|shower)" 
# change the type to the corresponding NWS event. These changes are:
#
# 1. ^(heavy|hvy).+(precipitation|rain|shower).+flood      -> Flood
# 2. ^(heavy|hvy).+(precipitation|rain|shower).+surf       -> High Surf
# 3. ^(heavy|hvy).+(precipitation|rain|shower).+urban      -> Flash Flood
# 4. ^(heavy|hvy).+(precipitation|rain|shower).+lightning  -> Lightning
# 5. ^(heavy|hvy).+(precipitation|rain|shower).+snow       -> Winter Weather
# default                                                  -> Heavy Rain
# ==============================================================================
  tempVect <- which(grepl("^(heavy|hvy).+(precipitation|rain|shower)", 
                          stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("flood", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flood"
    } else if(grepl("surf", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    } else if(grepl("urban", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flash Flood"
    } else if(grepl("lightning", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Lightning"
    } else if(grepl("snow", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- 
         c("^(heavy|hvy).+(precipitation|rain|shower)", start, 
           stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "heavy", or "high" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^(heavy|high).+lake            -> Lake-Effect Snow
# 2. ^(heavy|high)).+(swells|seas)  -> Marine High Wind
# 3. ^(heavy|high).+tides           -> Storm Surge/Tide
# 4. ^(heavy|high).+waves           -> High Surf
# 5. ^(heavy|high).+mix             -> Winter Weather
# default                           -> Flood
# ==============================================================================
  tempVect <- which(grepl("^(heavy|high)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("lake", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Lake-Effect Snow"
    } else if(grepl("swells|seas", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Marine High Wind"
    } else if(grepl("tides", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Storm Surge/Tide"
    } else if(grepl("waves", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    } else if(grepl("mix", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else {
      stormDF[temp, "EVTYPE"] <- "Flood"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(heavy|high)", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "wind" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^wind.+wave    -> High Surf
# 3. ^wind.+hail    -> Hail
# default           -> High Wind
# ==============================================================================
  tempVect <- which(grepl("^wind", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("wave", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    } else if(grepl("hail", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Hail"
    } else {
      stormDF[temp, "EVTYPE"] <- "High Wind"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^wind", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "unseason" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^unseason.+rain    -> Heavy Rain
# 2. ^unseason.+warm    -> Heat
# default               -> Cold/Wind Chill
# ==============================================================================
  tempVect <- which(grepl("^unseason", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("rain", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    } else if(grepl("warm", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heat"
    } else {
      stormDF[temp, "EVTYPE"] <- "Cold/Wind Chill"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^unseason", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "snow" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^snow.+heavy           -> Heavy Snow
# 2. ^snow.+bitter          -> Extreme Cold/Wind Chill
# 3. ^snow.+(blowing|wind)  -> Blizzard
# default                   -> Winter Weather
# ==============================================================================
  tempVect <- which(grepl("^snow", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("heavy", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heavy Snow"
    } else if(grepl("bitter", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Extreme Cold/Wind Chill"
    } else if(grepl("blowing|wind", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Blizzard"
    } else {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^snow", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "storm" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^storm.+force    -> Strong Wind
# default             -> Storm Surge/Tide
# ==============================================================================
  tempVect <- which(grepl("^storm", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("force", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Strong Wind"
    } else {
      stormDF[temp, "EVTYPE"] <- "Storm Surge/Tide"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^storm", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "strong" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^strong  -> Strong Wind
# ==============================================================================
  tempVect <- which(grepl("^strong", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Strong Wind"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^snow", start, stormDF[temp, "EVTYPE"])
    }
  }


# ==============================================================================
# For each event type starting with "ice", or "icy" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^(heavy|high).+(floes|jam)  -> Flash Flood
# 2. ^(heavy|high)).+storm       -> Ice Storm
# 3. ^(heavy|high).+strong       -> Strong Wind
# default                        -> Winter Weather
# ==============================================================================
  tempVect <- which(grepl("^(ice|icy)", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("floes|jam", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flash Flood"
    } else if(grepl("storm", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Ice Storm"
    } else if(grepl("strong", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Strong Wind"
    } else {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^(ice|icy)", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "hype" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^hype  -> Excessive Heat
# ==============================================================================
  tempVect <- which(grepl("^hype", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "Excessive Heat"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^hype", start, stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type starting with "blowing" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^^blowing.+(floes|jam)  -> Dust Storm
# default                    -> Blizzard
# ==============================================================================
  tempVect <- which(grepl("^blowing", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("dust", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Dust Storm"
    } else {
      stormDF[temp, "EVTYPE"] <- "Blizzard"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^blowing", start, stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type starting with "freezing" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^freezing.+fog                    -> Freezing Fog
# 2. ^freezing.+(snow|drizzle|rain)    -> Winter Weather
# 3. ^freezing.+spray                  -> Cold/Wind Chill
# default                              -> Heavy Rain
# ==============================================================================
  tempVect <- which(grepl("^freezing", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("fog", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Freezing Fog"
    } else if(grepl("snow|drizzle|rain", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else if(grepl("spray", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Cold/Wind Chill"
    } else {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^freezing", start, stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type starting with "dense" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^dense.+fog                    -> Dense Fog
# default                           -> Dense Smoke
# ==============================================================================
  tempVect <- which(grepl("^dense", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("fog", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Dense Fog"
    } else {
      stormDF[temp, "EVTYPE"] <- "Dense Smoke"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^dense", start, stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type starting with "record" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^record.+cold           -> Cold/Wind Chill
# 2. ^record.+rainfall       -> Winter Weather
# 3. ^record.+snow           -> Cold/Wind Chill
# 4. ^record.+excessive      -> Excessive Heat
# default                    -> Heat
# ==============================================================================
  tempVect <- which(grepl("^record", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("cold", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Cold/Wind Chill"
    } else if(grepl("rainfall", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Heavy Rain"
    } else if(grepl("snow", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    } else if(grepl("excessive", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Excessive Heat"
    } else {
      stormDF[temp, "EVTYPE"] <- "Heat"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^record", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "non" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^non  -> High Wind
# ==============================================================================
  tempVect <- which(grepl("^non", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "High Wind"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^non", start, stormDF[temp, "EVTYPE"])
    }
  }

# # ==============================================================================
# # ^(heavy|hvy).+(rain|shower|precipitation)
# # ==============================================================================
#   tempVect <- which(grepl("^(heavy|hvy).+(rain|shower|precipitation)", stormDF$EVTYPE))
#   for (temp in tempVect) {
#     if (VALIDATE_UNIFICATION) {
#       start <- stormDF[temp, "EVTYPE"]
#     }
# 
#     stormDF[temp, "EVTYPE"] <- "Heavy Rain"
# 
#     if (VALIDATE_UNIFICATION) {
#       testDF[nrow(testDF) + 1,] <- 
#         c("(heavy|hvy).+(rain|shower|precipitation)", start, 
#           stormDF[temp, "EVTYPE"])
#     }
#   }

# ==============================================================================
# For each event type starting with "glaze" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^glaze.+storm           -> Ice Storm
# default                    -> Winter Weather
# ==============================================================================
  tempVect <- which(grepl("^glaze", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("storm", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Ice Storm"
    } else {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^glaze", start, stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type starting with "dust" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^dust.+devil   -> Dust Devil
# default           -> Dust Storm
# ==============================================================================
  tempVect <- which(grepl("^dust", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("devil", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Dust Devil"
    } else {
      stormDF[temp, "EVTYPE"] <- "Dust Storm"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^dust", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "river" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^river      -> Flood
# ==============================================================================
  tempVect <- which(grepl("^river", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Flood"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^river", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type starting with "winter" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. ^winter.+storm      -> Winter Storm
# default                -> Winter Weather
# ==============================================================================
  tempVect <- which(grepl("^winter", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("storm", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Winter Storm"
    } else {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^winter", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "funnel cloud", change the type to 
# the corresponding NWS event. These changes are:
#
# 1. ^funnel cloud$      -> Funnel Cloud
# ==============================================================================
  tempVect <- which(grepl("^funnel cloud$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Funnel Cloud"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^funnel cloud$", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "ground blizzard", change the type 
# to the corresponding NWS event. These changes are:
#
# 1. ^ground blizzard$      -> Blizzard
# ==============================================================================
  tempVect <- which(grepl("^ground blizzard$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Blizzard"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^ground blizzard$", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "black ice", change the type 
# to the corresponding NWS event. These changes are:
#
# 1. ^black ice$      -> Winter Weather
# ==============================================================================
  tempVect <- which(grepl("^black ice$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Winter Weather"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^black ice$", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "dam break", change the type 
# to the corresponding NWS event. These changes are:
#
# 1. ^dam break$      -> Flash Flood
# ==============================================================================
  tempVect <- which(grepl("^dam break$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Flash Flood"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^dam break$", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "rapidly rising water", change the 
# type to the corresponding NWS event. These changes are:
#
# 1. ^rapidly rising water$      -> Flood
# ==============================================================================
  tempVect <- which(grepl("^rapidly rising water$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Flood"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^rapidly rising water$", start, 
                                      stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "rogue wave", change the type to the
# corresponding NWS event. These changes are:
#
# 1. ^rogue wave$      -> Storm Surge/Tide
# ==============================================================================
  tempVect <- which(grepl("^rogue wave$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Storm Surge/Tide"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^rogue wave$", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "seiche", change the type to the
# corresponding NWS event. These changes are:
#
# 1. ^seiche$      -> Seiche
# ==============================================================================
  tempVect <- which(grepl("^seiche$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Seiche"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^seiche$", start, 
                                      stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "volcanic ash", change the type to 
# the corresponding NWS event. These changes are:
#
# 1. ^volcanic ash$      -> Volcanic Ash
# ==============================================================================
  tempVect <- which(grepl("^volcanic ash$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Volcanic Ash"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^volcanic ash$", start, 
                                      stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the exact string "small hail", change the type to the
# corresponding NWS event. These changes are:
#
# 1. ^small hail$      -> Hail
# ==============================================================================
  tempVect <- which(grepl("^small hail$", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Hail"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("^small hail$", start, 
                                      stormDF[temp, "EVTYPE"])
    }
  }
  
# ==============================================================================
# For each event type with the string "burst", change the type to the
# corresponding NWS event. These changes are:
#
# 1. burst      -> Thunderstorm Wind
# ==============================================================================
  tempVect <- which(grepl("burst", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Thunderstorm Wind"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("burst", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "fog" change the type to the corresponding 
# NWS event. These changes are:
#
# 1. ^fog.+cold      -> Freezing Fog
# default            -> Dense Fog
# ==============================================================================
  tempVect <- which(grepl("fog", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("cold", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Freezing Fog"
    } else {
      stormDF[temp, "EVTYPE"] <- "Dense Fog"
    }
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("fog", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "slide", or "slump", change the type to 
# the corresponding NWS event. These changes are:
#
# 1. slide|slump      -> Debris Flow
# ==============================================================================
  tempVect <- which(grepl("slide|slump", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    stormDF[temp, "EVTYPE"] <- "Debris Flow"

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("slide|slump", 
                                     start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "drought", change the type to the
# corresponding NWS event. These changes are:
#
# 1. drought      -> Drought
# ==============================================================================
  tempVect <- which(grepl("drought", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    stormDF[temp, "EVTYPE"] <- "Drought"

    if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("drought", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "surf" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. surf.+coastal   -> Coastal Flood
# default            -> High Surf
# ==============================================================================
  tempVect <- which(grepl("surf", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    if(grepl("coastal", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Coastal Flood"
    } else {
      stormDF[temp, "EVTYPE"] <- "High Surf"
    }
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("surf", start, stormDF[temp, "EVTYPE"])
    }
  }


# ==============================================================================
# For each event type with the string "mix", change the type to the
# corresponding NWS event. These changes are:
#
# 1. mix      -> Winter Weather
# ==============================================================================
tempVect <- which(grepl("mix", stormDF$EVTYPE))
 for (temp in tempVect) {
   if (VALIDATE_UNIFICATION) {
     start <- stormDF[temp, "EVTYPE"]
   }
   stormDF[temp, "EVTYPE"] <- "Winter Weather"

   if (VALIDATE_UNIFICATION) {
      testDF[nrow(testDF) + 1,] <- c("mix", start, stormDF[temp, "EVTYPE"])
   }
 }

# ==============================================================================
# For each event type with the string "snow" change the type to the 
# corresponding NWS event. These changes are:
#
# 1. snow.+(blowing|wind|blizzard)   -> Blizzard
# 2. snow.+bitter                    -> Extreme Cold/Wind Chill
# default                            -> Winter Weather
# ==============================================================================
  tempVect <- which(grepl("snow", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("blowing|wind|blizzard", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Blizzard"
    } else if(grepl("bitter", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Extreme Cold/Wind Chill"
    } else {
      stormDF[temp, "EVTYPE"] <- "Winter Weather"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("snow", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "fog" change the type to the corresponding 
# NWS event. These changes are:
#
# 1. fog.+(ice|freezing|cold)   -> Blizzard
# default                       -> Dense Fog
# ==============================================================================
  tempVect <- which(grepl("fog", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    

    if(grepl("ice|freezing|cold", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Freezing Fog"
    } else {
      stormDF[temp, "EVTYPE"] <- "Dense Fog"
    }
    # stormDF[temp, "EVTYPE"] <-
    #   gsub(".*(ice|freezing|cold).*", "Freezing Fog",
    #   gsub("^(dense.*|fog)$", "Dense Fog",
    #        stormDF[temp, "EVTYPE"]))
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("fog", start, stormDF[temp, "EVTYPE"])
    }
 }


# ==============================================================================
# For each event type with the string "gusty" change the type to the corresponding 
# NWS event. These changes are:
#
# 1. gusty   -> High Wind
# ==============================================================================
  tempVect <- which(grepl("gusty", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "High Wind"
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("gusty", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "erosion" change the type to the corresponding 
# NWS event. These changes are:
#
# 1. erosion   -> High Surf
# ==============================================================================
  tempVect <- which(grepl("erosion", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }
    
    stormDF[temp, "EVTYPE"] <- "High Surf"
    
    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("erosion", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "freeze", or "frost" change the type to 
# the corresponding NWS event. These changes are:
#
# 1. freeze|frost   -> Frost/Freeze
# ==============================================================================
  tempVect <- which(grepl("freeze|frost", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Frost/Freeze"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("freeze|frost", start, 
                                      stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "flood" change the type to the corresponding 
# NWS event. These changes are:
#
# 1. flood.+(blowing|wind|blizzard)  -> Flash Flood
# default                            -> Flood
# flood
# ==============================================================================
  tempVect <- which(grepl("flood", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    if(grepl("small", stormDF[temp, "EVTYPE"])) {
      stormDF[temp, "EVTYPE"] <- "Flash Flood"
    } else {
      stormDF[temp, "EVTYPE"] <- "Flood"
    }

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("flood", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# For each event type with the string "rain" change the type to the corresponding 
# NWS event. These changes are:
#
# 1. rain   -> Heavy Rain
# ==============================================================================
  tempVect <- which(grepl("rain", stormDF$EVTYPE))
  for (temp in tempVect) {
    if (VALIDATE_UNIFICATION) {
      start <- stormDF[temp, "EVTYPE"]
    }

    stormDF[temp, "EVTYPE"] <- "Heavy Rain"

    if (VALIDATE_UNIFICATION) {
       testDF[nrow(testDF) + 1,] <- c("rain", start, stormDF[temp, "EVTYPE"])
    }
  }

# ==============================================================================
# ==============================================================================
  if (VALIDATE_UNIFICATION) {
    write.csv(testDF, "unify.csv")
  }

  return (stormDF)
}

```

### Download File

```{r processing, class.source="code"}
## This is a "just in case block." It will retrieve the storm data file if 
## necessary.

  if (!file.exists(STORM_DATA_FILE)) {
    retrieve = download.file(URL, STORM_DATA_FILE, mode = "wb")

    if (is.null(retrieve)) {
      print("ERROR: could not access ", url)
      stop()
    }
  }

```

<hr style="background : black; height : 15px"/>

### Baseline Data Frame

**Goal**

The goal for this function is to provide a baseline to analyze the impact of each transformation on the data frame. Since this code is useful as a baseline only, the people analyzing the data must have the option to turn it on or off.

**Why?**

The Baseline Data Frame is used to get the worst case data frame state as a baseline to compare other state change. One the goals for the project is to explain the purpose specific transformation used to convert the data in the **storm data file** to the answers required in the project description. An additional goal is to provide a "description and justification for any data transformations", so it is necessary to understand how the impact the data frame. This block gives a description of data before any transformations are made.

**How?**

The Baseline Data Frame is used only to get the worst case memory state, so the code is embedded in an if statement to so the entire computation is enclosed by an if statement. The if condition is true when both *CORRECTNESS* and *ALL_DATA* constants are TRUE. When the code executes, it reads the entire storm data file into a data frame and prints out the state data. Since the only point of this code block is to print the state of the data frame, it terminates once the statement is done.

#### Code

```{r baseline, class.source="comment"}
### Baseline Code ##############################################################
###  stormDF stores the contents of the STORM_DATA_FILE to measure its state.
###  The state of a data frame for the purposes of this analysis the state 
###  consists of :
### 
###  1. The size of the data frame
###  2. The dimensions of the data frame
###  3. The number of unique event types--the STORM_DATA_FILE has more event 
###     types then those allowed by the NWS Instruction.
### 
### This code block loads the tables required to run the complete code.
################################################################################
```

```{r class.source="comment"}
### TEST CODE ##################################################################
```

```{r class.source="test"}
if (CORRECTNESS & ALL_DATA) {
  baselineDF <- read.table(STORM_DATA_FILE, sep = ",", header = TRUE)
}
```

```{r class.source="comment"}
### BASELINE DF STATE ##########################################################
```

```{r class.source="state"}
if (CORRECTNESS & ALL_DATA) {
  print("BASELINE Data Frame State")
  print(paste0("The data frame memory requirement is ", object.size(baselineDF)))
  print(paste0("The data frame dimensions are        ", dim(baselineDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(baselineDF$EVTYPE))))
  print(head(baselineDF, n = 10))

  knitr::knit_exit()
}
```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div class="output">

<caption style="output"><strong>Output Listing 0</strong> The baselineDF datablock output is a print out of the memory required to store the data frame, the dimensions of the data frame, and the number of unique event types.</caption>

<pre class="pre">
## [1] "BASELINE Data Frame State"
## [1] "The data frame memory requirement is 494295216"
## [1] "The data frame dimensions are        902297"
## [2] "The data frame dimensions are        37"    
## [1] "Number of unique event names         985"

##    STATE__           BGN_DATE BGN_TIME TIME_ZONE COUNTY COUNTYNAME STATE
## 1        1  4/18/1950 0:00:00     0130       CST     97     MOBILE    AL
## 2        1  4/18/1950 0:00:00     0145       CST      3    BALDWIN    AL
## 3        1  2/20/1951 0:00:00     1600       CST     57    FAYETTE    AL
## 4        1   6/8/1951 0:00:00     0900       CST     89    MADISON    AL
## 5        1 11/15/1951 0:00:00     1500       CST     43    CULLMAN    AL
## 6        1 11/15/1951 0:00:00     2000       CST     77 LAUDERDALE    AL
## 7        1 11/16/1951 0:00:00     0100       CST      9     BLOUNT    AL
## 8        1  1/22/1952 0:00:00     0900       CST    123 TALLAPOOSA    AL
## 9        1  2/13/1952 0:00:00     2000       CST    125 TUSCALOOSA    AL
## 10       1  2/13/1952 0:00:00     2000       CST     57    FAYETTE    AL
## .        .       .       .          .         .      .        .        .
## .        .       .       .          .         .      .        .        .
## .        .       .       .          .         .      .        .        .
##     EVTYPE BGN_RANGE BGN_AZI BGN_LOCATI END_DATE END_TIME COUNTY_END COUNTYENDN
## 1  TORNADO         0     .       .          .        .             0         NA
## 2  TORNADO         0     .       .          .        .             0         NA
## 3  TORNADO         0     .       .          .        .             0         NA
## 4  TORNADO         0     .       .          .        .             0         NA
## 5  TORNADO         0     .       .          .        .             0         NA
## 6  TORNADO         0     .       .          .        .             0         NA
## 7  TORNADO         0     .       .          .        .             0         NA
## 8  TORNADO         0     .       .          .        .             0         NA
## 9  TORNADO         0     .       .          .        .             0         NA
## 10 TORNADO         0     .       .          .        .             0         NA
## .     .            .     .       .          .        .             .         .
## .     .            .     .       .          .        .             .         .
## .     .            .     .       .          .        .             .         .
##    END_RANGE END_AZI END_LOCATI LENGTH WIDTH F MAG FATALITIES INJURIES PROPDMG
## 1          0    .       .         14.0   100 3   0          0       15    25.0
## 2          0    .       .          2.0   150 2   0          0        0     2.5
## 3          0    .       .          0.1   123 2   0          0        2    25.0
## 4          0    .       .          0.0   100 2   0          0        2     2.5
## 5          0    .       .          0.0   150 2   0          0        2     2.5
## 6          0    .       .          1.5   177 2   0          0        6     2.5
## 7          0    .       .          1.5    33 2   0          0        1     2.5
## 8          0    .       .          0.0    33 1   0          0        0     2.5
## 9          0    .       .          3.3   100 3   0          1       14    25.0
## 10         0    .       .          2.3   100 3   0          0        0    25.0
## .          .    .       .          .         .      .        .        .     .
## .          .    .       .          .         .      .        .        .     .
## .          .    .       .          .         .      .        .        .     .
##    PROPDMGEXP CROPDMG CROPDMGEXP WFO STATEOFFIC ZONENAMES LATITUDE LONGITUDE
## 1           K       0      .            .         .           3040      8812
## 2           K       0      .            .         .           3042      8755
## 3           K       0      .            .         .           3340      8742
## 4           K       0      .            .         .           3458      8626
## 5           K       0      .            .         .           3412      8642
## 6           K       0      .            .         .           3450      8748
## 7           K       0      .            .         .           3405      8631
## 8           K       0      .            .         .           3255      8558
## 9           K       0      .            .         .           3334      8740
## 10          K       0      .            .         .           3336      8738
## .           .       .      .            .         .             .         .
## .           .       .      .            .         .             .         .
## .           .       .      .            .         .             .         .
##    LATITUDE_E LONGITUDE_ REMARKS REFNUM
## 1        3051       8806              1
## 2           0          0              2
## 3           0          0              3
## 4           0          0              4
## 5           0          0              5
## 6           0          0              6
## 7           0          0              7
## 8           0          0              8
## 9        3336       8738              9
## 10       3337       8737             10
## .          .          .               .
## .          .          .               .
## .          .          .               .
</pre>
</div>
<br/>
```

<hr style="background : black; height : 2px"/>

#### Initial State

```{=html}
<div class="stateResult">

<ul>
<li>Reading the complete file requires roughly 500 MB to store the data frame.</li>
<li>The data frame has dimensions 902297 rows by 37 columns.</li>
<li>There were 985 distinct event types at this point.</li>
</ul>

NOTE: the NWS Instructions identify 48 specific event types, the 985 distinct event types in the **storm data file** are almost a factor of 20 more than it should be.
</div>
```

<hr style="background : black; height : 15px"/>

## Data Transformations

### Reading Data File

**Goal**

The goal of the **Reading Data File** transformation is to read the required data required for the analysis from the file.

**Why?**

The source file contains more data than what is needed for this project. By selecting the only the required columns, the *stormDF* will have all of the data it requires and nothing more.

The required columns are *EVTYPE*, *BGN_DATE*, *FATALITIES*, *INJURIES*, *PROPDMG*, *PROPDMGEXP*, *CROPDMG*, and *CROPDMGEXP*.

The *BGN_DATE* is required to filter out dates before 1/1/1996 to ensure the data used for the analysis contains all of the necessary rows.

**How?**

The Reading Data File transformation reads the storm data file selecting the required columns using the colClasses argument and storing it in *stormDF*. It will then filter the *stormDF* by date. The last step is to drop *BGN_DATE* because it is no longer needed.

#### Code

```{r class.source="comment"}
### Reading Data File ##########################################################
### The Reading Data File transformation reads specific columns from the data
### file by selecting the EVTYPE, BGN_DATE, FATALITIES, INJURIES, PROPDMG,
### PROPDMGEXP, CROPDMG, and CROPDMGEXP using the colClasses argument in the
### read.table function.
################################################################################
```

```{r transformation1,  class.source="code"}
stormDF <- read.table(
  STORM_DATA_FILE, stringsAsFactors = FALSE, sep = ",", colClasses =
    c("NULL", NA, rep("NULL",5), NA, rep("NULL",14),
      rep(NA, 6), rep("NULL",9)), header = TRUE)

# convert the date string to an EPOCH time
stormDF$DAY <- as.numeric(as.POSIXct(
  as.Date(stormDF$BGN_DATE, format = "%m/%d/%Y %H:%M:%S")))

# drop lines less than EPOCH times greater than 694224000 (1/1/1996)
stormDF <- stormDF[stormDF$DAY > 694224000,] %>%
  select(EVTYPE, FATALITIES, INJURIES, FATALITIES,
         PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)
```

```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```

```{r class.source="state"}
if (CORRECTNESS) {
  print("Reading Data File State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ",
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}
```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div class="output">

<caption style="output"><strong>Output Listing 1:</strong> The Reading Data File block output shows the data frame contains the correct data set.</caption>

<pre class="pre">
## [1] "Reading Data File State"
## [1] "The data frame memory requirement is 43769664"
## [1] "The data frame dimensions are        728272"
## [2] "The data frame dimensions are        7"     
## [1] "Number of unique event names         985"
##         EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5097 TSTM WIND          0        0       0          .       0          .
## 5098 TSTM WIND          0        0       0          .       0          .
## 5099 TSTM WIND          0        0       0          .       0          .
## 5100 TSTM WIND          0        0       0          .       0          .
## 5101 TSTM WIND          0        0       0          .       0          .
## 5102 TSTM WIND          0        0       0          .       0          .
## 5103 TSTM WIND          0        0       0          .       0          .
## 5104 TSTM WIND          0        0       0          .       0          .
## 5105 TSTM WIND          0        0       0          .       0          .
## 5106 TSTM WIND          0        0       0          .       0          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
</pre>
</div>
```

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 1. Data Frame State Changes Due to the Reading Data File Transformation.</strong></caption>

<table>
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;"> 494,295,216</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">  43,769,664</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-450,525,552</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">  902297</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">  728272</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;"> -174025</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">37</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-30</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">985</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">985</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; border: 1px solid black;">0</td>
</tr>
</table>

<br/>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 450 MB.</li>
<li>The number of rows was reduced by 174,025.</li>
<li>The number of columns  was reduced by 30.</li>
<li>The the number of event types was unchanges.</li>
</ul>

</div>
```

<hr style="background : black; height : 15px"/>

### Remove NC Rows

**Goal**

The goal of **Remove NC Rows** transformation is to remove non-contributing (NC) rows. The values in these rows do not contribute to the analysis.

**Why?**

The data frame will, at some point be grouped event type subsets. These subsets will need the sum of the *FATALITIES*, *INJURIES*, *PROPDMG*, and *CROPDMG*. However, for some data points these values are all zero, in which case, they do not contribute to the sums. The non-contributing data points have no use for the analysis, so they are dropped.

**How?**

The data is copied from *stormDF* to *stormDF* excluding the non-contributing points.

NOTE: a side effect of this transformaion is several irrelevant data points are dropped from the data frame.

#### Code

```{r class.source="comment"}
### Remove NC Rows #############################################################
### The Remove NC Rows transformation copies all events where at least one of 
### FATALITIES, INJURIES, PROPDMG, or CROPDMG has a non-zero value. Later in the 
### analysis, the subsets of each valid entry will be summed. If all of these 
### parameters have zero values, they will not contribute to the sum. In other 
### words, they are just wasting time and resources, so the code gets rid of 
### them.
################################################################################

```

```{r class.source="comment"}
### TEST CODE ##################################################################
### To ensure Remove NC Rows is correct, the code includes two sets of tests.
### The first showing the data frame state before executing the transformation,
### and the second executed after.
###
### An exhaustive testing of this would be time consuming and confusing, so
### three event types were selected to demonstrate the correctness of the
### transformation. The types are:
###
### 1. "HAIL" - this type is one of the NWS Instruction storm types. There are
###            instances of contributing and non-contributing "Hail" events.
###            Counting the instances of both contributing and non-contributing
###            events will before and after the transformation should show all
###            of the non-contributing events are gone and all of the
###            contributing events remain.
###
### 2. "?"    - this type is not one of the NWS Instruction storm types, however
###            there instances of contributing instances, but no instances of
###            non-contributing instances. The values before and after the
###            execution of the transformation should not change.
###
### 3. "Summary: Nov. 16"
###          - this type is not one of the NWS Instruction storm types, however
###            there several instances of this type in the storm data file, all
###            of which are non-contributing. The values before will show the
###            number of instances of the type, and after there should be no
###            instances of the type.
################################################################################
```

```{r class.source="test"}
if (CORRECTNESS) {
  print("START TEST: before Remove NC Rows")

  # 'HAIL' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'HAIL',])
  contributingRows <-
    nrow(stormDF[stormDF$EVTYPE == 'HAIL' & stormDF$FATALITIES == 0 &
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 &
               stormDF$CROPDMG == 0 ,])

  print(paste0("total \'HAIL\' events before ", totalRows))
  print(paste0("non-contributing \'HAIL\' events before ", contributingRows))
  print(paste0("contributing \'HAIL\' events before ",
               totalRows - contributingRows))

  # '?' events --------------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == '?',])

  contributingRows <-
    nrow(stormDF[stormDF$EVTYPE == '?' & stormDF$FATALITIES == 0 &
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 &
               stormDF$CROPDMG == 0 ,])

  print(paste0("total \'?\' events before ", totalRows))
  print(paste0("non-contributing \'?\' events before ", contributingRows))
  print(paste0("contributing \'?\' events before ",
               totalRows - contributingRows))

  # 'Summary: Nov. 16' events -----------------------

  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16',])

  contributingRows <-
    nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16' &
                    stormDF$FATALITIES == 0 & stormDF$INJURIES == 0 &
                    stormDF$PROPDMG == 0 & stormDF$CROPDMG == 0 ,])

  print(paste0("total \'Summary: Nov. 16\' events before ", totalRows))
  print(paste0("non-contributing \'Summary: Nov. 16\' events before ",
               contributingRows))
  print(paste0("contributing \'Summary: Nov. 16\' events before ",
               totalRows - contributingRows))
  print("END TEST: before Remove NC Rows")
}

```

```{r class.source="comment"}
### TRANSFORMATION CODE ########################################################
```

```{r transformation2,  class.source="code"}
stormDF <- stormDF[stormDF$FATALITIES != 0 | stormDF$INJURIES != 0 |
                     stormDF$PROPDMG != 0 | stormDF$CROPDMG != 0, ]
```

```{r class.source="comment"}
### TEST CODE ##################################################################
### The final code test repeats the earlier checks for the three event types.
################################################################################
```

```{r class.source="test"}
if (CORRECTNESS) {
  print("START TEST: after Remove NC Rows")

  # 'HAIL' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'HAIL',])

  contributingRows <-
    nrow(stormDF[stormDF$EVTYPE == 'HAIL' & stormDF$FATALITIES == 0 &
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 &
               stormDF$CROPDMG == 0 ,])

  print(paste0("total \'HAIL\' events after ", totalRows))
  print(paste0("non-contributing \'HAIL\' events after ", contributingRows))
  print(paste0("contributing \'HAIL\' events after ",
               totalRows - contributingRows))

  # '?' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == '?',])

  contributingRows <-
    nrow(stormDF[stormDF$EVTYPE == '?' & stormDF$FATALITIES == 0 &
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 &
               stormDF$CROPDMG == 0 ,])

  print(paste0("total \'?\' events after ", totalRows))
  print(paste0("non-contributing \'?\' events after ", contributingRows))
  print(paste0("contributing \'?\' events after ",
               totalRows - contributingRows))

  # 'Summary: Nov. 16' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16',])

  contributingRows <-
    nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16' &
                    stormDF$FATALITIES == 0 & stormDF$INJURIES == 0 &
                    stormDF$PROPDMG == 0 & stormDF$CROPDMG == 0 ,])

  print(paste0("total \'Summary: Nov. 16\' events after ", totalRows))
  print(paste0("non-contributing \'Summary: Nov. 16\' events after ",
               contributingRows))
  print(paste0("contributing \'Summary: Nov. 16\' events after ",
               totalRows - contributingRows))
  print("END TEST: after Remove NC Rows ")
}
```

```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```

```{r class.source="state"}
if (CORRECTNESS) {
  print("Remove NC Rows State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ",
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 2a:</strong>
Before the execution of the Remove NC Rows transformation, the <em>stormDF</em> contains several non-contributing values. To demonstrate the transformation eliminated these values the test code focuses on three type names: 'HAIL', '?', and 'Summary: Nov. 16'. This first test show the number of contributing and non-contributing value for these. types.</caption>

<pre class="pre">
## [1] "START TEST: before Remove NC Rows"
## [1] "total 'HAIL' events before 232516"
## [1] "non-contributing 'HAIL' events before 206446"
## [1] "contributing 'HAIL' events before 26070"
## [1] "total '?' events before 1"
## [1] "non-contributing '?' events before 0"
## [1] "contributing '?' events before 1"
## [1] "total 'Summary: Nov. 16' events before 2"
## [1] "non-contributing 'Summary: Nov. 16' events before 2"
## [1] "contributing 'Summary: Nov. 16' events before 0"
## [1] "END TEST: before Remove NC Rows"</pre>
</div>
```

<br/>

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 2b:</strong>After the execution of the Remove NC Rows transformation, the output shows the what has happened to the data frame.</caption>

<pre class="pre">
## [1] "START TEST: after Remove NC Rows"
## [1] "total 'HAIL' events after 26070"
## [1] "non-contributing 'HAIL' events after 0"
## [1] "contributing 'HAIL' events after 26070"
## [1] "total '?' events after 1"
## [1] "non-contributing '?' events after 0"
## [1] "contributing '?' events after 1"
## [1] "total 'Summary: Nov. 16' events after 0"
## [1] "non-contributing 'Summary: Nov. 16' events after 0"
## [1] "contributing 'Summary: Nov. 16' events after 0"
## [1] "END TEST: after Remove NC Rows "</pre>
</div>
```

<br/>

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 2c:</strong> The state of the data frame after executing the Remove NC Rows Transformation.</caption>

<pre class="pre">
## [1] "Remove NC Rows State"
## [1] "The data frame memory requirement is 13731856"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        7"
## [1] "Number of unique event names         488"
##         EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5107   TORNADO          0        1     2.5          M       0          .
## 5108 TSTM WIND          1        1     0.0          .       0          .
## 5129   TORNADO          0        0   250.0          K       0          .
## 5130   TORNADO          2        7   250.0          K       0          .
## 5135 TSTM WIND          0        7     0.0          .       0          .
## 5163   TORNADO          0        0    25.0          K       0          .
## 5246 TSTM WIND          0        1     0.0          .       0          .
## 5252 TSTM WIND          1        1     0.0          .       0          .
## 5312   TORNADO          0        0    25.0          K       0          .
## 5315   TORNADO          0        2   250.0          K       0          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
</pre>
</div>
```

<hr style="background : black; height : 2px"/>

#### Test result

```{=html}
<div class="testResults">

<caption><strong>Table 2.</strong> The changes caused by Remove NC Rows Transformation shows the non-contributing data points have been dropped from the data frame and all contributing data points are maintained, regardless of their type names.</caption>

<!-- TABLE SET UP -->
<table style="testTable">
<tr>
<th style="width : 25%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px;">Type</th>
<th style="width : 20%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px;">Contributor</th>
<th style="width : 15%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px;">Before T2</th>
<th style="width : 15%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px;">After T2</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;" rowspan=2>Hail</td>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;">non-contributing</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">206446</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;">contributing</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 1px;">26070</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 1px;">26070</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;" rowspan=2>?</td>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;">non-contributing</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;">contributing</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 1px;">1</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;" rowspan=2>Summary: Nov. 16</td>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;">non-contributing</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 1px;">contributing</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 1px;">0</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 1px;">0</td>
</tr>
</table>

<br/>

<p>The 'HAIL' event type had over 200,000 non-contributing rows before the transformation and none afterwards. This means all of the non-contributing 'HAIL' rows are gone. On the other hand, there were 26070 contributing rows of 'HAIL' before and after the transformation. This suggests the transformation dropped all non-contributing rows while keeping all of the contributing rows. This is the desired effect.</p>

<p>The '?' event type had no non-contributing rows before and after the transformation, and the contributing rows had one row before and afterwards. Even though '?' is not a valid NWS event type name, the transformation did not eliminate it because the number of contributing rows did not change.</p>

<p>The 'Summary: Nov. 16' event type had two contributing rows before and none after the transformation. This means the rows were dropped and since there were no contributing rows before or after the transformation, all rows involving this event type are dropped from the data frame. As a result, the 'Summary: Nov. 16' there are no occurances of this event type in stormDF.</p>
<br/>
</div>
```

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 3.</strong> Data Frame State Changes Due to the Remove NC Rows Transformation.</caption>

<table>
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">43,769,664</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">13,731,856</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">-30,037,808</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">  728272</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px; padding: 1px;">  228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;"> -500025</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">985</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">488</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-497</td>
</tr>
</table>

<br/>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 30 MB.</li>
<li>The number of rows was reduced by 500,025 row.</li>
<li>The number of columns is unchanged.</li>
<li>The reduction in the number of event types is 497.</li>
</ul>

The loss of over 500,000 rows suggests the *stormDF* was dominated by events with no notable damage to live or to the economy. The loss of 497 event types is a positive step forward given the number of events should be 48 but it also implies there are several more invalid event types in the data frame.

</div>

```


<hr style="background : black; height : 15px"/>

### Clean Strings

**Goal**

The goal of **Clean Strings** transformation is to change the string names to simplify comparisons that will have to be done to convert the data collectors names to NWS names.

**Why?**

This transformation is necessary for two reasons.

1.  whitespace at the beginning and ending of a string are included in string comparisons. The type names "*DUST*" and " *DUST*" are two different strings because of the extra space in front of the second string.
2.  the data collectors did not use consistent spelling or capitalization. Type names like *Black Ice* match the NWS naming convention, but *BLACK ICE* does not.

**How?**

Each column of the *stormDF* with strings (*EVTYPE*, *PROPDMGEXP*, and *CROPDMGEXP*) are "trimmed" by removing whitespace in the beginning and ending of the string. After trimming the whitespace, all of these strings are then converted all to lower case letters.

#### Code

```{r class.source="comment"}
### TRANSFORMATION CODE ########################################################
### The Clean Strings transformation will trim the leading and trailing white 
### spaces from every string in stormDF$EVTYPE, stormDF$PROPDMGEXP, and 
### source$CROPDMGEXP. It will then change all those strings to lower case.
################################################################################
```

```{r class.source="comment"}
### TEST CODE ##################################################################
# To ensure the Clean Strings transformation is correct, the test code includes two sets of
# instructions. The first set counts instances of ' FLASH FLOOD' and 'FLASH
# FLOOD'. The string ' FLASH FLOOD' is both upper case and includes a leading
# space. The string 'FLASH FLOOD' is also in upper case but it has no leading
# or trailing edge whitespaces. In both cases, the transformation will change
# the strings to 'flash flood'.
################################################################################
```

```{r class.source="test"}
if (CORRECTNESS) {
  print("START TEST: before Clean Strings")

  test <- stormDF[stormDF$EVTYPE == ' FLASH FLOOD' ,]
  print(paste0("number of total \' FLASH FLOOD\' events before ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'FLASH FLOOD' ,]
  print(paste0("number of total \'FLASH FLOOD\' events before ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == ' flash flood' ,]
  print(paste0("number of total \' flash flood\' events before ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'flash flood' ,]
  print(paste0("number of total \'flash flood\' events before ", nrow(test)))

  print("END TEST: before Clean Strings")
}

```

```{r class.source="comment"}
### TRANSFORMATION CODE ########################################################
```

```{r transformation3,  class.source="code"}
stormDF$EVTYPE     <- trimws(stormDF$EVTYPE, which = c("both"))
stormDF$PROPDMGEXP <- trimws(stormDF$PROPDMGEXP, which = c("both"))
stormDF$CROPDMGEXP <- trimws(stormDF$CROPDMGEXP, which = c("both"))
stormDF$EVTYPE     <- tolower(stormDF$EVTYPE)
stormDF$PROPDMGEXP <- tolower(stormDF$PROPDMGEXP)
stormDF$CROPDMGEXP <- tolower(stormDF$CROPDMGEXP)
```

```{r class.source="comment"}
### TEST CODE ##################################################################
### This test will check for four variations of 'FLASH FLOOD'. Specifically, it
### will check for the existence of
### 1. ' FLASH FLOOD' one of the original strings
### 2. 'FLASH FLOOD' the other original strings and the expected value if the
###     to lower function failed.
### 3. ' flash flood' the expected value if the trim function failed
### 4. ' flash flood' the expected value if if every thing works
################################################################################
```

```{r class.source="test"}
if (CORRECTNESS) {
  print("START TEST: after Clean Strings")

  test <- stormDF[stormDF$EVTYPE == ' FLASH FLOOD' ,]
  print(paste0("number of total \' FLASH FLOOD\' events after ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'FLASH FLOOD' ,]
  print(paste0("number of total \'FLASH FLOOD\' events after ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == ' flash flood' ,]
  print(paste0("number of total \' flash flood\' events after ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'flash flood' ,]
  print(paste0("number of total \'flash flood\' events after ", nrow(test)))

  print("END TEST: after Clean Strings")
}
```

```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```

```{r class.source="state"}
if (CORRECTNESS) {
  print("Clean Strings State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ",
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 3a:</strong> Before the execution of Clean Strings transformation, the code executes an searches for the string " FLASH FLOOD" in the <em>stormDF$EVTYPE</em> column. The output shows the string was found. The string is not a valid name because of the leading space. The correct name is "FLASH FLOOD".</caption>

<pre class="pre">
## [1] "START TEST: before Clean Strings"
## [1] "number of total ' FLASH FLOOD' events before 1"
## [1] "number of total 'FLASH FLOOD' events before 20967"
## [1] "number of total ' flash flood' events before 0"
## [1] "number of total 'flash flood' events before 0"
## [1] "END TEST: before Clean Strings"
</pre>

</div>
```

<br/>

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 3b:</strong> After the execution of Clean Strings transformation, the listing shows the <em>EVTYPE</em>, <em>PROPDMGEXP</em>, and <em>CROPDMGEXP</em> have been converted to strings with all lower case letters.</caption>

<pre class="pre">
## [1] "START TEST: after Clean Strings"
## [1] "number of total ' FLASH FLOOD' events before 0"
## [1] "number of total 'FLASH FLOOD' events before 0"
## [1] "number of total ' flash flood' events before 0"
## [1] "number of total 'flash flood' events before 20968"
## [1] "END TEST: before Clean Strings"
</pre>
</div>

```

<br/>

```{=html}
<div class="output">

<caption style="output"><strong>Output Listing 3c:</strong> Data Frame State Changes Due to the Clean Strings Transformation.</caption>

<pre class="pre">
## [1] "Clean Strings State"
## [1] "The data frame memory requirement is 13728752"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        7"
## [1] "Number of unique event names         444"
##         EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5107   tornado          0        1     2.5          m       0          .
## 5108 tstm wind          1        1     0.0                  0          .
## 5129   tornado          0        0   250.0          k       0          .
## 5130   tornado          2        7   250.0          k       0          .
## 5135 tstm wind          0        7     0.0                  0          .
## 5163   tornado          0        0    25.0          k       0          .
## 5246 tstm wind          0        1     0.0                  0          .
## 5252 tstm wind          1        1     0.0                  0          .
## 5312   tornado          0        0    25.0          k       0          .
## 5315   tornado          0        2   250.0          k       0          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
</pre>
</div>

```

<hr style="background : black; height : 2px"/>

#### Test result

```{=html}
<div class="testResults">

<caption><strong>Table 4.</strong> The results show both the "flash flood" and " flash flood" types were changed to "Flash Flood".</caption>

<table style="testResults">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Type Name</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count Before</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count After</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">' FLASH FLOOD'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'FLASH FLOOD'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">20967</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">' flash flood'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'flash flood'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">20968</td>
</tr>
</table>

<br/>

<p>The transform is expected to convert all the variations of "FLASH FLOOD" to "flash flood" including whitespace in front of or behind the string.</p>

<p>Before the transformation, there were 20967 instances of "FLASH FLOOD", 1 instance of " FLASH FLOOD", and no instances of "flash flood", or " flash flood".</p>

<p>After the transformation all of the variations were converted to "flash flood" as expected.</p>

</div>

```


<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 5.</strong> Data Frame State Changes Due to the Clean Strings Transformation.</caption>

<table class="stateTable">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">13,731,856</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-3104</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">488</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">444</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-44</td>
</tr>
</table>

<br/>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 3 kB.</li>
<li>The number of rows is unchanged.</li>
<li>The number of columns is unchanged.</li>
<li>The reduction in the number of event types is 44.</li>
</ul>

The changes to the data frame are insignificant, however the reduction in the number of event type names is expected. However, the number of event types dropped by 44 which suggests there were several strings with spaces at the front or the back and several names with incorrect letter cases.

The number of event type names is well over 444, so there must be more issues with type names.

</div>
```

<hr style="background : black; height : 15px"/>

### Fix Invalid Names

**Goal**

The goal of **Fix Invalid Names** transformation is to ensure any of the remaining events, with no apparent relationship to the NWS event types, are accounted for.

**Why?**

Some of the data collector type names have no apparent relationship to the NWS names. For example, the names, **?**, **apache county**, and **high** do not approximate the any name in the NWS type naming convention. If they were removed from the data frame, subsequent calculations would lose the impact of these data points. So the Fix Invalid Names Transformation has to account remove these event and still account for them.

**How?**

The transformation uses "gsub" functions to compare each *EVTYPE* name in *stormDF* to the invalid type names. If a type name matches an invalid names, the event type is replaced with the word **Other**.

NOTE: 'Other' is not a valid name, but it is used to account for the values of invalid names.

#### Code


```{r class.source="comment"}
### TRANSFORMATION CODE ########################################################
### Transformation code will change every EVTYPE matching an invalid type to
### 'Other'.
################################################################################
```

```{r class.source="test"}
### TEST CODE ##################################################################
### The initial test for the transformation prints the number of rows containing
### each invalid event type including "Other".
################################################################################
```
```{r class.source="comment"}
if (CORRECTNESS) {
  print("START TEST: before Fix Invalid Names")
  print(paste0("?                ", length(which(stormDF$EVTYPE == "?"))))
  print(paste0("high             ", length(which(stormDF$EVTYPE == "high"))))
  print(paste0("marine accident  ",
               length(which(stormDF$EVTYPE == "marine accident"))))
  print(paste0("marine mishap    ",
               length(which(stormDF$EVTYPE == "marine mishap"))))
  print(paste0("other            ", length(which(stormDF$EVTYPE == "other"))))
  print(paste0("apache county    ",
               length(which(stormDF$EVTYPE == "apache county"))))
  print(paste0("Other            ", length(which(stormDF$EVTYPE == "Other"))))
  print("END TEST: before Fix Invalid Names")
}

```

```{r  transformation4,  class.source="code"}
### TRANSFORMATION CODE ########################################################
stormDF$EVTYPE <-
  gsub("\\?", "Other",
  gsub("^high$", "Other",
  gsub("^marine accident$", "Other",
  gsub("^marine mishap$", "Other",
  gsub("^other$", "Other",
  gsub("^apache county$", "Other",
  stormDF$EVTYPE))))))
```

```{r class.source="comment"}
### TEST CODE ##################################################################
### The final test for the transformation repeats the initial test. If 
### successful the transformation will drop all of the invalid event types 
### except for 'Other'. Though 'Other' is also invalid, it begins with an upper 
### case letter so subsequent name changes will not effect it. The number of 
### rows with 'Other' will be the same as the sum of all the invalid rows. 
### In other words, all invalid types were converted to 'Other'.
################################################################################
```

```{r class.source="test"}
if (CORRECTNESS) {
  print("START TEST: after Fix Invalid Names")
  print(paste0("?                ", length(which(stormDF$EVTYPE == "?"))))
  print(paste0("high             ", length(which(stormDF$EVTYPE == "high"))))
  print(paste0("marine accident  ",
               length(which(stormDF$EVTYPE == "marine accident"))))
  print(paste0("marine mishap    ",
               length(which(stormDF$EVTYPE == "marine mishap"))))
  print(paste0("other            ", length(which(stormDF$EVTYPE == "other"))))
  print(paste0("apache county    ",
               length(which(stormDF$EVTYPE == "apache county"))))
  print(paste0("Other            ", length(which(stormDF$EVTYPE == "Other"))))
  print("END TEST: after Fix Invalid Names")
}
```

```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```

```{r class.source="state"}
if (CORRECTNESS) {
  print("Fix Invalid Names State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ",
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))

}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 4a :</strong> Before executing the Fix Invalid Names Transformation, the transform counts the number of rows with invalid event names. The results show there are 40 rows with invalid names, and "Other" has no occurances.</em>.</caption>

<pre class="pre">
## [1] "START TEST: before Fix Invalid Names"
## [1] "?                1"
## [1] "high             1"
## [1] "marine accident  1"
## [1] "marine mishap    2"
## [1] "other            34"
## [1] "apache county    1"
## [1] "Other            0"
## [1] "END TEST: before Fix Invalid Names"
</pre>
</div>
```

<br/>

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 4b :</strong> After executing the Fix Invalid Names Transformation, all fourty of the invalid rows were moved to "Other". The remainder have no occurances.</em>.</caption>

<pre class="pre">
## [1] "START TEST: after Fix Invalid Names"
## [1] "?                0"
## [1] "high             0"
## [1] "marine accident  0"
## [1] "marine mishap    0"
## [1] "other            0"
## [1] "apache county    0"
## [1] "Other            40"
## [1] "END TEST: after Fix Invalid Names"
</pre>
</div>
```

<br/>

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 4c :</strong>The state of the data frame after executing the Fix Invalid Names Transformation.</caption>

<pre class="pre">
## [1] "Fix Invalid Names State"
## [1] "The data frame memory requirement is 13728448"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        7"     
## [1] "Number of unique event names         439"
</pre>
</div>

<br/>
```

#### Test result

```{=html}
<div class="testResults">

<caption><strong>Table 6:</strong> After the Fix Invalid Names Transformation there are no invalid names in stormDF, except for 'Other'. There are 40 rows with the 'Other' event, so all of the invalid names were converted to 'Other'.</caption>

<table style="testResults">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Type Name</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count Before</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count After</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'?'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'high'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'marine accident'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'marine mishap'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'other'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">34</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'apache county'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'Other'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">40</td>
</tr>
</table>

<br/>

There were a total of 40 instances of invalid names and no instances of "Other" before the transformation. After the transformation, there were no instances of the invalid names and 40 instances of "Other". This suggests the transformation was correct.

</div>

<br/>
```

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 7.</strong> Data Frame State Changes Due to the Fix Invalid Names Transformation.</caption>

<table style="stateTable">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">13,728,448</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-304</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">444</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">439</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-5</td>
</tr>
</table>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 300 B.</li>
<li>The number of rows is unchanged.</li>
<li>The number of columns is unchanged.</li>
<li>The reduction in the number of event types is 5</li>
</ul>

The changes to the data frame are insignificant, however the reduction in the number of unique event names is indicative of the problems with inconsistent nameing. This problem will become more apparent in the following transformations.

<br/>
</div>
```

<hr style="background : black; height : 15px"/>

### Unify Event Types

**Goal**

The goal of **Unify Event Types** transformation is to change all valid types to their valid NWS event type names.

**Why?**

The data collectors used idiosyncratic names for weather events. For example, the NWS event "Thunderstorm Wind" was reported as the following

```{=html}
<div style="font-size : 8px; font-weight: bold;">

<!-- Thunder storm events -->

THUDERSTORM WINDS, THUNDEERSTORM WINDS, THUNDERESTORM WINDS, THUNDERSTORM, THUNDERSTORM WINDS, Thunderstorm Wind, THUNDERSTORM WIND, THUNDERSTORM WIND (G40), THUNDERSTORM WIND 50, THUNDERSTORM WIND 52, THUNDERSTORM WIND 56, THUNDERSTORM WIND 59, THUNDERSTORM WIND 59 MPH, THUNDERSTORM WIND 59 MPH., THUNDERSTORM WIND 60 MPH,THUNDERSTORM WIND 65 MPH, THUNDERSTORM WIND 65MPH, THUNDERSTORM WIND 69, THUNDERSTORM WIND 98 MPH, THUNDERSTORM, THUNDERSTORM WIND G55, THUNDERSTORM WIND G60, THUNDERSTORM WIND G61, THUNDERSTORM WIND TREES, THUNDERSTORM WIND. THUNDERSTORM WIND/ TREE, THUNDERSTORM WIND/ TREES, THUNDERSTORM WIND/AWNING, THUNDERSTORM WINDS, THUNDERSTORM WINDS, THUNDERSTORM WINDS 13, THUNDERSTORM WINDS 2, THUNDERSTORM WINDS 50, THUNDERSTORM WINDS 52, THUNDERSTORM WINDS 53, THUNDERSTORM WINDS 60, THUNDERSTORM WINDS 61, THUNDERSTORM WINDS 62, THUNDERSTORM WINDS 63 MPH, THUNDERSTORM WINDS G, THUNDERSTORMWINDS G60, THUNDERSTORM WINDS., THUNDERSTORM WINDS53, THUNDERSTORMS WIND, THUNDERSTORMS WINDS, THUNDERSTORMW, THUNDERSTORMW 50, THUNDERSTORMW WINDS, THUNDERSTORMWINDS, THUNDERSTROM WIND, THUNDERSTROM WINDS, THUNDERTORM WINDS, THUNDERTSORM WIND, THUNDESTORM WINDS, THUNERSTORM WINDS, TSTM, TSTM WIND, Tstm Wind, TSTM WIND, TSTM WIND (G45), TSTM WIND (41), TSTM WIND (G35), TSTM WIND (G40), TSTM WIND (G45), TSTM WIND (G45), TSTM WIND 40, TSTM WIND 45, TSTM WIND 50, TSTM WIND 51, TSTM WIND 52, TSTM WIND 55, TSTM WIND 65), TSTM WIND DAMAGE, TSTM WIND G45, TSTM WIND G58, TSTM WINDS, TSTM WND, TSTMW

</div>

```

The data collectors used 78 different type names for one NWS event type name. This means this document will report 78 different events for "Thunderstorm Wind", so the correct number of casualties and economic losses will be incorrectly reported. To correct this problem, every reported type name has to be rewritten (unified) with the correct NWS event type name.

**How?**

To deal with this problem, the 444 unique event type names were matched to their corresponding NWS event types names. A list of regular expressions was developed to identify and change the source names to the NWS names. These statements can be found in the **UnifyNames** function described earlier in the **Processing Code** section.

This means all 78 versions of 'THUDERSTORM WIND' are converted into a single event type, 'Thunderstorm Wind' and other misspelled or mislabeled names are converted to their appropriate NWS names.

<hr style="background : black; height : 15px"/>

#### Code


```{r class.source="comment"}
### TRANSFORMATION CODE ########################################################
### Transformation code is long, repetitious and frankly boring to read. So the
### actual transformation code was put into the function UnifyNames. All this
### transformation does is call that function. UnifyNames is found near the
### beginning of the "Process Code" section.
################################################################################
```

```{r  class.source="comment"}

### TEST CODE ##################################################################
### The initial code test counts the number of rows with a subset of the
### 'thuderstorm wind' variations. These include, "thuderstorm winds",
### "thundeerstorm winds", "thunderestorm winds", "thunderstorm",  "thunderstorm
### winds ", and "thunderstorm wind". All of these event types should be dropped
### from stormDF after the transformation.
################################################################################
```

```{r  class.source="test"}
if (CORRECTNESS) {
  print("START TEST: before Unify Event Types")
  print(paste0("thuderstorm winds   ",
               length(which(stormDF$EVTYPE == "thuderstorm winds"))))
  print(paste0("thundeerstorm winds ",
               length(which(stormDF$EVTYPE == "thundeerstorm winds"))))
  print(paste0("thunderestorm winds ",
               length(which(stormDF$EVTYPE == "thunderestorm winds"))))
  print(paste0("thunderstorm        ",
               length(which(stormDF$EVTYPE == "thunderstorm"))))
  print(paste0("thunderstorm winds  ",
               length(which(stormDF$EVTYPE == "thunderstorm winds"))))
  print(paste0("thunderstorm wind   ",
               length(which(stormDF$EVTYPE == "thunderstorm wind"))))
  print(paste0("Thunderstorm Wind   ",
               length(which(stormDF$EVTYPE == "Thunderstorm Wind"))))
  print("END TEST: before Unify Event Types")
}

```

```{r  class.source="comment"}
### TRANSFORMATION CODE ########################################################
```

```{r transformation5,  class.source="code"}
stormDF    <- UnifyNames(stormDF)
```

```{r  class.source="comment"}
### TEST CODE ##################################################################
### The final code redoes the initial test, but it adds an additional check to
### to verify the pre-transformation name is not transformed into a "title" case
### version of the original.
################################################################################
```

```{r  class.source="test"}
if (CORRECTNESS) {
  print("START TEST: after Unify Event Types")
  print(paste0("thuderstorm winds   ",
               length(which(stormDF$EVTYPE == "thuderstorm winds"))))
  print(paste0("Thuderstorm Winds   ",
               length(which(stormDF$EVTYPE == "Thuderstorm Winds"))))

  print(paste0("thundeerstorm winds ",
               length(which(stormDF$EVTYPE == "thundeerstorm winds"))))
  print(paste0("Thundeerstorm Winds ",
               length(which(stormDF$EVTYPE == "Thundeerstorm Winds"))))

  print(paste0("thunderestorm winds ",
               length(which(stormDF$EVTYPE == "thunderestorm winds"))))
  print(paste0("Thunderestorm Winds ",
               length(which(stormDF$EVTYPE == "Thunderestorm Winds"))))

  print(paste0("thunderstorm        ",
               length(which(stormDF$EVTYPE == "thunderstorm"))))
  print(paste0("Thunderstorm        ",
               length(which(stormDF$EVTYPE == "Thunderstorm"))))

  print(paste0("thunderstorm winds  ",
               length(which(stormDF$EVTYPE == "thunderstorm winds"))))
  print(paste0("Thunderstorm Winds  ",
               length(which(stormDF$EVTYPE == "Thunderstorm Winds"))))

  print(paste0("thunderstorm wind   ",
               length(which(stormDF$EVTYPE == "thunderstorm wind"))))
  print(paste0("Thunderstorm Wind   ",
               length(which(stormDF$EVTYPE == "Thunderstorm Wind"))))
  print("END TEST: after Unify Event Types")
}
```

```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```

```{r  class.source="test"}
if (CORRECTNESS) {
  print("Unify Event Types State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ",
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}
```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 5a:</strong> Before the execution of the Unify Event Types Transformation, a select subset of "Thunderstorm Wind variants were collected and the number of occurances for each variant was counted.</caption>

<pre class="pre">
## [1] "START TEST: before Unify Event Types"
## [1] "thuderstorm winds   1"
## [1] "thundeerstorm winds 1"
## [1] "thunderestorm winds 1"
## [1] "thunderstorm        19"
## [1] "thunderstorm winds  12086"
## [1] "thunderstorm wind   43655"
## [1] "Thunderstorm Wind   0"
## [1] "END TEST: before Unify Event Types"</pre>
</pre>
</div>

```

<br/>

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 5b:</strong> After the execution of the Unify Event Types Transformation, the same variants were counted.</caption>

<pre class="pre">
## [1] "START TEST: after Transformation 5"
## [1] "thuderstorm winds   0"
## [1] "Thuderstorm Winds   0"
## [1] "thundeerstorm winds 0"
## [1] "Thundeerstorm Winds 0"
## [1] "thunderestorm winds 0"
## [1] "Thunderestorm Winds 0"
## [1] "thunderstorm        0"
## [1] "Thunderstorm        0"
## [1] "thunderstorm winds  0"
## [1] "Thunderstorm Winds  0"
## [1] "thunderstorm wind   0"
## [1] "Thunderstorm Wind   118053"
## [1] "END TEST: after Transformation 5"
</pre>
</div>

```

<br/>

```{=html}
<div class="output">

<caption style="output"><strong>Output Listing 5c:</strong>  Data Frame State Changes Due to the Unify Event Types Transformation.</caption>

<pre class="pre">
# [1] "Unify Event Types State"
## [1] "The data frame memory requirement is 13700640"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        7"
## [1] "Number of unique event names         49"
##                 EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5107           Tornado          0        1     2.5          m       0          .
## 5108 Thunderstorm Wind          1        1     0.0                  0          .
## 5129           Tornado          0        0   250.0          k       0          .
## 5130           Tornado          2        7   250.0          k       0          .
## 5135 Thunderstorm Wind          0        7     0.0                  0          .
## 5163           Tornado          0        0    25.0          k       0          .
## 5246 Thunderstorm Wind          0        1     0.0                  0          .
## 5252 Thunderstorm Wind          1        1     0.0                  0          .
## 5312           Tornado          0        0    25.0          k       0          .
## 5315           Tornado          0        2   250.0          k       0          .
##    .                 .          .        .       .          .       .          .
##    .                 .          .        .       .          .       .          .
##    .                 .          .        .       .          .       .          .
</pre>

Before the transformation, the total number of variants in this sample was 118,053, including 43,655 events with the correct NWS name. Note, all instances of "thunderstorm wind" were originally named "THUNDERSTORM WIND". The variants were all converted to the correct NWS name "Thunderstorm Wind" after the transformation.

</div>
```

<hr style="background : black; height : 2px"/>

#### Test result

```{=html}
<div class="testResults">

<caption><strong>Table 8.</strong> The in each case, the lower case versions of the event type had a value before the Unify Event Types Transformation and were zero afterward. None of the "title" case versions had a value before the transformation and only the correctly spelled NWS event type name had a nonzero value after it..</caption>

<table class="testResults">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Type Name</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count Before</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count After</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'thuderstorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'Thuderstorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'thundeerstorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'Thundeerstorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'thunderestorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">19</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'Thunderestorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'thunderstorm'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'Thunderstorm'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'thunderstorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">12086</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'Thunderstorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'thunderstorm wind'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">43655</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">'Thunderstorm Wind'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">118053</td>
</tr>
</table>


<p>There are a few aspects to these tests that are immediately obvious. Before the transformation, the event types were all written in lower case letters, and none of them were in the stormDF after the transformation. Also, none of those event types, with the exception "thunderstorm wind" were converted the their "title" case equivalent. It is also apparent the count of "Thunderstorm Wind" event grew significantly.</p>

<p>However, whether or not all of the events in the test were converted to "Thunderstorm Wind" is not clear. Before the transformation the test had 55,764 variations of "Thunderstorm Wind". After the transformation, there were 118,053 variations. The reason for the increase has to do with using only six variations rather than the 78 variations in *stormDF*. So even though the test did not prove the number of rows converted to the NWS event type name, it is reasonable to assume it had.</p>

</div>
```

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 9.</strong>  Data Frame State Changes Due to the Unify Event Types Transformation.</caption>

<table style="stateTable">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">13,731,856</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-3104</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">444</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-395</td>
</tr>
</table>

<br/>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 27 B.</li>
<li>The number of rows is unchanged.</li>
<li>The number of columns is unchanged.</li>
<li>The reduction in the number of event types is 390</li>
</ul>

The changes to size and structure of the stormDF are again insignificant. However, the change in the number of event types indicates the EVTYPE type names are the same as the NWS event type names, with the exception of the 'Other' event type name. This was added in the Unify Event Types Transformation.
</div>
```

<hr style="background : black; height : 15px"/>

### Final Data Form

**Goal**

The goal of **Final Data Form** transformation is to add a two colunms to *stormDF* for the total casualties problems and another for economic problems and to remove all other columns except for *EVTYPE*.

**Why?**

The project is designed to answer two questions, one dealing with damage to people and the other dealing with damage to the economy. Since the **storm data file** did not a way to compute the damage to either people or property, this project will use a simple sumto compute *CASUALTIES* and *ECONOMIC_LOSSES* events as follows:

-   casualties (CASUALTIES) are FATALITIES + INJURIES
-   economic costs (ECONOMIC_LOSSES) are PROPDMG \* PROPDMGEXP + CROPDMG \* CROPDMGEXP

**How?**

The *stormDF* is copied to *stormDF*. The copy includes mutating the initial data frame as follows:

1.  *PROPDMGEXP* and *CROPDMGEXP* are converted from letter representations k and m to numeric values 1,000 and 1,000,000 respectively.
2.  The values of *PROPDMG* and *CROPDMG* are multiplied by their respective exponents.
3.  The *CASUALTIES* field is set to FATALITIES + INJURIES.
4.  The *ECONOMIC_LOSSES* field is set to (PROPDMG + CROPDMG)/1,000,000. Scaling the *ECONOMIC_LOSSES* value by 1,000,000 makes the output tables and images clearer.
5.  The *FATALITIES*, *INJURIES*, *PROPDMG*, *PROPDMGEXP*, *CROPDMG*, and *CROPDMGEXP* are droped from the *stormDF* because they are no longer needed.

#### Code


```{r class.source="comment"}
### TRANSFORMATION CODE ########################################################
### Transformation 7 condenses the numerical data to modify the data frame to
### include metrics to describe which event types are the "most harmful with
### respect to population health" and "which types of events have the greatest
### economic consequences."
###
### The mutate function
### 1. replaces the exponent characters with their numerical equivalent.
### 2. replaces PROPDMG and CROPDMG with the product of PROPDMG and PROPDMGEXP
###    and the product of CRODMG and CROPDMGEXP respectively.
### 3. add new column CASUALTIES has the sum of FATALITIES and INJURIES. These
###    are quantified values for events with the most harmful impact on public
###    health.
### 3. add new column ECONOMIC_LOSSES has the sum of PROPDMG and CROPDMG. These
###    are quantified values for events with the greatest economic consequences.
###    The values in the ECONOMIC_LOSSES column are divided by 1,000,000 to
###    reduce the space taken up by printing the full value
################################################################################
```

```{r transformation6,  class.source="code"}
### TRANSFORMATION CODE ########################################################
stormDF <- stormDF %>% ungroup(.) %>%
  mutate (PROPDMGEXP = ifelse(PROPDMGEXP == 'k', 1000.,
                              ifelse(PROPDMGEXP == 'm', 1000000., 1.)),
          CROPDMGEXP = ifelse(CROPDMGEXP == 'k', 1000.,
                              ifelse(CROPDMGEXP == 'm', 1000000., 1.) ),
          PROPDMG    = PROPDMG * PROPDMGEXP,
          CROPDMG    = CROPDMG * CROPDMGEXP,
          CASUALTIES = (FATALITIES + INJURIES)/PER_ANUM,
          ECONOMIC_LOSSES   = (PROPDMG + CROPDMG)/(PER_ANUM*1000000.)
          ) %>%
  select(EVTYPE, CASUALTIES, ECONOMIC_LOSSES)

  colnames(stormDF) <- c('EVTYPE', 'CASUALTIES', 'ECONOMIC_LOSSES')
```

```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```

```{r class.source="state"}
if (CORRECTNESS) {
  print("Transformation 6 State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ",
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div class="output">
<caption style="output"><strong>Listing 6: </strong> This transformation shows the state, and data frame after the transformation. The data frame shows the transformation worked correctly.</caption>

<pre class="pre">
## [1] "Transformation 6 State"
## [1] "The data frame memory requirement is 6395120"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        3"
## [1] "Number of unique event names         49"
##                 EVTYPE CASUALTIES ECONOMIC_LOSSES
## 5107           Tornado          1    2.500
## 5108 Thunderstorm Wind          2    0.000
## 5129           Tornado          0    0.250
## 5130           Tornado          9    0.250
## 5135 Thunderstorm Wind          7    0.000
## 5163           Tornado          0    0.025
## 5246 Thunderstorm Wind          1    0.000
## 5252 Thunderstorm Wind          2    0.000
## 5312           Tornado          0    0.025
## 5315           Tornado          2    0.250
      .                 .          .        .
      .                 .          .        .
      .                 .          .        .
 </pre>
</div>
```

#### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 10.</strong>  Data Frame State Changes Due to the Final Data Form Transformation.</caption>

<table style="stateTable">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">6,395,120</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-7,333,632</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-4</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>
</table>

<br/>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 7.3 MB.</li>
<li>The number of rows is unchanged.</li>
<li>The reduction in the number of columns by 4.</li>
<li>The number of event types is unchanged.</li>
</ul>

</div>
```

<hr style="background : black; height : 15px"/>

### Group by Event

**Goal**

The goal of **Group by Event** transformation is to group the data based on the NWS weather event names and to accumulate the *CASUALTIES* and *ECONOMIC LOSSES*.

**Why?**

This project is about answering two questions:

1.  **Across the United States, which types of events are most harmful with respect to population health?**
2.  **Across the United States, which types of events have the greatest economic consequences?**

To answer these questions requires knowing the casualties and economic losses or each event type, and ordering by both casualties and economic losses. The *stormDF* includes this information on an instance (row) level, so this transformation will reduce the instance information to event information.

**How?**

The *stormDF* is grouped by *EVTYPE* by event type and the *CASUALTIES* and *ECONOMIC_LOSSES*, for each instance of an event type are summarized and assigned to the corresponding group. After this transformation, the data is ready for analysis and assigned to the *stormAnalysisDF* data frame.

#### Code


```{r class.source="comment"}
### TRANSFORMATION CODE ########################################################
### The Group by Event Transformation will group the data by EVTYPE, summarize the data for
### each event type, and arrange the events alphabetically.
################################################################################
```
```{r transformation7,  class.source="code"}
stormAnalysisDF <- stormDF %>% group_by(EVTYPE) %>%
  summarise_at(c("CASUALTIES", "ECONOMIC_LOSSES"), sum) %>%
  arrange(.$EVTYPE, .by_group = TRUE)

```
```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```
```{r class.source="test"}
if (CORRECTNESS) {
  print("Group by Event State")
  print(paste0("The data frame memory requirement is ", object.size(stormAnalysisDF)))
  print(paste0("The data frame dimensions are        ", dim(stormAnalysisDF)))
  print(paste0("Number of unique event names         ",
               length(unique(stormAnalysisDF$EVTYPE))))
  print(head(stormAnalysisDF, n = 10))
}

```

#### Output

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 7: </strong> The Group by Event Transformation shows the state, and the grouped data after the transformation. The output the first few rows of the data frame. In each case, the event type is a valid NWS type name.</caption>

<pre class="pre">
## [1] "Transformation 7 State"
## [1] "The data frame memory requirement is 5520"
## [1] "The data frame dimensions are        49"
## [2] "The data frame dimensions are        3"
## [1] "Number of unique event names         49"
## # A tibble: 10  3
##    EVTYPE                CASUALTIES  ECONOMIC_LOSSES
##    <chr>                      <dbl>     <dbl>
##  1 Astronomical Low Tide          0     0.32
##  2 Avalanche                    395     3.72
##  3 Blizzard                     959   777.
##  4 Coastal Flood                 15   408.
##  5 Cold/Wind Chill              228   100.
##  6 Debris Flow                   99   347.
##  7 Dense Fog                   1156    22.8
##  8 Dense Smoke                    0     0.1
##  9 Drought                        4 13519.
## 10 Dust Devil                    45     0.719
    .          .                     .         .
    .          .                     .         .
    .          .                     .         .
</pre>
</div>
```

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 11.</strong> Data Frame State Changes Due to the Group by Event Transformation.</caption>

<table class="stateTable">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">6,395,120</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">5520</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-6,389,600</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">-228198</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>
</table>

<br/>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 6.3 MB.</li>
<li>The reduction in the number of rows -228198.</li>
<li>The number of columns is unchanged.</li>
<li>The number of event types is unchanged.</li>
</ul>

</div>
```

<hr style="background : black; height : 15px"/>

## Data Analysis

**Goal**

The data analysis creates two tables from *stormAnalysisDF* and order them by *CASUALTIES*, and *ECONOMIC_LOSSES* columns respectively. These tables are the answers to the project questions.

**Why?**

The goal of the project is to find the worst events in terms of *CASUALTIES* or *ECONOMIC_LOSSES*. If the information were kept in a single table, the data frame can be sorted by *CASUALTIES* or *ECONOMIC_LOSSES* but not both. Therefore, it is necessary to have two identical tables, which will be orded by the respective damage type.

In addition to the required information, the analysis will add two more columns: *PERCENT* and *ACC_PERCENT*. The new columns will help identify the relative severity of each event type and the relative impact of a set of the events.

**How?**

The transformation will copy the *stormAnalysisDF* in a for-loop. The loop index (CASUALTY_IDX or ECONOMIC_IDX) will determine the ordering for each table. The first block of the transformation code copies the *stormAnalysisDF* to a *damageTable* and creates the total value of the selected index type. That is, when the index is CASUALTY_IDX, the transformation will sum all of the values in the *CASUALTIES* column.

The next block is a for-loop used to calculate the *PERCENT* and *ACC_PERCENT* columns. In the loop, the percent is calculated by dividing the number of *CASUALTIES* or *ECONOMIC_LOSSES* by the their respective *totalValue* then multiplied by 100. The value is appended *percentList* and added to the *accumulator*. The *accumulator* is then appended to the *accumulatorList*.

At the end of the loop, the *percentList* and *accumulatorList* are then stored in *damageTable* and stored in *stormDamageList*.

### Code

```{r class.source="comment"}
### ANALYSIS CODE ##############################################################
### The analysis code is a for-loop with the loop variable damageType that takes
### the values of CASUALTY_IDX or ECONOMIC_IDX.
### The loop is divided into four steps
###
### 1. Step 1
###    1. create a damageTable data frame to hold a copy of the stormAnalysisDF
###    2. sort the damageTable by damage type (CASUALTIES or ECONOMIC_LOSSES)
###    3. calculate the totalValue of the damage type
### 2. Step 2
###    1. initialize the percentList and accumulatorList to empty lists.
###    2. initialize the accumulator to zero.
###    3. calculate the percent and accumulator values and assign them to their
###       respective lists.
### 3. Step 3 add the percent list and accumlated percent list to the
###    damageTable.
### 4. Step 4 add damageTable to the stormDamageList.
###
###
################################################################################
```

```{r analysis,  class.source="code"}
stormDamageList = list()

for (damageType in CASUALTY_IDX:ECONOMIC_IDX) {
  damageTable <- stormAnalysisDF %>%
    arrange(eval(parse(text=DAMAGE_ORDERING[damageType])), .by_group = TRUE)
  totalValue <- sum(damageTable[, damageType + 1])

  # setup accumulator
  accumulator     <- 0
  percentList     <- list()
  accumulatorList <- list()

  # accumulate the data for the damage lists
  for (i in 1:length(damageTable$EVTYPE)) {
    percent <- damageTable[i, damageType + 1]*100/totalValue
    accumulator <- accumulator + percent
    percentList <- append(percentList, percent)
    accumulatorList <- append(accumulatorList, accumulator)
  }

  # store the damage lists in the damageTable
  damageTable$PERCENT <- as.numeric(unlist(percentList))
  damageTable$ACC_PERCENT <- as.numeric(unlist(accumulatorList))

  # store the damageTable in the stormDamageList
  stormDamageList <- list.append(stormDamageList, damageTable)
}
```

```{r class.source="comment"}
### TRANSFORMATION STATE CHANGES ###############################################
```

```{r class.source="test"}
if (CORRECTNESS) {
 for (damageType in CASUALTY_IDX:ECONOMIC_IDX) {
    tempDF <- data.frame(stormDamageList[damageType])
    print(paste0("Damage table ", BAR_FIELD[damageType]))
    print(paste0("The data frame memory requirement is ", object.size(tempDF)))
    print(paste0("The data frame dimensions are        ", dim(tempDF)))
    print(paste0("Number of unique event names         ",
                 length(unique(tempDF$EVTYPE))))
    print(head(tempDF, n = 10))
  }
}

```

<hr style="background : black; height : 2px"/>

### Output

```{=html}
<div class="output">
<caption style="output"><strong>Output Listing 8: </strong> The output shows the casualty and losses grouped data with the percentage information.</caption>

<pre class="pre">
## [1] "Damage table CASUALTIES"
## [1] "The data frame memory requirement is 6416"
## [1] "The data frame dimensions are        49"
## [2] "The data frame dimensions are        5"
## [1] "Number of unique event names         49"
##               EVTYPE CASUALTIES ECONOMIC_LOSSES   PERCENT ACC_PERCENT
## 1            Tornado      26311       22865.495 32.308013    32.30801
## 2     Excessive Heat      12363         524.795 15.180874    47.48889
## 3              Flood       7280       28498.142  8.939316    56.42820
## 4  Thunderstorm Wind       6901       10938.959  8.473931    64.90213
## 5          Lightning       6049         951.115  7.427736    72.32987
## 6        Flash Flood       2944       17518.623  3.615020    75.94489
## 7          Ice Storm       2064        3967.041  2.534443    78.47933
## 8          High Wind       1848        5388.025  2.269211    80.74854
## 9           Wildfire       1698        6359.910  2.085022    82.83357
## 10      Winter Storm       1584        1790.229  1.945038    84.77860
    .                 .          .               .         .           .
    .                 .          .               .         .           .
    .                 .          .               .         .           .

## [1] "Damage table ECONOMIC_LOSSES"
## [1] "The data frame memory requirement is 6416"
## [1] "The data frame dimensions are        49"
## [2] "The data frame dimensions are        5"
## [1] "Number of unique event names         49"
##               EVTYPE CASUALTIES ECONOMIC_LOSSES   PERCENT ACC_PERCENT
## 1              Flood       7280       28498.142 18.062940    18.06294
## 2            Tornado      26311       22865.495 14.492807    32.55575
## 3        Flash Flood       2944       17518.623 11.103806    43.65955
## 4               Hail       1215       17334.200 10.986914    54.64647
## 5  Hurricane/Typhoon       1468       14962.528  9.483680    64.13015
## 6            Drought          4       13518.672  8.568522    72.69867
## 7  Thunderstorm Wind       6901       10938.959  6.933426    79.63210
## 8           Wildfire       1698        6359.910  4.031094    83.66319
## 9          High Wind       1848        5388.025  3.415085    87.07827
## 10         Ice Storm       2064        3967.041  2.514425    89.59270
    .                 .          .               .         .           .
    .                 .          .               .         .           .
    .                 .          .               .         .           .
</pre>

Both tables have *EVTYPE*, *CASUALTIES*, *ECONOMIC_LOSSES*, *PERCENT*, and
*ACC_PERCENT* columns, but the first table is sorted by *CASUALTIES* and the
*PERCENT*, and *ACC_PERCENT* are calculated for *CASUALTIES*. The second table
is the same as the first except the focus is no *ECONOMIC_LOSSES*.

</div>
```

<hr style="background : black; height : 2px"/>

### State Changes

```{=html}
<div class="stateResult">

<caption><strong>Table 12.</strong> Data Frame State Changes Due to Data Analysis</caption>

<table style="width : 100%; margin-left: auto; margin-right: auto;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">5520</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">6416</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">896</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">5</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">2</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">0</td>
</tr>
</table>

<br/>
<strong>Data Frame Changes</strong>

<ul>
<li>The reduction in the required memory size, roughly 896 B.</li>
<li> The number of rows is unchanged.</li>
<li>The number of columns is unchanged.</li>
<li>The number of event types is unchanged.</li>
</ul>

</div>

```

<hr style="background : black; height : 15px"/>

## Formatted Output

### Table Formatting

```{r class.source="comment"}
### KABLE TABLE CODE ###########################################################
### The kable tables are formatted tables used to display the results of the
### analysis. It makes extensive use of the "constants" described at the
### beginning the "Processing Code" section. The purpose of these "constants" is
### to turn titles, labels, and some instructions that are dependent on the
### damage type (CASUALTIES or ECONOMIC LOSSES) into arrays that are referenced
### by damage type.
###
### In this case, the TABLE_FIELDS[CASUALTY_IDX] defines the columns required
### by the casualty table and TABLE_LABELS[CASUALTY_IDX] defines the titles used
### by the casualty table.
###
### Likewise, the TABLE_FIELDS[ECONOMIC_IDX] defines the columns required
### by the economic losses  table and TABLE_LABELS[ECONOMIC_IDX] defines the
### titles used by the economic losses table.
###
################################################################################
```

```{r ktable, class.source="code"}
getTable <- function (damageTable, damageType)
{
  damageTable <- damageTable %>%
    select(eval(parse(text = TABLE_FIELDS[[damageType]])))

  resTable <- knitr::kable(damageTable, "html",
    caption = paste0("<center><strong><font size='1'>",
                     "Table ", (damageType + 12),". United States ",
                     DAMAGE_LABELS[damageType],
                     " due to Severe Weather Events (1996-2012)</font><center></strong>"),
    digits = 3, align = "lrrr",
    col.names = c(TABLE_LABELS[[damageType]]), row.names = TRUE
    ) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = F,
                  position = "left",
                  font_size = 10) %>%
    column_spec(column=1, width="1cm") %>%
    column_spec(column=2, width="3cm") %>%
    column_spec(column=3, width="2cm") %>%
    column_spec(column=4, width="2cm") %>%
    kable_classic_2()

  return (resTable)

}

```

### Bar Plot Formatting


```{r class.source="comment"}
### BAR PLOT DAMAGE CODE #######################################################
### The storm damage bar plots use the same information as the kable tables
### except it shows only the top 25 event types. The x-axis is the event type
### and the y-axis in the first plot is the number of casualties and in the
### second is the amount of economic losses in $millions.
###
### As with the kable tables, the bar plots rely on "constants" describe at the
### start of this section.  The purpose of these "constants" is
### to turn titles, labels, and some instructions that are dependent on the
### damage type (CASUALTIES or ECONOMIC LOSSES) into arrays that are referenced
### by damage type.
###
### The bar plots select the columns it needs using the BAR_SELECT array.
### BAR_SELECT[CASUALTY_IDX] selects the EVTYPE and CASUALTIES, and
### BAR_SELECT[ECONOMIC_IDX] selects the EVTYPE and ECONOMIC_LOSSES
###
### Setting the x-axis to EVTYPE reorders the damage table alphabetically. To
### ensure the desired ordering, the reorder command will order arrays as
### follows:
###
### BAR_REORDER[CASUALTY_IDX] is "reorder(EVTYPE, -CASUALTIES)". This will
### reorder the damageTable by CASUALTIES, and it the context of the aes
### parameters, EVTYPE will be the x-axis.
### BAR_REORDER[ECONOMIC_IDX] is "reorder(EVTYPE, -ECONOMIC_LOSSES)". This will
### reorder the damageTable by ECONOMIC_LOSSES, and it the context of the aes
### parameters, EVTYPE will be the x-axis.
###
### BAR_FIELD is used to set the y-axis, so
### BAR_FIELD[CASUALTY_IDX] = "CASUALTIES"
### BAR_FIELD[ECONOMIC_IDX] = "ECONOMIC_LOSSES"
###
### The TABLE_LABELS arrays contain two sets of labels. The second element of
### the used to set the y-axis label.
### TABLE_LABELS[[CASUALTY_IDX]][2] is "Casualties"
### TABLE_LABELS[[ECONOMIC_IDX]][2] is "Economic Losses (in millions)"
###
################################################################################
```

```{r barplots, class.source="code"}
barPlot <- function (damageTable, damageType)
{
  damageTable <- head(damageTable, n=25) %>%
    select(eval(parse(text = BAR_SELECT[[damageType]])))


  plt <- ggplot(damageTable,
                aes(x = eval(parse(text=BAR_REORDER[[damageType]])),
                    y = eval(parse(text=BAR_FIELD[[damageType]])))) +
    ggtitle(paste0("Figure ", damageType,". Storm Related ",
                   str_to_title(TABLE_LABELS[[damageType]][2]))) +
    xlab("Event") +
    ylab(str_to_title(TABLE_LABELS[[damageType]][2])) +
    geom_bar(stat="identity", width=0.7, fill="blue1") +
    theme(plot.title = element_text(face="plain", color="black", size=12),
          axis.text.x = element_text(size = 5, face="bold", angle = -80,
                                     hjust = 0, vjust = 0),
          axis.text.y = element_text(size = 5, face="bold"),
          axis.title.x = element_text(size = 8, face="bold"),
          axis.title.y = element_text(size = 8, face="bold"))
  save_plot(paste0("EVTYPE-0", damageType, ".png"), plt)
}

```

### Scatter Plot Formatting


```{r class.source="comment"}
### SCATTER PLOT DAMAGE CODE ###################################################
### The storm damage scatterplot needs only one of the damage table since, both
### have the same columns and the order does not matter. Each (CASUALTY,
### ECONOMIC_LOSSES) pair represents an EVTYPE on the scatterplot. Most of the
### (CASUALTY, ECONOMIC_LOSSES) pairs will be represented as black dots, the
### ten worst events of each damage type will be represented by colored dots.
###
### As with the kable tables and the bar plots, the scatterplot relies on
### "constant" arrays for titles and labels dependent on the damage type
### (CASUALTIES or ECONOMIC LOSSES) to the label the plot.
################################################################################
```

```{r scatterplot, class.source="code"}
scatterPlot <- function (stormDamageList)#, damageType)
{
  set <- c(head(stormDamageList[[1]]$EVTYPE, n = 10),
                head(stormDamageList[[2]]$EVTYPE, n = 10))
  eventSet <- unique(set)

  if(CORRECTNESS) {
    print(paste0("Event set: ", eventSet))
  }

  worstTable <- stormAnalysisDF[stormAnalysisDF$EVTYPE %in% eventSet,  ]
  plotTable  <- stormAnalysisDF[!(stormAnalysisDF$EVTYPE %in% eventSet),  ]
  plotTable$EVTYPE <- "z"
  plotTable <- rbind(worstTable, plotTable)

  plt <- ggplot(plotTable, aes(x = CASUALTIES, y = ECONOMIC_LOSSES)) +
    ggtitle("Figure 3. United States Public Health vs. Economic Losses") +
    xlab(TABLE_LABELS[[CASUALTY_IDX]][2]) +
    ylab(TABLE_LABELS[[ECONOMIC_IDX]][2]) +
    theme(plot.title = element_text(face="plain", color="black", size=28),
          axis.title.x =
            element_text(face="bold", color="black", size=14),
          axis.title.y = element_text(face="bold", color="black", size=14),
          axis.text = element_text(size = 10, face="bold")) + #,
    scale_color_manual(
      values = c("antiquewhite4", "aquamarine4", "azure4", "bisque4", "blue3",
                 "brown3", "burlywood4", "cadetblue4", "chartreuse4",
                 "chocolate3", "coral3", "cornsilk4", "cyan3",
                 "black"
                 ),
      labels =  c("Drought", "Excessive Heat", "Flash Flood", "Flood", "Hail",
        "High Wind", "Hurricane/Typhoon", "Ice Storm", "Lightning",
        "Thunderstorm Wind", "Tornado", "Wildfire", "Winter Storm", "Other"
        ),
      guide = guide_legend(override.aes = list(size = 3) ))   +
    geom_point(data = plotTable, aes(x = CASUALTIES, y = ECONOMIC_LOSSES,
                                     color = EVTYPE), size=2) +
    geom_text_repel (
      data = worstTable,
      aes(x=CASUALTIES, y=ECONOMIC_LOSSES, label = EVTYPE, color = EVTYPE,
          fontface = "bold"),
      min.segment.length = 0.0, nudge_y = 10-.0, nudge_x = 150.0,
      force = 100.0,
      force_pull = 30.0
    )

  save_plot("CASUALTIES_v_LOSSES.png", plt, ncol = 2, nrow = 2)
}

```

```{r image maker,  class.source="code"}

barPlot(stormDamageList[[CASUALTY_IDX]], CASUALTY_IDX)
barPlot(stormDamageList[[ECONOMIC_IDX]], ECONOMIC_IDX)
scatterPlot(stormDamageList)

casualtyTable <- getTable(stormDamageList[[CASUALTY_IDX]], CASUALTY_IDX)
lossesTable   <- getTable(stormDamageList[[ECONOMIC_IDX]], ECONOMIC_IDX)

```

<hr style="background: Black; height: 30px"/>

# Results

This project was designed to answer the following questions:

1.  Across the United States, which types of events are most harmful with respect to population health?
2.  Across the United States, which types of events have the greatest economic consequences?

To some extent, Tables 13 and 14 answer the questions. They list the events ordered by casualties and  economic losses respectively, but they do not suggest which ones are worst. Using the accumulated percent column would allow the emergency manager could identify the worst 90% of events from the ordered events tables. This criterion would identify the events ranging from "Tornado" to "Heavy Snow" as the worst. Nevertheless, using an arbitrary limit define what is or is not among the worst weather events may not lead to an accurate conclusion. Instead, visualizing the information may give some clarity in the matter.

Figures 1 and 2 show the worst 25 events in order of both damage types. These figures give an emergency manager enough information to see how the damage done by event types change relative to each other. For example, looking at Figure 1, the bulk of the damage appears to span from "Tornado" to "Lightning" or "Hail". Using this approach, the manager might select "Tornado" to "Flash Flood".

Using this criteria, the manager could select "Tornado" through "Lightning" in Figure 1 as a cutoff because of the drop in casualties between "Lightning" and "Flash Flood". Using Table 1, this range of events account for about 75% damage caused by weather events. Again, this is arbitrary, but it uses the expertise of the manager rather than an arbitrary cutoff value to determine "the worst."

A third option is presented in Figure 3. This figure shows events as relationship between casualties and economic losses. Each event is plotted on the graph with casualties on the x-axis and economic losses on the y-axis. Most of the events are represented by black dots however, the worst ten events from both damage types are assigned colored dots, and are labeled to clarify their positions. Again selecting the worst ten is an arbitrary choice, but it does provide the manager with a new perspective of what "the worst" can mean.

## Tables

Table 13 lists the contents of the casualty damage table. There are a few ways to use this table:

1. Since the table is ordered by the severity of the event, the worst *n* event types are the first *n* entries in the table.
2. The events types accounting for *x*% of the worst casualties is found by scanning the "Accumulated Percent" for the first value greater than *x*.

If the emergency manager wants to know the ten worst event types for causing casualties, the table shows "Tornado", "Excessive Heat", "Flood", "Thunderstorm Wind", "Lightning", "Heat", "Flash Flood", "Ice Storm", "High Wind", and "Wildfire".

If they want to know which events are responsible for causing 90% the casualties:
"Tornado", "Excessive Heat", "Flood", "Thunderstorm Wind", "Lightning", "Heat", "Flash Flood", "Ice Storm", "High Wind", "Wildfire", "Winter Storm", "Hurricane/Typhoon", "Winter Weather", "Hail", and Heavy Snow".

```{r}
casualtyTable
```

```{=html}
<div class="displayTable">
Source: NOAA National Centers for Environmental Information Storm Events Database via https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
</div>
<br/>
```

Table 14 lists the contents of the economic damage table. As with Table 13, this table can be used for the same proposes:

1. The worst *n* event types are the first *n* entries in the table.
2. The worst *x*% of the economic losses is found by scanning the "Accumulated Percent" for the first value greater than *x*.

If the emergency manager wants to know the ten worst event types for causing economic losses, the table shows "Flood", "Tornado", "Flash Flood", "Hail", "Hurricane/Typhoon", "Drought", "Thunderstorm Wind", "Wildfire", "High Wind", and "Ice Storm".

If they want to know which events are responsible for causing 90% the casualties:
"Flood", "Tornado", "Flash Flood", "Hail", "Hurricane/Typhoon", "Drought", "Thunderstorm Wind", "Wildfire", "High Wind", "Ice Storm", and "Tropical Storm".

```{r}
lossesTable
```
```{=html}
<div  class="displayTable">
Source: NOAA National Centers for Environmental Information Storm Events Database via  https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
</div>
<br/>
```

## Graphs

Using the tables to analyze the worst event types is useful when constrained by a threshold limit e.g, the top 10 or the worst 90%. However, these constraints are artificially imposed and do not allow expert input to determine what constitutes the worst event types.

Figure 1 shows the number of casualties for the twenty-five most harmful weather events. It is the same data found in Table 13 but the plot visualizes the data in a way that gives a different perspective of the impact events types. For example, looking at Figure 1 shows several drops in casualties for each event types. Specifically,  the "Tornado"/"Excessive Heat" drop, the "Excessive Heat"/"Flood" drop, the "Lightning"/"Hail" drop, etc. If one of the drops delineate one group of events from the others, that point could be used as the boundary for the worst events.

For example, if the "Lightning"/"Hail" drop is used as the boundary, then the worst event types are "Tornado", "Excessive Heat", "Flood", "Thunderstorm Wind", "Lightning", and "Hail".

```{r, evtype 1 image}
    knitr::include_graphics("EVTYPE-01.png")
```

```{=html}
<div style="font-size : 8px; font-weight: normal; margin-top: 0px;
  margin-bottom: 10px; margin-right: 100px; margin-left: 100px; text-align : center">
Source: NOAA National Centers for Environmental Information Storm Events Database via https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
</div>
<br/>
```


As in Figure 1, Figure 2 shows the worst twenty-five events in terms of economic losses. In this plot, the drops consist of "Tornado"/"Flash Flood", "Thunderstorm Wind"/"Wildfire", and "Tropical Storm"/"Frost/Freeze".

For example, if the "Thunderstorm Wind"/"Wildfire" drop is used as the boundary, then the worst event types are "Flood", "Tornado", "Flash Flood", "Hail", "Hurricane/Typhoon", "Drought", and "Thunderstorm Wind".

```{r, message=TRUE, echo = TRUE}
    knitr::include_graphics("EVTYPE-02.png")
```

```{=html}
<div style="font-size : 8px; font-weight: normal; margin-top: 0px;
  margin-bottom: 10px; margin-right: 100px; margin-left: 100px;">
Source: NOAA National Centers for Environmental Information Storm Events Database via https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
</div>
<br/>
```

An issue with the Figures 1 and 2 is their focus on one event type or the other, but an emergency manager may also need to consider the relationship between casualties or only on economic losses. To fill this gap, Figure 3 shows each event as a relationship between casualties and losses. Each point on the graph is an event type, most of which are black. The colored dots represent are drawn from the worst ten events  found in the casualty and economic tables.

The point of this plot is to give an emergency manager information regarding the trade-off between casualties and economic loss to assess the worst events. For example, an emergency manager could draw a box around the points that seem less important and select the event types outside the box as the worst case.

Consider a decision to draw the box at $500,000,000 per year and 250 casualties per year. This box will eliminate all of the black dots and the "Wildfire", "High Wind", "Ice Storm", and "Winter Storm". This would make the worst types


```{=html}
<br/>
<div class="state">

<strong>Table 15.</strong> Worst Events Based on the Relationship between Casualties and Economic Losses (1996-2012).

<table style="width : 100%; margin-left: auto; margin-right: auto;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Event Type</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Casualty Rank</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Economic Rank</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Drought</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">35</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">6</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Excessive Heat</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">20</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Flash Flood</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">3</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Flood</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Hail</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">14</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">4</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Hurricane/Typhoon</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">12</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">5</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Lightning</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">5</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">18</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Thunderstorm Wind</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">4</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">7</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 1px;">Tornado</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 1px;">2</td>
</tr>

</table>

</div>
<br/><br/>
```


```{r, message=TRUE, echo = TRUE}
    knitr::include_graphics("CASUALTIES_v_LOSSES.png")
```

```{=html}

<div style="font-size : 8px; font-weight: normal; margin-top: 0px;
  margin-bottom: 10px; margin-right: 100px; margin-left: 100px;">
Source: The National Oceanographic and Atomspheric Administration (NOAA) National Centers for Environmental Information (NCEI) Storm Events Database via https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
</div>

```

**Conclusion**

The point of this project and the analysis is to reach a conclusion regarding the weather events that post the greatest threat to people and the economy. The question requires a clear picture of the relationship between the casualties and economic losses and this is what the third analysis provides. Using this holistic views, the data show:

1. Across the United States, which types of events are most harmful with respect to population health?
**The event types that are the most harmful are:**

Excessive Heat, Flash Flood, Flood, Lightning, Thunderstorm Wind, and Tornado.

2.  Across the United States, which types of events have the greatest economic consequences?
**The event types with the greatest economic damages are:**

Drought, Flash Flood, Flood, Hail, Hurricane/Typhoon, Lightning, Thunderstorm Wind, and Tornado.


<hr style="background:#36013F; height:30px"/>

# Bibliography

[c] <https://www.ncdc.noaa.gov/stormevents/details.jsp>

[b] <https://www.ncdc.noaa.gov/stormevents/> Database download

[a] NATIONAL WEATHER SERVICE INSTRUCTION 10-1605 downloaded from <https://www.nws.noaa.gov/directives/sym/pd01016005curr.pdf> on Nov 30, 2022

[d] https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2


[2] Benefit-Cost Analysis Sustainment and Enhancements: Draft Standard Economic Value Methodology Report


<https://www.fema.gov/sites/default/files/documents/fema_standard-economic-values-methodology-report_092022.pdf>

[3] <https://www.transportation.gov/office-policy/transportation-policy/revised-departmental-guidance-on-valuation-of-a-statistical-life-in-economic-analysis> Source of FEMA's VSL data
