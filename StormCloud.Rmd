---
title: 'Severe Weather: Preparing for Emergency Response'
author: "Kevin Glass"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 4
    number_sections: yes
    toc_float:
      toc_collapsed: yes
    theme: united
---

```{r knitr setup}

knitr::opts_chunk$set(echo = TRUE)
options(max.print = 1000)

```

# Synopsis

This project is designed to assist emergency response organizations to prepare for severe weather events in the United States. With tornadoes in the Midwest, hurricanes in the Gulf Coast and Eastern Seaboard, severe winter storms in the Mountain West, etc., require these organizations aid recovery from different types of damage in different geographical regions. The National Oceanographic and Atmospheric Agency (NOAA) Storm Events Database (SED) has captured data related to these events from 1950 to the present.

The point of this project is to take the SED data and condense it to a list of events that cause the worst human and economic damage. The R code embedded in this document will analyze SED data will clean the data, remove data points that do not contribute to the analysis, and ensure all event types names are changed to National Weather Service (NWS) Instruction 10-1605 (NWS Instruction). With the cleaned data frame, the code will copy the data frame and order by the human damage and the other by the economic damage. The code will use the ordered data frames to produce tables and images to give emergency managers and others a concise description of most damaging to the least damaging weather events.

# Data Processing

**Overview** The purpose of this project is to answer the following questions:

1.  **Across the United States, which types of events are most harmful with respect to population health?**
2.  **Across the United States, which types of events have the greatest economic consequences?**

To answer these questions, the project must take the contents of a 500 MB **storm data file** provided from the National Oceanographic and Atmospheric Agency (NOAA) Storm Events Database [b] and condense its contents to a the set of valid events as defined by the National Weather Service (NWS) Instruction 10-1605 [a]. The condensed data must be ordered from the most to least harmful to public health and to economic consequences.

With this data, this document will display tables showing how the events rank in terms of **casualties** ("...harmful with respect to population health") and in terms of **economic losses** ("the greatest economic consequences"). It will also display two bar plots of the data to visualize both casualties and economic losses and another plot to comparing casualties and economic losses.

**About the Data**

The **storm data file** is a csv file containing more than 900,000 records with thirty-seven columns defining each of the 900,000+ data points. There are several problems in the database:

1.  Misspellings of event type names.
2.  Event type names with whitespace in front of or behind the name. Names like " FLOOD " and "FLOOD" are different because of the leading and trailing spaces, removing them will change the first name match the second;
3.  Inconsistent use of capitalization. Names like "BLACK ICE" and "black ice" are different because of the use of upper case letters, converting them to a single case representation, changing them to all lower case will make first name match the second (NOTE: all upper case would also work as would other approaches.); 
4.idiosyncratic event names, like "?" and "high" have no equivalent names in the NWS event type name conventions, though they have an impact on the casualty and loss values in the final data set.

The time span of the data set ranges from 1950 to 2012 (the last date in the set is (11/28/2011), but not all of this data used the same collection criteria.The data collection criteria have changed three time since its inception. The first set of criteria were applicable from 1950 to 1955 and accounted for tornadoes only. The second set of criteria were applicable from 1955 to 1996 and added thunderstorm wind, and hail. The third set was applicable from 1996 onward. These now include the following event types:

Astronomical Low Tide, Avalanche, Blizzard, Coastal Flood, Cold/Wind Chill, Debris Flow, Dense Fog, Dense Smoke, Drought, Dust Devil, Dust Storm, Excessive Heat, Extreme Cold/Wind Chill, Flash Flood, Flood, Freezing Fog, Frost/Freeze, Funnel Cloud, Heat, Heavy Rain, Heavy Snow, High Surf, High Wind, Hurricane/Typhoon, Ice Storm, Lakeshore Flood, Lake-Effect Snow, Lightning, Marine Hail, Marine High Wind ,Marine Strong Wind, Marine Thunderstorm Wind, Rip Current, Seiche, Sleet, Storm Tide, Strong Wind, Thunderstorm Wind, Tornado, Tropical Depression, Tropical Storm, Tsunami, Volcanic Ash, Waterspout, Wildfire, Winter Storm, Winter Weather

```{=html}

<p style="">The analysis is restricted the to time span to 1996 to 2012.</p>

```

**Processing the Data**

The **storm data file** is a roughly 500 MB csv file with over 900,000 rows and 37 columns. The embedded R code will 
1. Reduce the number of columns it reads to seven, so the read will create a 902297 row by 7 column data frame.
2. Remove any row with all numerical values equal to zero. These rows will not contribute to the analysis the data, so there is no reason to keep them. 
3. Clean and convert all string values to lower case. This will simplify comparison functions.
4. Transform to the appropriate NWS Instruction type names.

The data analysis will produce a list of the most to least harmful events and list of the most economically damaging to the least damaging. Both of these lists will be presented as tables in the document. Also, both tables will be used to produce bar graphs to visualize the data. A third plot will show the relationship between the casualties and economic losses for each event type.

<hr style="background : black; height : 15px"/>

## Processing Code

### Required Libraries

```{r libraries}
# Required Libraries ===========================================================
# This code block loads the tables required to run the complete code.
# ==============================================================================
library(knitr)
library(stringr)
library(dplyr)
library(rlist)
library(kableExtra)
library(ggplot2)
library(ggrepel)
library(cowplot)
library(usefun)
```

### "Constants"

```{r constants}
# "Constants" ==================================================================
# The following variables are used as constants, that is, the must not be 
# changed after they are assigned a value. For clarity, all "constant" variables
# are spelled in all upper case letters to distinguish them from other 
# variables.
# 
# This code block will give a brief description of the constants and more 
# detailed will be provded in the code block using them.
# ==============================================================================

# The URL and STORM_DATA_FILE are assigned here
URL      = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
STORM_DATA_FILE = "storm.csv.bz2"

# The number of years in the data frame. This is used to convert values to 
# value per year.
PER_ANUM = 2012.0 - 1996.0

# Many constants are set up as arrays of two values. To make the meaning clear,
# the code uses the indices, rather than 1 or 2 to access the appropriate array
# element.
CASUALTY_IDX   = 1
ECONOMIC_IDX   = 2


# Kable tables
TABLE_FIELDS <-  c("c('EVTYPE', 'CASUALTIES', 'PERCENT', 'ACC_PERCENT')",
                  "c('EVTYPE', 'ECONOMIC_LOSSES', 'PERCENT', 'ACC_PERCENT')")

TABLE_LABELS <- list(
    c("Event Type", "Casualties/year", "Percent of Total", "Accumulated Percent"),
    c("Event Type", "Economic Losses/year (in millions)", "Percent of Total", 
      "Accumulated Percent")
    )

DAMAGE_LABELS <- c("Casualties/year", "Economic Losses/year")
DAMAGE_ORDERING = c("desc(.$CASUALTIES)", "desc(.$ECONOMIC_LOSSES)")

# Barplots names 
BAR_SELECT  = c("c('EVTYPE', 'CASUALTIES')",
                  "c('EVTYPE', 'ECONOMIC_LOSSES')")

BAR_REORDER = c("reorder(EVTYPE, -CASUALTIES)",
                   "reorder(EVTYPE, -ECONOMIC_LOSSES)")

BAR_FIELD   = c("CASUALTIES", "ECONOMIC_LOSSES")

# Setting up Verification
# 
# Every transformation has some verification output to demonstrate that the code
# is working correctly; however, including verification output will clutter the 
# document with details that are not important for the emergency managers. To 
# resolve the problem, the following constants are used. All of the verification
# code is written inside an "if" statement. When the constant "CORRECTNESS" is 
# set to TRUE, the verification code will be executed and when set to FALSE
# it will not.
#
# The "ALL_DATA" is used for a specific function. When both "CORRECTNESS" and
# "ALL_DATA" are set to TRUE, a block of code will read the whole contents of
# storm data file and print some basic information about the resulting data 
# frame. After printing this information, the markdown execution will stop.
# The only purpose for this block of code is to get a baseline data set for the
# data frame transformations.

CORRECTNESS               = TRUE
ALL_DATA                  = FALSE

```

### Unify Names

```{r Unify Names}
# UnifyNames ===================================================================
# This function is called in Transformation 5, and it might not make sense 
# without reading that transformation first.
# 
# Some of the data collectors did not adhere to the NWS Instruction naming 
# as a result, one event type could have several type names. The following code
# is designed to force all event type names in the data frame to conform to the 
# NWS conventions using gsub statements.
# 
# The code is long and repetitive.
# ==============================================================================

UnifyNames <- function(stormDF) {
  
  stormDF$EVTYPE <-
    gsub("^sleet$", "Sleet",
    gsub("^ice storm$", "Ice Storm",
    gsub("^lake.effect snow$", "Lake-Effect Snow",
    gsub("^(lakeshore flood|lake flood)$", "Lakeshore Flood",
    gsub("^tsunami$", "Tsunami",
    gsub("^tropical depression$", "Tropical Depression",
    gsub("^tropical storm.*$", "Tropical Storm",
    gsub("^marine hail$", "Marine Hail",
    gsub("^marine high wind$", "Marine High Wind",
    gsub("^marine strong wind$", "Marine Strong Wind",
    gsub("^marine thunderstorm wind$", "Marine Thunderstorm Wind",
    gsub("^marine tstm wind$", "Marine Thunderstorm Wind",
    gsub("^storm force winds$", "Marine Strong Wind",
    gsub("^astronomical high tide$", "Coastal Flood",
    stormDF$EVTYPE))))))))))))))

  stormDF$EVTYPE <-
    gsub("^fog and cold temperatures$", "Freezing Fog",
    gsub("^freezing fog$", "Freezing Fog",
    gsub("^small hail$", "Hail",
    gsub("^gradient wind$", "Rip Current",
    stormDF$EVTYPE))))

  stormDF$EVTYPE <-
    gsub("^(high|heavy|rough).+seas.*$", "Marine Strong Wind",
    gsub("^(high|heavy).+swells.*$", "Marine High Wind",
    gsub("^(typhoon|hurricane.*)$", "Hurricane/Typhoon",
    gsub("^drowning$", "Rip Current",
    stormDF$EVTYPE))))

  stormDF$EVTYPE <-
    gsub("^.*coastal.*$", "Coastal Flood",
    gsub("^.*erosion.*$", "High Surf",
    gsub("^.*tidal.*$", "Coastal Flood",
    gsub("^storm surge.*$", "Storm Tide",
    gsub("^high.+(tides|waves).*$", "Storm Tide",
    gsub("^rogue.+$", "Storm Tide",
    stormDF$EVTYPE))))))

  stormDF$EVTYPE <-
    gsub("^(dam break|ice floes|ice jam( flood.+|))$", "Flash Flood",
    gsub("^.+small stream urban$", "Flash Flood",
    gsub("^urban.+(small|stream).*$", "Flash Flood",
    gsub("^(small|minor).+flood.*$", "Flash Flood",
    gsub("^flood.+flash.*$", "Flash Flood",
    gsub("^flash.*$", "Flash Flood",
    stormDF$EVTYPE))))))

  stormDF$EVTYPE <-
    gsub("^.*freezing (drizzle|rain|spray).*$", "Winter Weather",
    stormDF$EVTYPE)

  # # must come after marine
  stormDF$EVTYPE <-
    gsub("^hail.*$", "Hail",
    gsub("^thunderstorm.+hail$", "Hail",
    gsub("^.*tstm.+hail$", "Hail",
    gsub("^(wind|gusty).+hail$", "Hail",
    stormDF$EVTYPE))))

  stormDF$EVTYPE <-
    gsub("^(wind|non|gusty).+wind.*$", "High Wind",
    gsub("^(strong|gusty).*$", "Strong Wind",
    gsub("^(rain.+wind|wind.+rain)$", "High Wind",
    gsub("^wind.*$", "High Wind",
    gsub("^rip current.*$", "Rip Current",
    stormDF$EVTYPE)))))

  stormDF$EVTYPE <-
    gsub("^(wind|gusty).+rain$", "Heavy Rain",
    gsub("^(unseasonal|hvy|high.+heavy).+rain.*$", "Heavy Rain",
    gsub("^rain(.*|fall)$", "Heavy Rain",
    gsub("^heavy (shower|precipitation)$", "Heavy Rain",
    gsub("^heavy.(rain|rains)$", "Heavy Rain",
    gsub("^heavy rain/severe weather$", "Heavy Rain",
    gsub("^(torrential|record|excessive) rainfall$", "Heavy Rain",
    stormDF$EVTYPE)))))))

  stormDF$EVTYPE <-
    gsub("^heavy rain/lightning", "Lightning",
    gsub("^thunderstorm.+lightning", "Lightning",
    gsub("^tstm.+lightning", "Lightning",
    gsub("^ligntning$", "Lightning",
    gsub("^lighting$", "Lightning",
    gsub("^ligntning+rain$", "Heavy Rain",
    gsub("^lightning.*$", "Lightning",
    stormDF$EVTYPE)))))))

  stormDF$EVTYPE <-
    gsub("^thunderstorm.+flood($|ing$)", "Flood",
    gsub("^high.+water$", "Flood",
    gsub("^(flood|river|rural|major|break).+$", "Flood",
    gsub("^urban.+flood.*$", "Flood",
    gsub("^ice jam flooding$", "Flood",
    gsub("^rapidly rising water$", "Flood",
    gsub("^flood$", "Flood",
    gsub("^heavy rain(s/flooding| and flood)$", "Flood",
    gsub("^heavy snow/high winds & flood$", "Flood",
    stormDF$EVTYPE)))))))))

  stormDF$EVTYPE <-
    gsub("^thunder.+$", "Thunderstorm Wind",
    gsub("^tstm.+$", "Thunderstorm Wind",
    gsub("^.+burst.*$", "Thunderstorm Wind",
    gsub("^severe thunder.+$", "Thunderstorm Wind",
    gsub("^severe turb.+$", "Thunderstorm Wind",
    gsub("^whirlwind$", "Thunderstorm Wind",
    gsub("^(thude|thune|tund|thundeer).+$", "Thunderstorm Wind",
    stormDF$EVTYPE)))))))

  stormDF$EVTYPE <-
    gsub("^(cold air torn|torn).+$", "Tornado",
    gsub("^(gustnado|landspout)$", "Tornado",
    stormDF$EVTYPE))

  stormDF$EVTYPE <-
    gsub("^.*heavy snow$", "Heavy Snow",
    gsub("^(excessive|high|heavy).+snow$", "Heavy Snow",
    gsub("^record snow$", "Winter Weather",
    stormDF$EVTYPE)))

  stormDF$EVTYPE <-
    gsub("^extreme.+chill$|^(extended|extreme|record) cold$", "Extreme Cold/Wind Chill",
    gsub("^hypo.+$", "Extreme Cold/Wind Chill",
    stormDF$EVTYPE))

  stormDF$EVTYPE <-
    gsub("^high.+blizzard.*$", "Blizzard",
    gsub("^.*blowing snow$", "Blizzard",
    gsub("^.*blizzard.*$", "Blizzard",
    gsub("^high.+wind.*$", "High Wind",
    gsub("^snow/high winds$", "Blizzard",
    stormDF$EVTYPE)))))

  stormDF$EVTYPE <-
    gsub("^heavy.+ice$", "Winter Storm",
    gsub("^heavy.+storm$", "Winter Storm",
    gsub("^heavy.+winds$", "Winter Storm",
    gsub("^heavy.+snow.*$", "Winter Storm",
    gsub("^winter.+storm$", "Winter Storm",
    gsub("^.*winter storm.+$", "Winter Storm",
    stormDF$EVTYPE))))))

  stormDF$EVTYPE <-
    gsub("^.*sl(ide|ump).*$", "Debris Flow",
    gsub("^(snow|sleet|glaze).+ice storm$", "Winter Weather",
    gsub("^glaze.*$", "Winter Weather",
    stormDF$EVTYPE)))


  stormDF$EVTYPE <-
    gsub("^cool and wet$", "Winter Weather",
    gsub("^(late|light).+snow.*$", "Winter Weather",
    gsub("^.*winter storm.+$", "Winter Storm",
    gsub("^(rain.snow|snow.rain)$", "Winter Weather",
    gsub("^falling snow/ice$", "Winter Weather",
    gsub("^wint.+$", "Winter Weather",
    stormDF$EVTYPE))))))

  stormDF$EVTYPE <-
    gsub("^.*drought.*$", "Drought",
    gsub("^.*heat.*$", "Excessive Heat",
    gsub("^hyper.+$", "Excessive Heat",
    gsub("^.*warm.*$", "Heat",
    stormDF$EVTYPE))))

  stormDF$EVTYPE <-
    gsub("^dust storm.*$", "Dust Storm",
    gsub("^blowing dust$", "Dust Storm",
    gsub("^.*waterspout.*$", "Waterspout",
    gsub("^.*dust devil.*$", "Dust Devil",
    stormDF$EVTYPE))))

  stormDF$EVTYPE <-
    gsub("^.*(frost|freeze).*$", "Frost/Freeze",
    stormDF$EVTYPE)

  stormDF$EVTYPE <-
    gsub("^ic(e|y).*$", "Winter Weather",
    gsub("^.*mix.*$", "Winter Weather",
    stormDF$EVTYPE))

stormDF$EVTYPE <-
  gsub("^snow.*$", "Winter Weather",
  gsub("^sleet$", "Winter Weather",
  gsub("^.*cold.*$", "Cold/Wind Chill",
  gsub("^low.*$", "Cold/Wind Chill",
  stormDF$EVTYPE))))

stormDF$EVTYPE <-
  gsub("^cold.*(.*|temperature|wave|winds|wind chill)$", "Cold/Wind Chill",
  gsub("^high.+cold$", "Cold/Wind Chill",
  gsub("^.*cold.*$", "Cold/Wind Chill",
  gsub("^low.*$", "Cold/Wind Chill",
  stormDF$EVTYPE))))

  stormDF$EVTYPE <-
    gsub("^(high|heavy|rough|hazardous).+surf.*$", "High Surf",
    gsub("^avalanc.*$", "Avalanche",
    gsub("^seiche$", "Seiche",
    gsub("^volcanic ash$", "Volcanic Ash",
    gsub("^astronomical low tide$", "Astronomical Low Tide",
    gsub("^black ice$", "Winter Weather",
    gsub("^excessive wetness$", "Winter Weather",
    gsub("^rainstorm$", "Heavy Rain",
    gsub("^heavy precipitation$", "Heavy Rain",
    gsub("^(dense|.*)fog$", "Dense Fog",
    gsub("^falling snow/ice$", "Winter Weather",
    stormDF$EVTYPE)))))))))))

  stormDF$EVTYPE <-
    gsub("^.*fire.*$", "Wildfire",
    gsub("^.*funnel.*$", "Funnel Cloud",
    gsub("^.*smoke$", "Dense Smoke",
    stormDF$EVTYPE)))
  if (CORRECTNESS) {
    print(paste0("stormDF ", dim(stormDF)))
    print(head(stormDF))
  }

  return (stormDF)
}


```

```{r processing}
## This is a "just in case block. It will retrieve the storm data file if 
## necessary

  if (!file.exists(STORM_DATA_FILE)) {
    retrieve = download.file(URL, STORM_DATA_FILE, mode = "wb")

    if (is.null(retrieve)) {
      print("ERROR: could not access ", url)
      stop()
    }
  }

```

<hr style="background : black; height : 15px"/>

### Baseline Data Frame

**Goal**

The goal for this function is to provide a baseline to analyze the impact of each transformation on the data frame. Since this code is useful as a baseline only, the people analyzing the data must have the option to turn it on or off.

**Why?**

The Baseline Data Frame is used to get the worst case data frame state as a baseline to compare other state change. One the goals for the project is to explain the purpose specific transformation used to convert the data in the **storm data file** to the answers required in the project description. An additional goal is to provide a "description and justification for any data transformations", so it is necessary to understand how the impact the data frame. This block gives a description of data before any transformations are made.

**How?**

The Baseline Data Frame is used only to get the worst case memory state, so the code is embedded in an if statement to so the entire computation is enclosed by an if statement. The if condition is true when both *CORRECTNESS* and *ALL_DATA* constants are TRUE. When the code executes, it reads the entire storm data file into a data frame and prints out the state data. Since the only point of this code block is to print the state of the data frame, it terminates once the statement is done.

#### Code

```{r}
# ==============================================================================
# stormDF stores the contents of the STORM_DATA_FILE to measure its state.
# The state of a data frame for the purposes of this analysis the state consists
# of :
# 1. The size of the data frame
# 2. The dimensions of the data frame
# 3. The number of unique event types--the STORM_DATA_FILE has more event types
#    then those allowed by the NWS Instruction.
# ==============================================================================

### TEST CODE ##################################################################
################################################################################
if (CORRECTNESS & ALL_DATA) {
  baselineDF <- read.table(STORM_DATA_FILE, sep = ",", header = TRUE)
}

print_empty_line(html=FALSE)
### baselineDF STATE ###########################################################
################################################################################
if (CORRECTNESS & ALL_DATA) {
  print("BASELINE Data Frame State")
  print(paste0("The data frame memory requirement is ", object.size(baselineDF)))
  print(paste0("The data frame dimensions are        ", dim(baselineDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(baselineDF$EVTYPE))))
  print(head(baselineDF, n = 10))

  # exit markdown
  knitr::knit_exit()
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div style="font-size : 14;">
<strong>Output Listing 0</strong> The baselineDF


datablock output is a print out of the memory required to store the data frame, the dimensions of the data frame, and the number of unique event types.
</p>

<pre>
## [1] "BASELINE Data Frame State"
## [1] "The data frame memory requirement is 494295216"
## [1] "The data frame dimensions are        902297"
## [2] "The data frame dimensions are        37"    
## [1] "Number of unique event names         985"

##    STATE__           BGN_DATE BGN_TIME TIME_ZONE COUNTY COUNTYNAME STATE
## 1        1  4/18/1950 0:00:00     0130       CST     97     MOBILE    AL
## 2        1  4/18/1950 0:00:00     0145       CST      3    BALDWIN    AL
## 3        1  2/20/1951 0:00:00     1600       CST     57    FAYETTE    AL
## 4        1   6/8/1951 0:00:00     0900       CST     89    MADISON    AL
## 5        1 11/15/1951 0:00:00     1500       CST     43    CULLMAN    AL
## 6        1 11/15/1951 0:00:00     2000       CST     77 LAUDERDALE    AL
## 7        1 11/16/1951 0:00:00     0100       CST      9     BLOUNT    AL
## 8        1  1/22/1952 0:00:00     0900       CST    123 TALLAPOOSA    AL
## 9        1  2/13/1952 0:00:00     2000       CST    125 TUSCALOOSA    AL
## 10       1  2/13/1952 0:00:00     2000       CST     57    FAYETTE    AL
## .        .       .       .          .         .      .        .        .
## .        .       .       .          .         .      .        .        .
## .        .       .       .          .         .      .        .        .
##     EVTYPE BGN_RANGE BGN_AZI BGN_LOCATI END_DATE END_TIME COUNTY_END COUNTYENDN
## 1  TORNADO         0     .       .          .        .             0         NA
## 2  TORNADO         0     .       .          .        .             0         NA
## 3  TORNADO         0     .       .          .        .             0         NA
## 4  TORNADO         0     .       .          .        .             0         NA
## 5  TORNADO         0     .       .          .        .             0         NA
## 6  TORNADO         0     .       .          .        .             0         NA
## 7  TORNADO         0     .       .          .        .             0         NA
## 8  TORNADO         0     .       .          .        .             0         NA
## 9  TORNADO         0     .       .          .        .             0         NA
## 10 TORNADO         0     .       .          .        .             0         NA
## .     .            .     .       .          .        .             .         .
## .     .            .     .       .          .        .             .         .
## .     .            .     .       .          .        .             .         .
##    END_RANGE END_AZI END_LOCATI LENGTH WIDTH F MAG FATALITIES INJURIES PROPDMG
## 1          0    .       .         14.0   100 3   0          0       15    25.0
## 2          0    .       .          2.0   150 2   0          0        0     2.5
## 3          0    .       .          0.1   123 2   0          0        2    25.0
## 4          0    .       .          0.0   100 2   0          0        2     2.5
## 5          0    .       .          0.0   150 2   0          0        2     2.5
## 6          0    .       .          1.5   177 2   0          0        6     2.5
## 7          0    .       .          1.5    33 2   0          0        1     2.5
## 8          0    .       .          0.0    33 1   0          0        0     2.5
## 9          0    .       .          3.3   100 3   0          1       14    25.0
## 10         0    .       .          2.3   100 3   0          0        0    25.0
## .          .    .       .          .         .      .        .        .     .
## .          .    .       .          .         .      .        .        .     .
## .          .    .       .          .         .      .        .        .     .
##    PROPDMGEXP CROPDMG CROPDMGEXP WFO STATEOFFIC ZONENAMES LATITUDE LONGITUDE
## 1           K       0      .            .         .           3040      8812
## 2           K       0      .            .         .           3042      8755
## 3           K       0      .            .         .           3340      8742
## 4           K       0      .            .         .           3458      8626
## 5           K       0      .            .         .           3412      8642
## 6           K       0      .            .         .           3450      8748
## 7           K       0      .            .         .           3405      8631
## 8           K       0      .            .         .           3255      8558
## 9           K       0      .            .         .           3334      8740
## 10          K       0      .            .         .           3336      8738
## .           .       .      .            .         .             .         .
## .           .       .      .            .         .             .         .
## .           .       .      .            .         .             .         .
##    LATITUDE_E LONGITUDE_ REMARKS REFNUM
## 1        3051       8806              1
## 2           0          0              2
## 3           0          0              3
## 4           0          0              4
## 5           0          0              5
## 6           0          0              6
## 7           0          0              7
## 8           0          0              8
## 9        3336       8738              9
## 10       3337       8737             10
## .          .          .               .
## .          .          .               .
## .          .          .               .


</pre>
</div>
```

<hr style="background : black; height : 2px"/>

#### Initial State

-   Reading the complete file requires roughly 500 MB to store the data frame.
-   The data frame has dimensions 902297 rows by 37 columns.
-   There were 985 distinct event types at this point.

NOTE: the NWS Instructions identify 48 specific event types, the 985 distinct event types in the **storm data file** are almost a factor of 20 more than it should be.

<hr style="background : black; height : 15px"/>

## Data Transformations

### Transformation 1

#### Reading Data File

**Goal**

The goal of this Transformation 1 is to read the data required to perform the analysis.

**Why?**

The source file contains more data than what is needed for this project. By selecting the only the required columns, the *stormDF* will have all of the data it requires and nothing more.

The required columns are *EVTYPE*, *BGN_DATE*, *FATALITIES*, *INJURIES*, *PROPDMG*, *PROPDMGEXP*, *CROPDMG*, and *CROPDMGEXP*.

The *BGN_DATE* is required to filter out dates before 1/1/1996 to ensure the data used for the analysis contains all of the necessary rows.

**How?**

Transformation 1 reads the storm data file selecting the required columns using the colClasses argument and storing it in *stormDF*. It will then filter the *stormDF* by date. The last step is to drop *BGN_DATE* because it is no longer needed.

#### Code

```{r transformation1}
### TRANSFORMATION CODE ########################################################
################################################################################
stormDF <- read.table(
  STORM_DATA_FILE, stringsAsFactors = FALSE, sep = ",", colClasses = 
    c("NULL", NA, rep("NULL",5), NA, rep("NULL",14),
      rep(NA, 6), rep("NULL",9)), header = TRUE)

# convert the date string to an EPOCH time
stormDF$DAY <- as.numeric(as.POSIXct(
  as.Date(stormDF$BGN_DATE, format = "%m/%d/%Y %H:%M:%S")))

# drop lines less than EPOCH times greater than 694224000 (1/1/1996) 
stormDF <- stormDF[stormDF$DAY > 694224000,] %>% 
  select(EVTYPE, FATALITIES, INJURIES, FATALITIES,
         PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP)

print_empty_line(html=FALSE)
### TRANSFORMATION STATE CHANGES ###############################################
################################################################################
if (CORRECTNESS) {
  print("Transformation 1 State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}
```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}

<div style="font-size : 14;">

<strong>Output Listing 1:</strong> The Transform 1 block output shows the full data frame is 902297 by 7, it requires 51 MB of memory, and there are 985 different event types.

<pre>
## [1] "Transformation 1 State"
## [1] "The data frame memory requirement is 43769664"
## [1] "The data frame dimensions are        728272"
## [2] "The data frame dimensions are        7"     
## [1] "Number of unique event names         985"

##         EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5097 TSTM WIND          0        0       0          .       0          .
## 5098 TSTM WIND          0        0       0          .       0          .
## 5099 TSTM WIND          0        0       0          .       0          .
## 5100 TSTM WIND          0        0       0          .       0          .
## 5101 TSTM WIND          0        0       0          .       0          .
## 5102 TSTM WIND          0        0       0          .       0          .
## 5103 TSTM WIND          0        0       0          .       0          .
## 5104 TSTM WIND          0        0       0          .       0          .
## 5105 TSTM WIND          0        0       0          .       0          .
## 5106 TSTM WIND          0        0       0          .       0          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
      
</pre>
</div>
```

<hr style="background : black; height : 2px"/>

#### State Changes

The change in data frame state from the Complete Data Frame through the execution of Transformation 1 is shown in Table 1.

```{=html}
<br/>
<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<caption><strong>Table 1.</strong> Data Frame State Changes Due to Transformation 1 </caption>

<table style="width : 100%; margin-left: auto; margin-right: auto;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;"> 494,295,216</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">  43,769,664</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-450,525,552</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">  902297</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">  728272</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;"> -174025</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">37</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-30</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">985</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">985</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

</table>

</div>
<!-- <strong>Table 1. The ordered tables answer the required questions. One table shows the NWS Instruction event type names ordered by the highest to lowest casualties. The other table shows the NWS Instruction event type names ordered by the most to least costly.</strong> -->

<br/><br/>
```

-   The reduction in the required memory size, roughly 450 MB.
-   The number of rows was reduced by 174,025.
-   The number of columns  was reduced by 30.
-   The the number of event types was unchanges.

<hr style="background : black; height : 15px"/>

### Transformation 2

#### Remove NC Rows

**Goal**

The goal of Transformation 2 is to remove non-contributing (NC) rows. The values in these rows do not contribute to the analysis.

**Why?**

The data frame will, at some point be grouped event type subsets. These subsets will need the sum of the *FATALITIES*, *INJURIES*, *PROPDMG*, and *CROPDMG*. However, for some data points these values are all zero, in which case, they do not contribute to the sums. The non-contributing data points have no use for the analysis, so they are dropped.

**How?**

The data is copied from *stormDF* to *stormDF* excluding the non-contributing points.

NOTE: a side effect of this transformaion is several irrelevant data points are dropped from the data frame.

#### Code

```{r remove NC}
# TEST CODE ====================================================================
# To ensure Transformation 2 is correct, the code must include two sets of test 
# code. The first showing the data frame state before executing the 
# transformation, and the second executed after.
# 
# An exhaustive testing of this would be time consuming and confusing, so three 
# event types were selected to demonstrate the correctness of the 
# transformation. The types are:
#
#  1. "HAIL" - this type is one of the NWS Instruction storm types. There are 
#              instances of contributing and non-contributing "Hail" events.
#              Counting the instances of both contributing and non-contributing
#              events will before and after the transformation should show all 
#              of the non-contributing events are gone and all of the 
#              contributing events remain.
# 
#  2. "?"    - this type is not one of the NWS Instruction storm types, however
#              there instances of contributing instances, but no instances of
#              non-contributing instances. The values before and after the 
#              execution of the transformation should not change. 
# 
# 2. "Summary: Nov. 16"    
#            - this type is not one of the NWS Instruction storm types, however
#              there several instances of this type in the storm data file, all
#              of which are non-contributing. The values before will show the 
#              number of instances of the type, and after there should be no 
#              instances of the type. 
# ==============================================================================

print_empty_line(html=FALSE)
### TEST CODE ##################################################################
### The initial code test checks for three event types, one valid event type 
### with multiple instances and at least one of those instances is 
### non-contributing. The second event type is not an NWS Instruction event 
### type, but it is contributing. The third event type is invalid and 
### non-contributing.
################################################################################
if (CORRECTNESS) {
  print("START TEST: before Transformation 2")

  # 'HAIL' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'HAIL',])
  contributingRows <- 
    nrow(stormDF[stormDF$EVTYPE == 'HAIL' & stormDF$FATALITIES == 0 & 
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 & 
               stormDF$CROPDMG == 0 ,])
  
  print(paste0("total \'HAIL\' events before ", totalRows))
  print(paste0("non-contributing \'HAIL\' events before ", contributingRows))
  print(paste0("contributing \'HAIL\' events before ", 
               totalRows - contributingRows))
  print_empty_line(html=FALSE)
  
  # '?' events --------------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == '?',])
        
  contributingRows <- 
    nrow(stormDF[stormDF$EVTYPE == '?' & stormDF$FATALITIES == 0 & 
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 & 
               stormDF$CROPDMG == 0 ,])
  
  print(paste0("total \'?\' events before ", totalRows))
  print(paste0("non-contributing \'?\' events before ", contributingRows))
  print(paste0("contributing \'?\' events before ", 
               totalRows - contributingRows))
  
  # 'Summary: Nov. 16' events -----------------------

  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16',])
        
  contributingRows <- 
    nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16' & 
                    stormDF$FATALITIES == 0 & stormDF$INJURIES == 0 & 
                    stormDF$PROPDMG == 0 & stormDF$CROPDMG == 0 ,])
  
  print(paste0("total \'Summary: Nov. 16\' events before ", totalRows))
  print(paste0("non-contributing \'Summary: Nov. 16\' events before ", contributingRows))
  print(paste0("contributing \'Summary: Nov. 16\' events before ", 
               totalRows - contributingRows))
  print("END TEST: before Transformation 2")
} 

print_empty_line(html=FALSE)
### TRANSFORMATION CODE ########################################################
### Transformation 2 copy all events where at least one of FATALITIES, INJURIES,
### PROPDMG, or CROPDMG has a non-zero value. Later in the analysis, the subsets 
### of each valid entry will be summed. If all of these parameters have zero 
### values, they will not contribute to the sum. In other words, they are just 
### wasting time and resources, so the code gets rid of them.
################################################################################
stormDF <- stormDF[stormDF$FATALITIES != 0 | stormDF$INJURIES != 0 |
                     stormDF$PROPDMG != 0 | stormDF$CROPDMG != 0, ]

print_empty_line(html=FALSE)
### TEST CODE ##################################################################
### The final code test repeats the earlier checks for the three event types.
################################################################################
if (CORRECTNESS) {
  print("START TEST: after Transformation 2")

  # 'HAIL' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'HAIL',])

  contributingRows <- 
    nrow(stormDF[stormDF$EVTYPE == 'HAIL' & stormDF$FATALITIES == 0 & 
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 & 
               stormDF$CROPDMG == 0 ,])
  
  print(paste0("total \'HAIL\' events after ", totalRows))
  print(paste0("non-contributing \'HAIL\' events after ", contributingRows))
  print(paste0("contributing \'HAIL\' events after ", 
               totalRows - contributingRows))

  # '?' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == '?',])
        
  contributingRows <- 
    nrow(stormDF[stormDF$EVTYPE == '?' & stormDF$FATALITIES == 0 & 
               stormDF$INJURIES == 0 & stormDF$PROPDMG == 0 & 
               stormDF$CROPDMG == 0 ,])
  
  print(paste0("total \'?\' events after ", totalRows))
  print(paste0("non-contributing \'?\' events after ", contributingRows))
  print(paste0("contributing \'?\' events after ", 
               totalRows - contributingRows))

  # 'Summary: Nov. 16' events -----------------------------------
  totalRows <- nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16',])
        
  contributingRows <- 
    nrow(stormDF[stormDF$EVTYPE == 'Summary: Nov. 16' & 
                    stormDF$FATALITIES == 0 & stormDF$INJURIES == 0 & 
                    stormDF$PROPDMG == 0 & stormDF$CROPDMG == 0 ,])
  
  print(paste0("total \'Summary: Nov. 16\' events after ", totalRows))
  print(paste0("non-contributing \'Summary: Nov. 16\' events after ", 
               contributingRows))
  print(paste0("contributing \'Summary: Nov. 16\' events after ", 
               totalRows - contributingRows))
  print("END TEST: after Transformation 2")
}

print_empty_line(html=FALSE)
################################################################################
### END OF TRANSFORMATION STATE CHANGES
################################################################################
if (CORRECTNESS) {
  print("Transformation 2 State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<div style="font-size : 14;">
<strong>Output Listing 2a:</strong>
Before the execution of Transformation 2, the <em>stormDF</em> contains several non-contributing values. To demonstrate the transformation eliminated these values the test code focuses on three type names: 'HAIL', '?', and 'Summary: Nov. 16'. This first test show the number of contributing and non-contributing value for these types.

<pre>
## [1] "START TEST: before Transformation 2"
## 
## [1] "total 'HAIL' events before 232516"
## [1] "non-contributing 'HAIL' events before 206446"
## [1] "contributing 'HAIL' events before 26070"
## 
## [1] "total '?' events before 1"
## [1] "non-contributing '?' events before 0"
## [1] "contributing '?' events before 1"
## 
## [1] "total 'Summary: Nov. 16' events before 2"
## [1] "non-contributing 'Summary: Nov. 16' events before 2"
## [1] "contributing 'Summary: Nov. 16' events before 0"
## [1] "END TEST: before Transformation 2"
</pre>
<br/>

<strong>Output Listing 2b:</strong>After the execution of Transformation 2, the output shows the what has happened to the data frame. 

<br/>
<pre>
## [1] "START TEST: after Transformation 2"
## 
## [1] "total 'HAIL' events after 26070"
## [1] "non-contributing 'HAIL' events after 0"
## [1] "contributing 'HAIL' events after 26070"
## 
## [1] "total '?' events after 1"
## [1] "non-contributing '?' events after 0"
## [1] "contributing '?' events after 1"
## 
## [1] "total 'Summary: Nov. 16' events after 0"
## [1] "non-contributing 'Summary: Nov. 16' events after 0"
## [1] "contributing 'Summary: Nov. 16' events after 0"
## [1] "END TEST: after Transformation 2"
</pre>
<br/>

<strong>Output Listing 2c:</strong> Is the state of the data frame after executing the transformation.

<pre>
## [1] "Transformation 1 State"
## [1] "The data frame memory requirement is 13731856"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        7"     
## [1] "Number of unique event names         488"
##         EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5107   TORNADO          0        1     2.5          M       0          .
## 5108 TSTM WIND          1        1     0.0                  0          .
## 5129   TORNADO          0        0   250.0          K       0          .
## 5130   TORNADO          2        7   250.0          K       0          .
## 5135 TSTM WIND          0        7     0.0                  0          .
## 5163   TORNADO          0        0    25.0          K       0          .
## 5246 TSTM WIND          0        1     0.0                  0          .
## 5252 TSTM WIND          1        1     0.0                  0          .
## 5312   TORNADO          0        0    25.0          K       0          .
## 5315   TORNADO          0        2   250.0          K       0          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .

</pre>
<br/>
```

<hr style="background : black; height : 2px"/>

#### Test result

The output of the tests show exactly what was expected (see Table 2). All of the data in the data frame have numerical contributions to the results.

```{=html}
<br/>
<strong>Table 2.</strong> The changes caused by transformation 2 shows the non-contributing data points have been dropped from the data frame and all contributing data points are maintained, regardless of their type names.
<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<!-- TABLE SET UP -->
<table style="width : 75%; border: 2px solid black;">
<tr>
<th style="width : 25%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px; border: 2px solid black;">Type</th>
<th style="width : 20%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px; border: 2px solid black;">Contributor</th>
<th style="width : 15%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px; border: 2px solid black;">Before T2</th>
<th style="width : 15%; text-align: center; vertical-align : top; border: 1px solid;padding: 10px;">After T2</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>Hail</td>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;">non-contributing</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">206446</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;">contributing</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 5px; border: 2px solid black;">26070</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 5px; border: 2px solid black;">26070</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>?</td>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;">non-contributing</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;">contributing</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>Summary: Nov. 16</td>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;">non-contributing</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left;  border: 1px solid; padding: 5px; border: 2px solid black;">contributing</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
<td style="vertical-align : top; text-align: right;  border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

</table>
</div>
<br/><br/>
```

The 'HAIL' event type had over 200,000 non-contributing rows before the transformation and none afterwards. This means all of the non-contributing 'HAIL' rows are gone. On the other hand, there were 26070 contributing rows of 'HAIL' before and after the transformation. This suggests the transformation dropped all non-contributing rows while keeping all of the contributing rows. This is the desired effect.

The '?' event type had no non-contributing rows before and after the transformation, and the contributing rows had one row before and afterwards. Even though '?' is not a valid NWS event type name, the transformation did not eliminate it because the number of contributing rows did not change.

The 'Summary: Nov. 16' event type had two contributing rows before and none after the transformation. This means the rows were dropped and since there were no contributing rows before or after the transformation, all rows involving this event type are dropped from the data frame. As a result, the 'Summary: Nov. 16' there are no occurances of this event type in *stormDF*.

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<br/>
<strong>Table 3.</strong> Data Frame State Changes Due to Transformation 2

<br/>
<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<caption><strong>Table 3.</strong> Data Frame State Changes Due to Transformation 1 </caption>

<table style="width : 100%; ">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">43,769,664</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">13,731,856</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">-30,037,808</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">  728272</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black; padding: 5px; border: 2px solid black;">  228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;"> -500025</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">985</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">488</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-497</td>
</tr>

</table>

</div>

<br/><br/>
```


-   The reduction in the required memory size, roughly 30 MB.
-   The number of rows was reduced by 500,025 row.
-   The number of columns is unchanged.
-   The reduction in the number of event types is 497

The loss of over 500,000 rows suggests the *stormDF* was dominated by events with no notable damage to live or to the economy. The loss of 497 event types is a positive step forward given the number of events should be 48 but it also implies there are several more invalid event types in the data frame. 

<hr style="background : black; height : 15px"/>

### Transformation 3
#### Clean strings

**Goal**

The goal is to change the string names to simplify comparisons that will have to be done to convert the data collectors names to NWS names.

**Why?**

This transformation is necessary for two reasons.

1.  whitespace at the beginning and ending of a string are included in string comparisons. The type names "*DUST*" and " *DUST*" are two different strings because of the extra space in front of the second string.
2.  the data collectors did not use consistent spelling or capitalization. Type names like *Black Ice* match the NWS naming convention, but *BLACK ICE* does not.

**How?**

Each column of the *stormDF* with strings (*EVTYPE*, *PROPDMGEXP*, and *CROPDMGEXP*) are "trimmed" by removing whitespace in the beginning and ending of the string. After trimming the whitespace, all of these strings are then converted all to lower case letters.

#### Code

```{r uniform names}

### TEST CODE ##################################################################
# To ensure Transformation 3 is correct, the test code includes two sets of 
# instructions. The first set counts instances of ' FLASH FLOOD' and 'FLASH 
# FLOOD'. The string ' FLASH FLOOD' is both upper case and includes a leading 
# space. The string 'FLASH FLOOD' is also in upper case but it has no leading
# or trailing edge whitespaces. In both cases, the transformation will change
# the strings to 'flash flood'.
################################################################################

print_empty_line(html=FALSE)
### TEST CODE ##################################################################
### The initial code test checks for three event types, one valid event type 
### with multiple instances and at least one of those instances is 
### non-contributing. The second event type is not an NWS Instruction event 
### type, but it is contributing. The third event type is invalid and 
### non-contributing.
################################################################################
if (CORRECTNESS) {
  print("START TEST: before Transformation 3")

  test <- stormDF[stormDF$EVTYPE == ' FLASH FLOOD' ,]
  print(paste0("number of total \' FLASH FLOOD\' events before ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'FLASH FLOOD' ,]
  print(paste0("number of total \'FLASH FLOOD\' events before ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == ' flash flood' ,]
  print(paste0("number of total \' flash flood\' events before ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'flash flood' ,]
  print(paste0("number of total \'flash flood\' events before ", nrow(test)))

  print("END TEST: before Transformation 3")
}

print_empty_line(html=FALSE)
### TRANSFORMATION CODE ########################################################
### Transformation code will trim the leading and trailing whitespaces from 
### every string in stormDF$EVTYPE, stormDF$PROPDMGEXP, and source$CROPDMGEXP. 
### It will then change all those strings to lower case.
################################################################################
stormDF$EVTYPE     <- trimws(stormDF$EVTYPE, which = c("both"))
stormDF$PROPDMGEXP <- trimws(stormDF$PROPDMGEXP, which = c("both"))
stormDF$CROPDMGEXP <- trimws(stormDF$CROPDMGEXP, which = c("both"))
stormDF$EVTYPE     <- tolower(stormDF$EVTYPE)
stormDF$PROPDMGEXP <- tolower(stormDF$PROPDMGEXP)
stormDF$CROPDMGEXP <- tolower(stormDF$CROPDMGEXP)

print_empty_line(html=FALSE)
### TEST CODE ##################################################################
### The initial code test checks for three event types, one valid event type 
### with multiple instances and at least one of those instances is 
### non-contributing. The second event type is not an NWS Instruction event 
### type, but it is contributing. The third event type is invalid and 
### non-contributing.
################################################################################
# TEST CODE ====================================================================
# This test will check for four variations of 'FLASH FLOOD'. Specifically, it 
# will check for the existence of 
# 1. ' FLASH FLOOD' one of the original strings
# 2. 'FLASH FLOOD' the other original strings and the expected value if the 
#     to lower function failed.
# 3. ' flash flood' the expected value if the trim function failed
# 4. ' flash flood' the expected value if if every thing works
# 
# ==============================================================================
if (CORRECTNESS) {
  print("START TEST: after Transformation 3")

  test <- stormDF[stormDF$EVTYPE == ' FLASH FLOOD' ,]
  print(paste0("number of total \' FLASH FLOOD\' events after ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'FLASH FLOOD' ,]
  print(paste0("number of total \'FLASH FLOOD\' events after ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == ' flash flood' ,]
  print(paste0("number of total \' flash flood\' events after ", nrow(test)))

  test <- stormDF[stormDF$EVTYPE == 'flash flood' ,]
  print(paste0("number of total \'flash flood\' events after ", nrow(test)))

  print("END TEST: before Transformation 3")
}

print_empty_line(html=FALSE)
### TRANSFORMATION STATE CHANGES ###############################################
################################################################################
if (CORRECTNESS) {
  print("Transformation 3 State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<strong>Output Listing 3a:</strong> Before the execution of Transformation 3, the code executes an searches for the string " FLASH FLOOD" in the <em>stormDF$EVTYPE</em> column. The output shows the string was found. The string is not a valid name because of the leading space. The correct name is "FLASH FLOOD".

<pre>
## [1] "START TEST: before Transformation 3"
## [1] "number of total ' FLASH FLOOD' events before 1"
## [1] "number of total 'FLASH FLOOD' events before 20967"
## [1] "number of total 'flash flood' events before 0"
## [1] "END TEST: before Transformation 3"
</pre>

<strong>Output Listing 3b:</strong> After the execution of Transformation 3, the listing shows the <em>EVTYPE</em>, <em>PROPDMGEXP</em>, and <em>CROPDMGEXP</em> have been converted to strings with all lower case letters.

<pre>
## [1] "START TEST: after Transformation 3"
## [1] "number of total ' FLASH FLOOD' events before 0"
## [1] "number of total 'FLASH FLOOD' events before 0"
## [1] "number of total ' flash flood' events before 0"
## [1] "number of total 'flash flood' events before 20968"
## [1] "END TEST: before Transformation 3"
</pre>


<strong>Output Listing 3c:</strong> In addition to the change in letters, it searched for " FLASH FLOOD", "FLASH FLOOD", " flash flood", and "flash flood". All of the names with the exception of "flash flood" were not found. Since the whitespaces were trimmed and all of the characters were changed to lower case letters, this makes sense.

<pre>
## [1] "Transformation 3 State"
## [1] "The data frame memory requirement is 13728752"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        7"     
## [1] "Number of unique event names         444"
##         EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5107   tornado          0        1     2.5          m       0          .
## 5108 tstm wind          1        1     0.0                  0          .
## 5129   tornado          0        0   250.0          k       0          .
## 5130   tornado          2        7   250.0          k       0          .
## 5135 tstm wind          0        7     0.0                  0          .
## 5163   tornado          0        0    25.0          k       0          .
## 5246 tstm wind          0        1     0.0                  0          .
## 5252 tstm wind          1        1     0.0                  0          .
## 5312   tornado          0        0    25.0          k       0          .
## 5315   tornado          0        2   250.0          k       0          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
##    .         .          .        .       .          .       .          .
</pre>

</div>
```

<hr style="background : black; height : 2px"/>

#### Test result

```{=html}
<br/>
<strong>Table 4.</strong> .

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">
<table style="width : 100%; ">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Type Name</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count Before</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count After</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">' FLASH FLOOD'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'FLASH FLOOD'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">20967</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">' flash flood'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'flash flood'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">20968</td>
</tr>
</table>
</div>
<br/><br/>
```

Before the transformation, there were 20967 "FLASH FLOOD" strings and one " FLASH FLOOD" string. There were zero strings with "flash flood" and " flash flood". So before the flood there were 20968 rows with either "FLASH FLOOD" or " FLASH FLOOD".   After the transformation, all the strings had zero rows with "FLASH FLOOD", " FLASH FLOOD", or " flash flood" except for "flash flood". The total number with "flash flood" was in 20968 rows which is the same number of rows before transformation. This means all of the rows with a variation of "FLASH FLOOD" were converted to "flash flood". This is the goal of the transformation.

<hr style="background : black; height : 2px"/>

#### State Changes

The change in data frame state from Transformation 2 to Transformation 3 is shown in Table 5.

```{=html}
<br/>
<strong>Table 5.</strong> Data Frame State Changes Due to Transformation 3

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<table style="width : 100%;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13,731,856</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-3104</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">488</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">444</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-44</td>
</tr>
</table>

</div>

<br/><br/>
```

-   The reduction in the required memory size, roughly 3 kB.
-   The number of rows is unchanged
-   The number of columns is unchanged.
-   The reduction in the number of event types is 44

The changes to the data frame are insignificant, however the reduction in the number of event type names is expected. However, the number of event types dropped by 44 which suggests there were several strings with spaces at the front or the back and several names with incorrect letter cases. 

The number of event type names is well over 444, so there must be more issues with type names.

<hr style="background : black; height : 15px"/>

### Transformation 4

#### Fix invalid names

**Goal**

Ensure any of the remaining events, with no apparent relationship to the NWS event types, are accounted for.

**Why?**

Some of the data collector type names have no apparent relationship to the NWS names. For example, the names, **?**, **apache county**, and **high** do not approximate the any name in the NWS type naming convention. If they were removed from the data frame, subsequent calculations would lose the impact of these data points. So transformation 4 has to account remove these event and still account for them.

**How?**

The transformation uses "gsub" functions to compare each *EVTYPE* name in *stormDF* to the invalid type names. If a type name matches an invalid names, the event type is replaced with the word **Other**.

NOTE: 'Other' is not a valid name, but it is used to account for the values of invalid names.

#### Code

```{r invalid names}
print_empty_line(html=FALSE)
### TEST CODE ##################################################################
### The initial test for Transformation 4 prints the number of rows containing
### each invalid event type including "Other".
################################################################################
if (CORRECTNESS) {
  print("START TEST: before Transformation 3")
  print(paste0("?                ", length(which(stormDF$EVTYPE == "?"))))
  print(paste0("high             ", length(which(stormDF$EVTYPE == "high"))))
  print(paste0("marine accident  ", 
               length(which(stormDF$EVTYPE == "marine accident"))))
  print(paste0("marine mishap    ", 
               length(which(stormDF$EVTYPE == "marine mishap"))))
  print(paste0("other            ", length(which(stormDF$EVTYPE == "other"))))
  print(paste0("apache county    ", 
               length(which(stormDF$EVTYPE == "apache county"))))
  print(paste0("Other            ", length(which(stormDF$EVTYPE == "Other"))))
  print("END TEST: before Transformation 2")
} 

print_empty_line(html=FALSE)
### TRANSFORMATION CODE ########################################################
### Transformation code will change every EVTYPE mathching an invalid type to 
### 'Other'.
################################################################################
stormDF$EVTYPE <-
  gsub("\\?", "Other",
  gsub("^high$", "Other",
  gsub("^marine accident$", "Other",
  gsub("^marine mishap$", "Other",
  gsub("^other$", "Other",
  gsub("^apache county$", "Other",
  stormDF$EVTYPE))))))

print_empty_line(html=FALSE)
### TEST CODE ##################################################################
### The final test for Transformation 4 repeats the initial test. A successful
### will drop all of the invalid event types except for 'Other'. The number of 
### rows with 'Other' will be the same as the sum of all the invalid rows. This
### shows that all invalid types were converted to 'Other'.
################################################################################
if (CORRECTNESS) {
  print("START TEST: after Transformation 4")
  print(paste0("?                ", length(which(stormDF$EVTYPE == "?"))))
  print(paste0("high             ", length(which(stormDF$EVTYPE == "high"))))
  print(paste0("marine accident  ", 
               length(which(stormDF$EVTYPE == "marine accident"))))
  print(paste0("marine mishap    ", 
               length(which(stormDF$EVTYPE == "marine mishap"))))
  print(paste0("other            ", length(which(stormDF$EVTYPE == "other"))))
  print(paste0("apache county    ", 
               length(which(stormDF$EVTYPE == "apache county"))))
  print(paste0("Other            ", length(which(stormDF$EVTYPE == "Other"))))
  print("END TEST: after Transformation 4")
}

print_empty_line(html=FALSE)
################################################################################
### TRANSFORMATION STATE CHANGES
################################################################################
if (CORRECTNESS) {
  print("Transformation 4 State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))

}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<strong>Output Listing 4a:</strong> Before executing Transformation 4, the transform counts the number of rows with invalid event names. The results show there are 40 rows with invalid names, and "Other" has no occurances.</em>.

<div style="font-size : 14;">
<pre>
## [1] "START TEST: before Transformation 4"
## [1] "?                1"
## [1] "high             1"
## [1] "marine accident  1"
## [1] "marine mishap    2"
## [1] "other            34"
## [1] "apache county    1"
## [1] "Other            0"
## [1] "END TEST: before Transformation 4"
</pre>

<strong>Output Listing 4b:</strong> After the transformation there are no invalid names in stormDF, except for 'Other'. There are 40 rows with the 'Other' event, so all of the invalid names were converted to 'Other'.

<br/>
<strong>Table 6.</strong> .

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">
<table style="width : 100%; ">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Type Name</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count Before</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count After</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'?'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'high'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'marine accident'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'marine mishap'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'other'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">34</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'apache county'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'Other'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">40</td>
</tr>

</table>
</div>
<br/><br/>
```

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<br/>
<strong>Table 7.</strong> Data Frame State Changes Due to Transformation 2

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<table style="width : 100%;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13,728,448</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-304</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">444</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">439</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-5</td>
</tr>
</table>

</div>

<br/><br/>
```

-   The reduction in the required memory size, roughly 300 B.
-   The number of rows is unchanged
-   The number of columns is unchanged.
-   The reduction in the number of event types is 5

The changes to the data frame are insignificant, however the reduction in the number of unique event names is indicative of the problems with inconsistent nameing. This problem will become more apparent in the following transformations.

<hr style="background : black; height : 15px"/>

### Transformation 5

#### Unify Event Types

**Goal**

The goal of Transformation 5 is to change all valid types to their valid NWS event type names.

**Why?**

The data collectors used idiosyncratic names for weather events. For example, the NWS event "Thunderstorm Wind" was reported as the following

```{=html}
<div style="font-size : 8px; font-weight: bold;">

<!-- Thunder storm events -->

THUDERSTORM WINDS, THUNDEERSTORM WINDS, THUNDERESTORM WINDS, THUNDERSTORM, THUNDERSTORM WINDS, Thunderstorm Wind, THUNDERSTORM WIND, THUNDERSTORM WIND (G40), THUNDERSTORM WIND 50, THUNDERSTORM WIND 52, THUNDERSTORM WIND 56, THUNDERSTORM WIND 59, THUNDERSTORM WIND 59 MPH, THUNDERSTORM WIND 59 MPH., THUNDERSTORM WIND 60 MPH,THUNDERSTORM WIND 65 MPH, THUNDERSTORM WIND 65MPH, THUNDERSTORM WIND 69, THUNDERSTORM WIND 98 MPH, THUNDERSTORM, THUNDERSTORM WIND G55, THUNDERSTORM WIND G60, THUNDERSTORM WIND G61, THUNDERSTORM WIND TREES, THUNDERSTORM WIND. THUNDERSTORM WIND/ TREE, THUNDERSTORM WIND/ TREES, THUNDERSTORM WIND/AWNING, THUNDERSTORM WINDS, THUNDERSTORM WINDS, THUNDERSTORM WINDS 13, THUNDERSTORM WINDS 2, THUNDERSTORM WINDS 50, THUNDERSTORM WINDS 52, THUNDERSTORM WINDS 53, THUNDERSTORM WINDS 60, THUNDERSTORM WINDS 61, THUNDERSTORM WINDS 62, THUNDERSTORM WINDS 63 MPH, THUNDERSTORM WINDS G, THUNDERSTORMWINDS G60, THUNDERSTORM WINDS., THUNDERSTORM WINDS53, THUNDERSTORMS WIND, THUNDERSTORMS WINDS, THUNDERSTORMW, THUNDERSTORMW 50, THUNDERSTORMW WINDS, THUNDERSTORMWINDS, THUNDERSTROM WIND, THUNDERSTROM WINDS, THUNDERTORM WINDS, THUNDERTSORM WIND, THUNDESTORM WINDS, THUNERSTORM WINDS, TSTM, TSTM WIND, Tstm Wind, TSTM WIND, TSTM WIND (G45), TSTM WIND (41), TSTM WIND (G35), TSTM WIND (G40), TSTM WIND (G45), TSTM WIND (G45), TSTM WIND 40, TSTM WIND 45, TSTM WIND 50, TSTM WIND 51, TSTM WIND 52, TSTM WIND 55, TSTM WIND 65), TSTM WIND DAMAGE, TSTM WIND G45, TSTM WIND G58, TSTM WINDS, TSTM WND, TSTMW

  </div> 
  
```

The data collectors used 78 different type names for one NWS event type name. This means this document will report 78 different events for "Thunderstorm Wind", so the correct number of casualties and economic losses will be incorrectly reported. To correct this problem, every reported type name has to be rewritten (unified) with the correct NWS event type name.

**How?**

To deal with this problem, the 444 unique event type names were categorized by their corresponding NWS event types names. A list of regular expressions were developed to identify these names and was subsequently coded as a series of gsub statements. These statements can be found in the **UnifyNames** function described earlier in the **Processing Code** section.

This means all 78 versions of 'THUDERSTORM WIND' are converted into a single event type, 'Thunderstorm Wind', as are other misspelled and misnamed event types.

<hr style="background : black; height : 15px"/>

#### Code

```{r unify}

### TEST CODE ##################################################################
### The initial code test counts the number of rows with a subset of the 
### 'thuderstorm wind' variations. These include, "thuderstorm winds", 
### "thundeerstorm winds", "thunderestorm winds", "thunderstorm",  "thunderstorm 
### winds ", and "thunderstorm wind". All of these event types should be dropped
### from stormDF after the transformation.
################################################################################
if (CORRECTNESS) {
  print("START TEST: before Transformation 5")
  print(paste0("thuderstorm winds   ", 
               length(which(stormDF$EVTYPE == "thuderstorm winds"))))
  print(paste0("thundeerstorm winds ", 
               length(which(stormDF$EVTYPE == "thundeerstorm winds"))))
  print(paste0("thunderestorm winds ", 
               length(which(stormDF$EVTYPE == "thunderestorm winds"))))
  print(paste0("thunderstorm        ", 
               length(which(stormDF$EVTYPE == "thunderstorm"))))
  print(paste0("thunderstorm winds  ", 
               length(which(stormDF$EVTYPE == "thunderstorm winds"))))
  print(paste0("thunderstorm wind   ", 
               length(which(stormDF$EVTYPE == "thunderstorm wind"))))
  print("END TEST: before Transformation 5")
}

print_empty_line(html=FALSE)
### TRANSFORMATION CODE ########################################################
### Transformation code is long, repetitious and frankly boring to read. So the
### actual transformation code was put into the function UnifyNames. All this 
### transformation does is call that function. UnifyNames is found near the 
### beginning of the "Process Code" section.
################################################################################
stormDF    <- UnifyNames(stormDF)


print_empty_line(html=FALSE)
### TEST CODE ##################################################################
### The final code redoes the initial test, but it adds an additional check to 
### to verify the pre transformation name is not transformed into a "title" case
### version of the original.
################################################################################
if (CORRECTNESS) {
  print("START TEST: after Transformation 5")
  print(paste0("thuderstorm winds   ", 
               length(which(stormDF$EVTYPE == "thuderstorm winds"))))
  print(paste0("Thuderstorm Winds   ", 
               length(which(stormDF$EVTYPE == "Thuderstorm Winds"))))
  
  print(paste0("thundeerstorm winds ", 
               length(which(stormDF$EVTYPE == "thundeerstorm winds"))))
  print(paste0("Thundeerstorm Winds ", 
               length(which(stormDF$EVTYPE == "Thundeerstorm Winds"))))
  
  print(paste0("thunderestorm winds ", 
               length(which(stormDF$EVTYPE == "thunderestorm winds"))))
  print(paste0("Thunderestorm Winds ", 
               length(which(stormDF$EVTYPE == "Thunderestorm Winds"))))
  
  print(paste0("thunderstorm        ", 
               length(which(stormDF$EVTYPE == "thunderstorm"))))
  print(paste0("Thunderstorm        ", 
               length(which(stormDF$EVTYPE == "Thunderstorm"))))

  print(paste0("thunderstorm winds  ", 
               length(which(stormDF$EVTYPE == "thunderstorm winds"))))
  print(paste0("Thunderstorm Winds  ", 
               length(which(stormDF$EVTYPE == "Thunderstorm Winds"))))

  print(paste0("thunderstorm wind   ", 
               length(which(stormDF$EVTYPE == "thunderstorm wind"))))
  print(paste0("Thunderstorm Wind   ", 
               length(which(stormDF$EVTYPE == "Thunderstorm Wind"))))
  print("END TEST: after Transformation 5")
}

print_empty_line(html=FALSE)
################################################################################
### TRANSFORMATION STATE CHANGES
################################################################################
if (CORRECTNESS) {
  print("Transformation 5 State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<strong>Output Listing 5: </strong>.

<div style="font-size : 14;">
<pre>
## [1] "START TEST: before Transformation 5"
## [1] "thuderstorm winds   1"
## [1] "thundeerstorm winds 1"
## [1] "thunderestorm winds 1"
## [1] "thunderstorm        19"
## [1] "thunderstorm winds  12086"
## [1] "thunderstorm wind   43655"
## [1] "END TEST: before Transformation 5"</pre>
</pre>

<pre>
## [1] "START TEST: after Transformation 5"
## [1] "thuderstorm winds   0"
## [1] "Thuderstorm Winds   0"
## [1] "thundeerstorm winds 0"
## [1] "Thundeerstorm Winds 0"
## [1] "thunderestorm winds 0"
## [1] "Thunderestorm Winds 0"
## [1] "thunderstorm        0"
## [1] "Thunderstorm        0"
## [1] "thunderstorm winds  0"
## [1] "Thunderstorm Winds  0"
## [1] "thunderstorm wind   0"
## [1] "Thunderstorm Wind   118053"
## [1] "END TEST: after Transformation 5"
</pre>

<pre>
# [1] "Transformation 5 State"
## [1] "The data frame memory requirement is 13700640"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        7"     
## [1] "Number of unique event names         49"
##                 EVTYPE FATALITIES INJURIES PROPDMG PROPDMGEXP CROPDMG CROPDMGEXP
## 5107           Tornado          0        1     2.5          m       0
## 5108 Thunderstorm Wind          1        1     0.0                  0
## 5129           Tornado          0        0   250.0          k       0
## 5130           Tornado          2        7   250.0          k       0
## 5135 Thunderstorm Wind          0        7     0.0                  0
## 5163           Tornado          0        0    25.0          k       0
## 5246 Thunderstorm Wind          0        1     0.0                  0
## 5252 Thunderstorm Wind          1        1     0.0                  0
## 5312           Tornado          0        0    25.0          k       0
## 5315           Tornado          0        2   250.0          k       0
##     
</pre>

</div>
```

<hr style="background : black; height : 2px"/>

#### Test result

```{=html}
<br/>
<strong>Table 8. The in each case, the lower case versions of the event type had a value before the transformation and were zero afterward. None of the "title" case versions had a value before the transformation and only the correctly spelled NWS event type name had a nonzero value after it.</strong> .

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<table style="width : 100%; ">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Type Name</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count Before</th>
<th style="width : 10%; text-align: center; vertical-align : top; border: 1px solid;">Count After</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'thuderstorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'Thuderstorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'thundeerstorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'Thundeerstorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'thunderestorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">19</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'Thunderestorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'thunderstorm'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'Thunderstorm'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'thunderstorm winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">12086</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;" rowspan=2>0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'Thunderstorm Winds'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'thunderstorm wind'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">43655</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr><tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">'Thunderstorm Wind'</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">118053</td>
</tr>


</table>
</div>
<br/><br/>
```

There are a few aspects to these tests that are immediately obvious. Before the transformation, the event types were all written in lower case letters, and none of them were in the stormDF after the transformation. Also, none of those event types, with the exception "thunderstorm wind" were converted the their "title" case equivalent. It is also apparent the count of "Thunderstorm Wind" event grew significantly.

However, whether or not all of the events in the test were converted to "Thunderstorm Wind" is not clear. Before the transformation the test had 55,764 variations of "Thunderstorm Wind". After the transformation, there were 118,053 variations. The reason for the increase has to do with using only six variations rather than the 78 variations in *stormDF*. So even though the test did not prove the number of rows converted to the NWS event type name, it is reasonable to assume it had.

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<br/>
<strong>Table 9.</strong> Data Frame State Changes Due to Transformation 5

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<table style="width : 100%;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13,731,856</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-3104</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">444</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-395</td>
</tr>
</table>

</div>

<br/><br/>
```

-   The reduction in the required memory size, roughly 27 kB.
-   The number of rows is unchanged
-   The number of columns is unchanged.
-   The reduction in the number of event types is 390

The changes to size and structure of the *stormDF* are again insignificant. However, the change in the number of event types indicates the *EVTYPE* type names are the same as the NWS event type names, with the exception of the 'Other' event type name. This was added in Transformation 4.

<hr style="background : black; height : 15px"/>

### Transformation 6

#### Final Data Form

**Goal**

The goal of this Transformation is to add a two colunms to *stormDF* for the total casualties problems and another for economic problems and to remove all other columns except for *EVTYPE*.

**Why?**

The project is designed to answer two questions, one dealing with damage to people and the other dealing with damage to the economy. Since the **storm data file** did not a way to compute the damage to either people or property, this project will use a simple sumto compute *CASUALTIES* and *ECONOMIC_LOSSES* events as follows:

-   casualties (CASUALTIES) are FATALITIES + INJURIES
-   economic costs (ECONOMIC_LOSSES) are PROPDMG \* PROPDMGEXP + CROPDMG \* CROPDMGEXP

**How?**

The *stormDF* is copied to *stormDF*. The copy includes mutating the initial data frame as follows:

1.  *PROPDMGEXP* and *CROPDMGEXP* are converted from letter representations k and m to numeric values 1,000 and 1,000,000 respectively.
2.  The values of *PROPDMG* and *CROPDMG* are multiplied by their respective exponents.
3.  The *CASUALTIES* field is set to FATALITIES + INJURIES.
4.  The *ECONOMIC_LOSSES* field is set to (PROPDMG + CROPDMG)/1,000,000. Scaling the *ECONOMIC_LOSSES* value by 1,000,000 makes the output tables and images clearer.
5.  The *FATALITIES*, *INJURIES*, *PROPDMG*, *PROPDMGEXP*, *CROPDMG*, and *CROPDMGEXP* are droped from the *stormDF* because they are no longer needed.

#### Code

```{r}

### TRANSFORMATION CODE ########################################################
### Transformation 6 condenses the numerical data to modify the data frame to 
### include metrics to describe which event types are the "most harmful with 
### respect to population health" and "which types of events have the greatest 
### economic consequences."
### 
### The mutate function 
### 1. replaces the exponent characters with their numerical equivalent.
### 2. replaces PROPDMG and CROPDMG with the product of PROPDMG and PROPDMGEXP 
###    and the product of CRODMG and CROPDMGEXP respectively.
### 3. add new column CASUALTIES has the sum of FATALITIES and INJURIES. These 
###    are quantified values for events with the most harmful impact on public 
###    health.
### 3. add new column ECONOMIC_LOSSES has the sum of PROPDMG and CROPDMG. These 
###    are quantified values for events with the greatest economic consequences.
###    The values in the ECONOMIC_LOSSES column are divided by 1,000,000 to 
###    reduce the space taken up by printing the full value

################################################################################

stormDF <- stormDF %>% ungroup(.) %>%
  mutate (PROPDMGEXP = ifelse(PROPDMGEXP == 'k', 1000.,
                              ifelse(PROPDMGEXP == 'm', 1000000., 1.)),
          CROPDMGEXP = ifelse(CROPDMGEXP == 'k', 1000.,
                              ifelse(CROPDMGEXP == 'm', 1000000., 1.) ),
          PROPDMG    = PROPDMG * PROPDMGEXP,
          CROPDMG    = CROPDMG * CROPDMGEXP,
          CASUALTIES = (FATALITIES + INJURIES)/PER_ANUM,
          ECONOMIC_LOSSES   = (PROPDMG + CROPDMG)/(PER_ANUM*1000000.)
          ) %>%
  select(EVTYPE, CASUALTIES, ECONOMIC_LOSSES)

  colnames(stormDF) <- c('EVTYPE', 'CASUALTIES', 'ECONOMIC_LOSSES')

print_empty_line(html=FALSE)
################################################################################
### TRANSFORMATION STATE CHANGES
################################################################################
if (CORRECTNESS) {
  print("Transformation 6 State")
  print(paste0("The data frame memory requirement is ", object.size(stormDF)))
  print(paste0("The data frame dimensions are        ", dim(stormDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(stormDF$EVTYPE))))
  print(head(stormDF, n = 10))
}

```

<hr style="background : black; height : 2px"/>

#### Output

```{=html}
<strong>Listing 6: </strong>.
<div style="font-size : 14;">
<pre>
## [1] "Transformation 6 State"
## [1] "The data frame memory requirement is 6395120"
## [1] "The data frame dimensions are        228247"
## [2] "The data frame dimensions are        3"     
## [1] "Number of unique event names         49"
##                 EVTYPE CASUALTIES ECONOMIC_LOSSES
## 5107           Tornado          1    2.500
## 5108 Thunderstorm Wind          2    0.000
## 5129           Tornado          0    0.250
## 5130           Tornado          9    0.250
## 5135 Thunderstorm Wind          7    0.000
## 5163           Tornado          0    0.025
## 5246 Thunderstorm Wind          1    0.000
## 5252 Thunderstorm Wind          2    0.000
## 5312           Tornado          0    0.025
## 5315           Tornado          2    0.250
      .                 .          .        .
      .                 .          .        .
      .                 .          .        .

 </pre>
</div>
```

The transformation state changes show *EVTYPE*, *CASUALTIES*, and *ECONOMIC_LOSSES* are the only columns left in the *stormDF*, which is what was expected.

#### State Changes

```{=html}
<br/>
<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">
<strong>Table 10.</strong> Data Frame State Changes Due to Transformation 6
<table style="width : 100%;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13,728,752</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">6,395,120</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-7,333,632</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-4</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>
</table>

</div>

<br/><br/>
```

-   The reduction in the required memory size by roughly 7.3 MB.
-   The number of rows is unchanged.
-   The reduction in the number of columns by 4.
-   The number of event types is unchanged.

<hr style="background : black; height : 15px"/>

### Transformation 7

#### Group by Event

**Goal**

The goal of Transformation 7 is to group the data based on the NWS weather event names and to accumulate the *CASUALTIES* and *ECONOMIC LOSSES*. 

**Why?**

This project is about answering two questions:

1.  **Across the United States, which types of events are most harmful with respect to population health?**
2.  **Across the United States, which types of events have the greatest economic consequences?**

To answer these questions requires knowing the casualties and economic losses or each event type, and ordering by both casualties and economic losses. The *stormDF* includes this information on an instance (row) level, so this transformation will reduce the instance information to event information.

**How?**

The *stormDF* is grouped by *EVTYPE* by event type and the *CASUALTIES* and *ECONOMIC_LOSSES*, for each instance of an event type are summarized and assigned to the corresponding group. After this transformation, the data is ready for analysis and assigned to the *stormAnalysisDF* data frame.

#### Code

```{r}

### TRANSFORMATION CODE ########################################################
### The transformation will group the data by EVTYPE, summarize the data for 
### each event type, and arrange the events alphabetically.
################################################################################
stormAnalysisDF <- stormDF %>% group_by(EVTYPE) %>% 
  summarise_at(c("CASUALTIES", "ECONOMIC_LOSSES"), sum) %>% 
  arrange(.$EVTYPE, .by_group = TRUE)


print_empty_line(html=FALSE)
### TRANSFORMATION STATE CHANGES ###############################################
################################################################################
if (CORRECTNESS) {
  print("Transformation 7 State")
  print(paste0("The data frame memory requirement is ", object.size(stormAnalysisDF)))
  print(paste0("The data frame dimensions are        ", dim(stormAnalysisDF)))
  print(paste0("Number of unique event names         ", 
               length(unique(stormAnalysisDF$EVTYPE))))
  print(head(stormAnalysisDF, n = 10))
}

```

#### Output

```{=html}
<strong>Output Listing 7: </strong>.

<div style="font-size : 14;">
<pre>
## [1] "Transformation 7 State"
## [1] "The data frame memory requirement is 5520"
## [1] "The data frame dimensions are        49"
## [2] "The data frame dimensions are        3" 
## [1] "Number of unique event names         49"
## # A tibble: 10 × 3
##    EVTYPE                CASUALTIES  ECONOMIC_LOSSES
##    <chr>                      <dbl>     <dbl>
##  1 Astronomical Low Tide          0     0.32 
##  2 Avalanche                    395     3.72 
##  3 Blizzard                     959   777.   
##  4 Coastal Flood                 15   408.   
##  5 Cold/Wind Chill              228   100.   
##  6 Debris Flow                   99   347.   
##  7 Dense Fog                   1156    22.8  
##  8 Dense Smoke                    0     0.1  
##  9 Drought                        4 13519.   
## 10 Dust Devil                    45     0.719
    .          .                     .         .
    .          .                     .         .
         
</pre>
</div>
```

<hr style="background : black; height : 2px"/>

#### State Changes

```{=html}
<br/>
<strong>Table 11.</strong> Data Frame State Changes Due to Transformation 2

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<table style="width : 100%; margin-left: auto; margin-right: auto;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">6,395,120</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">5520</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-6,389,600</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">228247</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">-228198</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>
</table>

</div>

<br/><br/>
```


-   The reduction in the required memory size, roughly 6.3 MB.
-   The reduction in the number of rows -228198.
-   The number of columns is unchanged.
-   The number of event types is unchanged.

<hr style="background : black; height : 15px"/>

## Data Analysis

**Goal**

The data analysis creates two tables from *stormAnalysisDF* and order them by *CASUALTIES*, and *ECONOMIC_LOSSES* columns respectively. These tables are the answers to the project questions.

**Why?**

The goal of the project is to find the worst events in terms of *CASUALTIES* or *ECONOMIC_LOSSES*. If the information were kept in a single table, the data frame can be sorted by *CASUALTIES* or *ECONOMIC_LOSSES* but not both. Therefore, it is necessary to have two identical tables, which will be orded by the respective damage type.

In addition to the required information, the analysis will add two more columns: *PERCENT* and *ACC_PERCENT*. The new columns will help identify the relative severity of each event type and the relative impact of a set of the events.

**How?**

The transformation will copy the *stormAnalysisDF* in a for-loop. The loop index (CASUALTY_IDX or ECONOMIC_IDX) will determine the ordering for each table. The first block of the transformation code copies the *stormAnalysisDF* to a *damageTable* and creates the total value of the selected index type. That is, when the index is CASUALTY_IDX, the transformation will sum all of the values in the *CASUALTIES* column.

The next block is a for-loop used to calculate the *PERCENT* and *ACC_PERCENT* columns. In the loop, the percent is calculated by dividing the number of *CASUALTIES* or *ECONOMIC_LOSSES* by the their respective *totalValue* then multiplied by 100. The value is appended *percentList* and added to the *accumulator*. The *accumulator* is then appended to the *accumulatorList*.

At the end of the loop, the *percentList* and *accumulatorList* are then stored in *damageTable* and stored in *stormDamageList*. 

### Code

```{r analysis}
### ANALYSIS CODE ##############################################################
### The analysis code is a for-loop with the loop variable damageType that takes
### the values of CASUALTY_IDX or ECONOMIC_IDX.
### The loop is divided into four steps
### 
### 1. Step 1
###    1. create a damageTable data frame to hold a copy of the stormAnalysisDF
###    2. sort the damageTable by damage type (CASUALTIES or ECONOMIC_LOSSES)
###    3. calculate the totalValue of the damage type
### 2. Step 2
###    1. initialize the percentList and accumulatorList to empty lists.
###    2. initialize the accumulator to zero.
###    3. calculate the percent and accumulator values and assign them to their
###       respective lists.
### 3. Step 3 add the percent list and accumlated percent list to the 
###    damageTable.
### 4. Step 4 add damageTable to the stormDamageList.
### 
### 
################################################################################

stormDamageList = list()

for (damageType in CASUALTY_IDX:ECONOMIC_IDX) {
  damageTable <- stormAnalysisDF %>%
    arrange(eval(parse(text=DAMAGE_ORDERING[damageType])), .by_group = TRUE)
  totalValue <- sum(damageTable[, damageType + 1])

  # setup accumulator 
  accumulator     <- 0
  percentList     <- list()
  accumulatorList <- list()

  # accumulate the data for the damage lists
  for (i in 1:length(damageTable$EVTYPE)) {
    percent <- damageTable[i, damageType + 1]*100/totalValue
    accumulator <- accumulator + percent
    percentList <- append(percentList, percent)
    accumulatorList <- append(accumulatorList, accumulator)
  }
  
  # store the damage lists in the damageTable
  damageTable$PERCENT <- as.numeric(unlist(percentList))
  damageTable$ACC_PERCENT <- as.numeric(unlist(accumulatorList))

  # store the damageTable in the stormDamageList
  stormDamageList <- list.append(stormDamageList, damageTable)
}

print_empty_line(html=FALSE)
### TRANSFORMATION STATE CHANGES ###############################################
################################################################################
if (CORRECTNESS) {
 for (damageType in CASUALTY_IDX:ECONOMIC_IDX) {
    tempDF <- data.frame(stormDamageList[damageType])
    print(paste0("Damage table ", BAR_FIELD[damageType]))
    print(paste0("The data frame memory requirement is ", object.size(tempDF)))
    print(paste0("The data frame dimensions are        ", dim(tempDF)))
    print(paste0("Number of unique event names         ", 
                 length(unique(tempDF$EVTYPE))))
    print(head(tempDF, n = 10))
  }
}

```

<hr style="background : black; height : 2px"/>

### Output

```{=html}
<strong>Output Listing 8: </strong>.

<div style="font-size : 14;">
<pre>
## [1] "Damage table CASUALTIES"
## [1] "The data frame memory requirement is 6416"
## [1] "The data frame dimensions are        49"
## [2] "The data frame dimensions are        5" 
## [1] "Number of unique event names         49"
##               EVTYPE CASUALTIES ECONOMIC_LOSSES   PERCENT ACC_PERCENT
## 1            Tornado      26311       22865.495 32.308013    32.30801
## 2     Excessive Heat      12363         524.795 15.180874    47.48889
## 3              Flood       7280       28498.142  8.939316    56.42820
## 4  Thunderstorm Wind       6901       10938.959  8.473931    64.90213
## 5          Lightning       6049         951.115  7.427736    72.32987
## 6        Flash Flood       2944       17518.623  3.615020    75.94489
## 7          Ice Storm       2064        3967.041  2.534443    78.47933
## 8          High Wind       1848        5388.025  2.269211    80.74854
## 9           Wildfire       1698        6359.910  2.085022    82.83357
## 10      Winter Storm       1584        1790.229  1.945038    84.77860
    .                 .          .               .         .           .
    .                 .          .               .         .           .
    .                 .          .               .         .           .
    
## [1] "Damage table ECONOMIC_LOSSES"
## [1] "The data frame memory requirement is 6416"
## [1] "The data frame dimensions are        49"
## [2] "The data frame dimensions are        5" 
## [1] "Number of unique event names         49"
##               EVTYPE CASUALTIES ECONOMIC_LOSSES   PERCENT ACC_PERCENT
## 1              Flood       7280       28498.142 18.062940    18.06294
## 2            Tornado      26311       22865.495 14.492807    32.55575
## 3        Flash Flood       2944       17518.623 11.103806    43.65955
## 4               Hail       1215       17334.200 10.986914    54.64647
## 5  Hurricane/Typhoon       1468       14962.528  9.483680    64.13015
## 6            Drought          4       13518.672  8.568522    72.69867
## 7  Thunderstorm Wind       6901       10938.959  6.933426    79.63210
## 8           Wildfire       1698        6359.910  4.031094    83.66319
## 9          High Wind       1848        5388.025  3.415085    87.07827
## 10         Ice Storm       2064        3967.041  2.514425    89.59270
    .                 .          .               .         .           .
    .                 .          .               .         .           .
    .                 .          .               .         .           .
  
</pre>
</div>
```

Both tables have *EVTYPE*, *CASUALTIES*, *ECONOMIC_LOSSES*, *PERCENT*, and 
*ACC_PERCENT* columns, but the first table is sorted by *CASUALTIES* and the 
*PERCENT*, and *ACC_PERCENT* are calculated for *CASUALTIES*. The second table 
is the same as the first except the focus is no *ECONOMIC_LOSSES*. 

<hr style="background : black; height : 2px"/>

### State Changes

```{=html}
<br/>
<strong>Table 11.</strong> Data Frame State Changes Due to Transformation 2

<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<table style="width : 100%; margin-left: auto; margin-right: auto;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Parameter</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Previous</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Current Values</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Change</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Memory requirement</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">5520</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">6416</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">896</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Rows</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Data Frame Columns</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">5</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">2</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Unique Event Types</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">49</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">0</td>
</tr>
</table>

</div>

<br/><br/>
```

**Consequences**
-   The increase in the required memory size for one table  896 B.
-   The number of rows is unchanged.
-   The number of columns is unchanged.
-   The number of event types is unchanged.

<hr style="background : black; height : 15px"/>

## Formatted Output

### Table Formatting

```{r tables}
### KABLE TABLE CODE ###########################################################
### The kable tables are formatted tables used to display the results of the 
### analysis. It makes extensive use of the "constants" described at the 
### beginning the "Processing Code" section. The purpose of these "constants" is
### to turn titles, labels, and some instructions that are dependent on the  
### damage type (CASUALTIES or ECONOMIC LOSSES) into arrays that are referenced
### by damage type.
### 
### In this case, the TABLE_FIELDS[CASUALTY_IDX] defines the columns required 
### by the casualty table and TABLE_LABELS[CASUALTY_IDX] defines the titles used 
### by the casualty table.
###
### Likewise, the TABLE_FIELDS[ECONOMIC_IDX] defines the columns required 
### by the economic losses  table and TABLE_LABELS[ECONOMIC_IDX] defines the  
### titles used by the economic losses table.
###
################################################################################

getTable <- function (damageTable, damageType)
{
  damageTable <- damageTable %>%
    select(eval(parse(text = TABLE_FIELDS[[damageType]])))

  resTable <- knitr::kable(damageTable, "html",
    caption = paste0("<center><strong><font size='1'>",
                     "Table ", (damageType + 12),". United States ",
                     DAMAGE_LABELS[damageType],
                     " due to Severe Weather Events (1996-2012)</font><center></strong>"),
    digits = 3, align = "lrrr",
    col.names = c(TABLE_LABELS[[damageType]]), row.names = TRUE
    ) %>%
    kable_styling(bootstrap_options = c("striped", "hover"),
                  full_width = F,
                  position = "left",
                  font_size = 10) %>%
    column_spec(column=1, width="1cm") %>%
    column_spec(column=2, width="3cm") %>%
    column_spec(column=3, width="2cm") %>%
    column_spec(column=4, width="2cm") %>%
    kable_classic_2()

  return (resTable)

}

```

### Bar Plot Formatting

```{r bars}
### BAR PLOT DAMAGE CODE #######################################################
### The storm damage bar plots use the same information as the kable tables  
### except it shows only the top 25 event types. The x-axis is the event type 
### and the y-axis in the first plot is the number of casualties and in the  
### second is the amount of economic losses in $millions.
### 
### As with the kable tables, the bar plots rely on "constants" describe at the  
### start of this section.  The purpose of these "constants" is
### to turn titles, labels, and some instructions that are dependent on the  
### damage type (CASUALTIES or ECONOMIC LOSSES) into arrays that are referenced
### by damage type.
### 
### The bar plots select the columns it needs using the BAR_SELECT array. 
### BAR_SELECT[CASUALTY_IDX] selects the EVTYPE and CASUALTIES, and 
### BAR_SELECT[ECONOMIC_IDX] selects the EVTYPE and ECONOMIC_LOSSES
### 
### Setting the x-axis to EVTYPE reorders the damage table alphabetically. To 
### ensure the desired ordering, the reorder command will order arrays as
### follows:
### 
### BAR_REORDER[CASUALTY_IDX] is "reorder(EVTYPE, -CASUALTIES)". This will 
### reorder the damageTable by CASUALTIES, and it the context of the aes 
### parameters, EVTYPE will be the x-axis.
### BAR_REORDER[ECONOMIC_IDX] is "reorder(EVTYPE, -ECONOMIC_LOSSES)". This will 
### reorder the damageTable by ECONOMIC_LOSSES, and it the context of the aes 
### parameters, EVTYPE will be the x-axis.
### 
### BAR_FIELD is used to set the y-axis, so
### BAR_FIELD[CASUALTY_IDX] = "CASUALTIES"
### BAR_FIELD[ECONOMIC_IDX] = "ECONOMIC_LOSSES"
### 
### The TABLE_LABELS arrays contain two sets of labels. The second element of 
### the used to set the y-axis label.
### TABLE_LABELS[[CASUALTY_IDX]][2] is "Casualties" 
### TABLE_LABELS[[ECONOMIC_IDX]][2] is "Economic Losses (in millions)" 
###
################################################################################
barPlot <- function (damageTable, damageType)
{
  damageTable <- head(damageTable, n=25) %>%
    select(eval(parse(text = BAR_SELECT[[damageType]])))

  
  plt <- ggplot(damageTable,
                aes(x = eval(parse(text=BAR_REORDER[[damageType]])),
                    y = eval(parse(text=BAR_FIELD[[damageType]])))) +
    ggtitle(paste0("Figure ", damageType,". Storm Related ",
                   str_to_title(TABLE_LABELS[[damageType]][2]))) +
    xlab("Event") +
    ylab(str_to_title(TABLE_LABELS[[damageType]][2])) +
    geom_bar(stat="identity", width=0.7, fill="steelblue1") +
    theme(plot.title = element_text(face="plain", color="black", size=12),
          axis.text.x = element_text(size = 5, face="bold", angle = -80, hjust = 0, vjust = 0),
          axis.text.y = element_text(size = 5, face="bold"),
          axis.title.x = element_text(size = 8, face="bold"),
          axis.title.y = element_text(size = 8, face="bold"))
  save_plot(paste0("EVTYPE-0", damageType, ".png"), plt)
}

```

### Scatter Plot Formatting

```{r}
### SCATTER PLOT DAMAGE CODE ###################################################
### The storm damage scatterplot needs only one of the damage table since, both
### have the same columns and the order does not matter. Each (CASUALTY, 
### ECONOMIC_LOSSES) pair represents an EVTYPE on the scatterplot. Most of the 
### (CASUALTY, ECONOMIC_LOSSES) pairs will be represented as black dots, the 
### ten worst events of each damage type will be represented by colored dots.
### 
### As with the kable tables and the bar plots, the scatterplot relies on 
### "constant" arrays for titles and labels dependent on the damage type   
### (CASUALTIES or ECONOMIC LOSSES) to the label the plot.  
################################################################################
scatterPlot <- function (stormDamageList)#, damageType)
{
  set <- c(head(stormDamageList[[1]]$EVTYPE, n = 10),
                head(stormDamageList[[2]]$EVTYPE, n = 10))
  eventSet <- unique(set)

  worstTable <- stormAnalysisDF[stormAnalysisDF$EVTYPE %in% eventSet,  ]
  plotTable  <- stormAnalysisDF[!(stormAnalysisDF$EVTYPE %in% eventSet),  ]
  plotTable$EVTYPE <- "z"
  plotTable <- rbind(worstTable, plotTable)

  plt <- ggplot(plotTable, aes(x = CASUALTIES, y = ECONOMIC_LOSSES)) +
    ggtitle("Figure 3. United States Public Health vs. Economic Losses") +
    xlab(TABLE_LABELS[[CASUALTY_IDX]][2]) + 
    ylab(TABLE_LABELS[[ECONOMIC_IDX]][2]) +
    theme(plot.title = element_text(face="plain", color="black", size=28),
          axis.title.x =
            element_text(face="bold", color="black", size=14),
          axis.title.y = element_text(face="bold", color="black", size=14),
          axis.text = element_text(size = 10, face="bold")) + #,
    scale_color_manual(
      values = c("antiquewhite4", "aquamarine4", "azure4", "bisque4", "blue3",
                 "brown3", "burlywood4", "cadetblue4", "chartreuse4", 
                 "chocolate3", "coral3", "cornsilk4", "cyan3",
                 "black"
                 ),
      labels =  c("Drought", "Excessive Heat", "Flash Flood", "Flood", "Hail",
        "High Wind", "Hurricane/Typhoon", "Ice Storm", "Lightning",
        "Thunderstorm Wind", "Tornado", "Wildfire", "Winter Storm", "Other"
        ),
      guide = guide_legend(override.aes = list(size = 3) ))   +
    geom_point(data = plotTable, aes(x = CASUALTIES, y = ECONOMIC_LOSSES,
                                     color = EVTYPE), size=2) +
    geom_text_repel (
      data = worstTable,
      aes(x=CASUALTIES, y=ECONOMIC_LOSSES, label = EVTYPE, color = EVTYPE, 
          fontface = "bold"),
      min.segment.length = 0.0, nudge_y = 10-.0, nudge_x = 150.0,
      force = 100.0,
      force_pull = 30.0
    )

  save_plot("CASUALTIES_v_LOSSES.png", plt, ncol = 2, nrow = 2)
}

```

```{r images}

barPlot(stormDamageList[[CASUALTY_IDX]], CASUALTY_IDX)
barPlot(stormDamageList[[ECONOMIC_IDX]], ECONOMIC_IDX)
scatterPlot(stormDamageList)

casualtyTable <- getTable(stormDamageList[[CASUALTY_IDX]], CASUALTY_IDX)
lossesTable   <- getTable(stormDamageList[[ECONOMIC_IDX]], ECONOMIC_IDX)

```

<hr style="background: Black; height: 30px"/>

# Results

This project was designed to answer the following questions:

1.  Across the United States, which types of events are most harmful with respect to population health?
2.  Across the United States, which types of events have the greatest economic consequences?

To some extent, Tables 13 and 14 answer the questions. They list the events ordered by casualties and  economic losses respectively, but they do not suggest which ones are worst. Using the accumulated percent column would allow the emergency manager could declare the top 90% of the ordered events tables to be the worst. This criterion would make worst casualty events be those from "Tornado" to "Heavy Snow". Nevertheless, using an arbitrary limit define what is or is not among the worst weather events may not lead to an accurate conclusion. Instead, visualizing the information may give some clarity in the matter. 
Figures 1 and 2 show the worst 25 events in order of both damage types. These figures give an emergency manager enough information to see how the damage done by event types change relative to each other. Using this criteria, the manager could select "Tornado" through "Lightening" in Figure 1 as a cutoff because of the drop in casualties between "Lightening" and "Flash Flood". Again, this is arbitrary, but it uses the expertise of the manager rather than an arbitrary cutoff value to determine "the worst."

A third option is presented in Figure 3. This figure shows events by the relationship between it casualties and economic losses. The colored dots are a set of the worst ten casualties and the worst ten economic losses and the black dots represent the remainder of the events. Again these arbitrarily represent what it means to be "the worst," but it provides a manager with different perspective of what "the worst" can mean.

## Tables 

Table 13 lists the contents of the casualty damage table. There are a few ways to use this table:

1. Since the table is ordered by the severity of the event, the worst *n* event types are the first *n* entries in the table. 
2. The events types accounting for *x*% of the worst casualties is found by scanning the "Accumulated Percent" for the first value greater than *x*.

If the emergency manager wants to know the ten worst event types for causing casualties, the table shows "Tornado", "Excessive Heat", "Flood", "Thunderstorm Wind", "Lightning", "Flash Flood", "Ice Storm", "High Wind", "Wildfire", and "Winter Storm".

If they want to know which events are responsible for causing 90% the casualties:
"Tornado", "Excessive Heat", "Flood", "Thunderstorm Wind", "Lightning", "Flash Flood", "Ice Storm", "High Wind", "Wildfire", "Winter Storm", "Hurricane/Typhoon", "Winter Weather", "Hail", and Heavy Snow"


```{r}
casualtyTable
```
```{=html}
<div style="font-size : 8; font-weight: normal; text-indent: 100px;">
Source: Storm Events Database [d]
</div>
<br/>
```

Table 14 lists the contents of the economic damage table. As with Table 13, this table can be used for the same proposes:

1. The worst *n* event types are the first *n* entries in the table. 
2. The worst *x*% of the economic losses is found by scanning the "Accumulated Percent" for the first value greater than *x*. 

If the emergency manager wants to know the ten worst event types for causing economic losses, the table shows "Flood", "Tornado", "Flash Flood", "Hail", "Hurricane/Typhoon", "Drought", "Thunderstorm Wind", "Wildfire", "High Wind", and "Ice Storm".

If they want to know which events are responsible for causing 90% the casualties:
"Flood", "Tornado", "Flash Flood", "Hail", "Hurricane/Typhoon", "Drought", "Thunderstorm Wind", "Wildfire", "High Wind", "Ice Storm", and "Tropical Storm".

```{r}
lossesTable
```
```{=html}
<div style="font-size : 8; font-weight: normal; text-indent: 100px;">
Source: Storm Events Database [d]
</div>
```

## Graphs

Using the tables to analyze the worst event types in terms of casualties and economic losses is useful when constrained by a threshold limit e.g, the top 10 or the worst 90%. However, these constraints are artificially imposed and do not allow expert input to determine what constitutes the worst event types.

Figure 1 shows the number of casualties for the twenty-five most harmful weather events. It is the same data found in Table 13 but the plot visualizes the data in a way that gives a different perspective of the impact events types. For example, looking at Figure 1 shows several drops in casualties for each event types. Specifically,  the "Tornado"/"Excessive Heat" drop, the "Excessive Heat"/"Flood" drop, the "Lightening"/"Flash Flood" drop, etc. If one of the drops delineate one group of events from the others, that point could be used as the boundary for the worst event.

For example, if the "Lightening"/"Flash Flood" drop is used as the boundary, then the worst event types are "Tornado", "Excessive Heat", "Flood", "Thunderstorm Wind", "Lightning", and "Flash Flood".

```{r, evtype 1 image}
    knitr::include_graphics("EVTYPE-01.png")
```

As in Figure 1, Figure 2 shows the worst twenty-five events in terms of economic losses. In this plot, the drops consist of "Tornado"/"Flash Flood", "Thunderstorm Wind"/"Wildfire", and "Tropical Storm"/"Frost/Freeze".

For example, if the "Thunderstorm Wind"/"Wildfire" drop is used as the boundary, then the worst event types are "Flood", "Tornado", "Flash Flood", "Hail", "Hurricane/Typhoon", "Drought", and "Thunderstorm Wind".

```{r, message=TRUE, echo = TRUE}
    knitr::include_graphics("EVTYPE-02.png")
```

An issue with the Figures 1 and 2 is their focus on one event or the other but an emergency manager cannot look at an event type based only on casualties or only on economic losses. To fill this gap, Figure 3 shows each event as a relationship between causualties and losses. Each point on the graph is an event type, most of which are black. The colored dots represent are drawn from the worst ten casualty and economic tables.

The point of this plot is to give an emergency manager information regarding the trade-off between casualties and economic losss to assess the worst events. For example, an emergency manager could draw a box around the points that seem less important and select the event types outside the box as the worst case.

Consider a decision to draw the box at $500,000,000 per year and 250 casualties per year. This box will eliminate all of the black dots and the "Wildfire", "High Wind", "Ice Storm", and "Winter Storm". This would make the worst types   


```{r, message=TRUE, echo = TRUE}
    knitr::include_graphics("CASUALTIES_v_LOSSES.png")
```

```{=html}
<br/>
<div style="width : 80%; font-size : 10; font-weight: normal; text-indent: 150px;">

<strong>Table 15.</strong> Worst Events Based on the Relationship between Casualties and Economic Losses. 

<table style="width : 100%; margin-left: auto; margin-right: auto;">
<tr>
<th style="width : 31%; text-align: center; vertical-align : top; border: 1px solid;">Event Type</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Casualty Rank</th>
<th style="width : 23%; text-align: center; vertical-align : top; border: 1px solid;">Economic Rank</th>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Drought</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">37</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">6</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Excessive Heat</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">2</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">20</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Flash Flood</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">6</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">3</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Flood</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">3</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Hail</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">13</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">4</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Hurricane/Typhoon</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">11</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">5</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Lightning</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">5</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">10</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Thunderstorm Wind</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">4</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">7</td>
</tr>

<tr>
<td style="vertical-align : top; text-align: left; border: 1px solid; padding: 5px; border: 2px solid black;">Tornado</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">1</td>
<td style="vertical-align : top; text-align: right; border: 1px solid; padding: 5px; border: 2px solid black;">2</td>
</tr>

</table>

</div>
<!-- <strong>Table 1. The ordered tables answer the required questions. One table shows the NWS Instruction event type names ordered by the highest to lowest casualties. The other table shows the NWS Instruction event type names ordered by the most to least costly.</strong> -->

<br/><br/>
```


```{r, message=TRUE, echo = TRUE}
    knitr::include_graphics("CASUALTIES_v_LOSSES.png")
```

```{=html}
<div style="font-size : 8; font-weight: normal; text-indent: 100px;">
Source: Storm Events Database [d]
</div>
<br/>

```

This question can have several answers, but classifing the events as a relationship between casualties and economic losses gives a more holistic view of the problem. Because of this:

1. Across the United States, which types of events are most harmful with respect to population health?
**The event types that are the most harmful are: Drought, Excessive Heat, Flash Flood, Flood, Hail, Hurricane/Typhoon, Lightning, Thunderstorm Wind, and Tornado**

2.  Across the United States, which types of events have the greatest economic consequences?
**The event types with the greatest economic damages are: Drought, Excessive Heat, Flash Flood, Flood, Hail, Hurricane/Typhoon, Lightning, Thunderstorm Wind, and Tornado**


<hr style="background:#36013F; height:30px"/>

# Bibliography

[c] <https://www.ncdc.noaa.gov/stormevents/details.jsp>

[b] <https://www.ncdc.noaa.gov/stormevents/> Database download

[a] NATIONAL WEATHER SERVICE INSTRUCTION 10-1605 downloaded from <https://www.nws.noaa.gov/directives/sym/pd01016005curr.pdf> on Nov 30, 2022

[d] https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2

```{=html}

</div>
```
