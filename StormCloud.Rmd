---
title: "StormCloud: The Human and Economic Toll from U.S. Storms"
author: "Kevin Glass"
date: "`r Sys.Date()`"
output:
  html_document:
    toc:             true
    toc_depth:       4
    number_sections: true
    toc_float:
      toc_collapsed: true
    theme:           united
    # lumen
    # null
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

# Synopsis

# Code

## Introduction COMMENT

The StormCloud code is complex and long; the uncommented base code is around 400 lines and the testing code (shown in the Appendix 1) is another 200 lines. Some of the techniques used to produce the code have not been discussed in class as are some of the libraries. As a result, the code will include extensive

The

## Setup Phase COMMENT

The Setup Phase is partitioned into four sections. The

### StormCloud Libraries COMMENT

```{r setup phase, message=FALSE}

library(ggplot2)
library(dplyr)
library(cowplot)
library(knitr)
library(kableExtra)
library(stringr)

```

### Testing Constants

The following set of constants are used for debugging, testing, and notifying the user about the status of the programs execution. When running the code to produce useful output, all of these constants are set to FALSE.
  <!-- sourceData  <- ReadStormFile(datafile) -->
  <!-- cleanData   <- CleanData(sourceData) -->
  <!-- clearData   <- RemoveZeroData(cleanData)        -->
  <!-- validData   <- RemoveInvalidEvents(clearData) -->
  <!-- stormData   <- UnifySynonymousTypes(validData) -->
  <!-- analysisData <- SetupFinalDataSet(stormData) -->

```{r test constants}
VERBOSE                     = FALSE     # TRUE  FALSE
DEBUG                       = FALSE
UNIT                        = TRUE
INTEGRATION                 = TRUE
SYSTEM                      = FALSE
EXECUTE                     = FALSE

ALL_FUNCTIONS               = FALSE

MAIN                        = FALSE  # System test
DOWNLOAD_DATA_FILE          = FALSE

MAKE_ANALYSIS_DATA          = FALSE  # Integration test
READ_STORM_FILE             = FALSE
CLEAN_DATA                  = FALSE
REMOVE_ZERO_DATA            = FALSE
REMOVE_INVALID_DATA         = FALSE
UNIFY_TYPES                 = FALSE
FINISH_ANALYSIS_DATASET     = FALSE

MAKE_ANALYSIS_TABLES        = FALSE  # Integration test
MAKE_JURIS_ANALYSIS_SET     = FALSE
GROUP_JURIS_TABLES          = FALSE

MAKE_RESULT_LIST            = TRUE
MAKE_TOP10_TABLES           = FALSE
MAKE_HvE_IMAGE              = FALSE

PHASE_SETUP                 = FALSE
PHASE_MAKE_DATA             = FALSE
PHASE_ANALYSIS              = FALSE
PHASE_CONTROL               = FALSE

```

### User Defined Constants

StormCloud gives the user control over the location and name of the required resource file. It also allows the user to select to a state and county for more detailed analysis of the storm data.

```{r user defined constants}
URL      = 
  "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
DATAFILE = "storm.csv.bz2"

# These define the specific state and county. If the user choses JURISDICTION =
# STATE_INDEX and COUNTY_INDEX, then STATE_ and COUNTY_ must be supplied. In the
# following example, the analysis would be for the state of California and the 
# county would be San Bernardio. NOTE: from above, the user asks for the 
# NATION_INDEX, so the STATE_ and COUNTY_ values will not be considered in the 
# analysis.
STATE_    <- "CA"
COUNTY_   <- "SAN BERNARDINO"

# To get the desired set of tables, add the indices of the desired jurisdictions
# i.e., if the user wants the state and county jursidictions for comparison, use
# JURISDICTION = STATE_INDEX + COUNTY_INDEX. NOTE: the only valid values are:
# 1, 10, 11, 100, 101, 110, 111.

SELECT_NATIONAL_DATA  = TRUE
SELECT_STATE_DATA     = TRUE
SELECT_COUNTY_DATA    = TRUE


```

### Program Constants

The program constants are used to make the code less cryptic. Rather than using numbers to define array indices, loop ranges, and other invariant values, StormCloud uses named constants. For example, the function MakeJurisStormList, uses a for loop with the range CNTY_BASE_IDX through US_BASE_IDX rather than 1 through 3. When the programmer knows the names of the constants, he or she does not need to remember which number represents which thing.

```{r program constants}

# All of the jurisdiction data (county, state, and U.S.) are stored in a 
# a jurisStormTable

CNTY_BASE_IDX     = 1
ST_BASE_IDX       = 2
US_BASE_IDX       = 3

HUMAN_COST        = 1        
ECON_COST         = 2        

# JURISDICTION INDICES
NATION_INDEX      = 100
STATE_INDEX       =  10
COUNTY_INDEX      =   1

JURISDICTION = 
  SELECT_NATIONAL_DATA * NATION_INDEX  +
  SELECT_STATE_DATA    * STATE_INDEX   +
  SELECT_COUNTY_DATA   * COUNTY_INDEX


COUNTY_JURISDICTION   <- 
  "c('EVTYPE', 'COUNTY', 'STATE', 'HUMAN_COST', 'ECON_COST')"

STATE_JURISDICTION    <- 
  "c('EVTYPE', 'STATE', 'HUMAN_COST', 'ECON_COST')"

NATIONAL_JURISDICTION  <- 
  "c('EVTYPE', 'HUMAN_COST', 'ECON_COST')"

DATA_INDICIES <- list()
DATA_FIELDS   <- list()
DATA_FILTERS  <- list()

if (bitwAnd(JURISDICTION, 1)) {
  DATA_INDICIES[[length(DATA_INDICIES) + 1]] <- 1
  DATA_FIELDS[[length(DATA_FIELDS) + 1]]     <- COUNTY_JURISDICTION
  DATA_FILTERS[[length(DATA_FILTERS) + 1]]     <- ".$'COUNTY' == COUNTY_ & .$'STATE' == STATE_"
} 

if (bitwAnd(JURISDICTION, 10)) {
  DATA_INDICIES[length(DATA_INDICIES) + 1] <- 2
  DATA_FIELDS[length(DATA_FIELDS) + 1]     <- STATE_JURISDICTION
  DATA_FILTERS[length(DATA_FILTERS) + 1]     <- ".$'STATE' == STATE_"
} 

if (bitwAnd(JURISDICTION, 100)) {
  DATA_INDICIES[length(DATA_INDICIES) + 1] <- 3
  DATA_FIELDS[length(DATA_FIELDS) + 1]     <- NATIONAL_JURISDICTION
  DATA_FILTERS[length(DATA_FILTERS) + 1]   <- "NATIONAL"
}

```


## Program Control Phase COMMENT


```{r program control phase}
Main <- function(url, datafile) {
  if (VERBOSE & MAIN) {
    print("MAIN: resultList")
  }

  if (!file.exists(datafile)) {
    DownloadDataFile(url, datafile)
  }

  analysisData   <- MakeAnalysisData(datafile)
  analysisTables <- MakeAnalysisTables(analysisData)
  reportList     <- MakeResultList(analysisTables)

  if (DEBUG & MAIN) {
    for (reportTable in reportList) {
        print(paste0("reportTable class is ", class(reportTable)))
        print(head(reportTable))
      }
  }

  return (reportList)
}

```


### Download Data File

```{r}

# DownloadDataFile ##################################################
DownloadDataFile <- function(url, destfile)
{
  if (VERBOSE & DOWNLOAD_DATA_FILE) {
    print(paste0("downloadDataFile: Download ", destfile, " from\n", url))
  }

  retrieve = download.file(url, destfile, mode = "wb")

  if (is.null(retrieve)) {
    print("ERROR: could not access ", url)
    stop()
  }
}  ## End of DownloadDataFile function

```


## Finalize Analysis Data Phase COMMENT


```{=html}
<pre>

                         FinalizeAnalysisData
                                  |
      +---------------------------+------------------------+
      |                                                    |
DownloadDataFile                                    MakeAnalysisData
                                                           |
      +----------------------------------------------------+
      |
      +------------------+-------------------+-----+
      |                  |                   |     |
 ReadStormFile       CleanData     RemoveZeroData  |
                                                   |
      +--------------------------------------------+
      |
      +---------------------+----------------------+
      |                     |                      |
 RemoveInvalidData       UnifyTypes     FinishAnalysisDataset



</pre>
```


### Make Analysis Data


```{r MakeAnalysisData}

MakeAnalysisData <- function(datafile)  {
  if (VERBOSE & MAKE_ANALYSIS_DATA) {
    print("MakeAnalysisData(): coordinate the generation of ")
    print("the jurisTableList from the origional source file")
  }
  
  sourceData   <- ReadStormFile(datafile)
  cleanData    <- CleanData(sourceData)
  clearData    <- RemoveZeroData(cleanData)
  validData    <- RemoveInvalidEvents(clearData)
  stormData    <- UnifyTypes(validData)
  analysisData <- FinishAnalysisDataset(stormData)

  if (DEBUG & READ_STORM_FILE) {
    print("readStormFile: coalesce synonymous data ")
    print(paste0("readStormFile: dim =  ", dim(analysisData)))
    print(head(analysisData))
  }

  return (analysisData)
}  ## End of MakeAnalysisData function

```

#### Read Storm File

```{r}

ReadStormFile <- function(filename)
{
  if (VERBOSE & READ_STORM_FILE) {
    print(paste0("readStormFile: Reading raw storm data from ",
                 filename))
  }

  ## set up table from the input file -------------------------------
  sourceData <- read.table(filename, stringsAsFactors = FALSE, 
                        sep = ",",
                        colClasses = c(rep("NULL",5), NA, NA, NA, 
                                       rep("NULL",14), rep(NA, 6), 
                                       rep("NULL",9)),
                        header = TRUE)

  return (sourceData)
}

```

#### Clean Data

```{r}

# CleanRawData ######################################################
CleanData <- function(sourceData)
{
  if ((VERBOSE | DEBUG) & CLEAN_DATA) {
    print("CleanRawData: Set headers, transform data to numeric ")
    print(head(sourceData))
  }

  sourceData$EVTYPE     <- trimws(sourceData$EVTYPE, which = c("both"))
  sourceData$EVTYPE     <- tolower(sourceData$EVTYPE)
  sourceData$PROPDMGEXP <- tolower(sourceData$PROPDMGEXP)
  sourceData$CROPDMGEXP <- tolower(sourceData$CROPDMGEXP)

  if ((VERBOSE | DEBUG) & CLEAN_DATA) {
    print("CleanRawData: check raw data")
    print(head(sourceData))
  }
  return (sourceData)
}  ## End of CleanRawData function

```

#### Remove Zero Data

```{r}
# RemoveZeroData ###################################################

RemoveZeroData <- function(cleanData)
{
  if (VERBOSE & REMOVE_ZERO_DATA) {
    print("RemoveZeroData: start")
  }

  # remove rows with 
  clearData <- 
    cleanData[
      cleanData$FATALITIES != 0 |
      cleanData$INJURIES != 0 |
      cleanData$PROPDMG != 0 |
      cleanData$CROPDMG != 0, ] 

  if (DEBUG & REMOVE_ZERO_DATA) {
    print("RemoveZeroData: drop zero data")
    print(paste0("RemoveZeroData: dim =  ", dim(clearData)))
    print(head(clearData))
  }

  return (clearData)
}  ## End of LoadStormCostData function

```

#### Remove Invalid Events

```{r}

# RemoveZeroData ######################################################
RemoveInvalidEvents <- function(clearData) {

  validData <- clearData[
    clearData$EVTYPE != '?' &
    clearData$EVTYPE != 'high' &
    clearData$EVTYPE != 'marine accident' &
    clearData$EVTYPE != 'marine mishap' &
    clearData$EVTYPE != 'other'&
    clearData$EVTYPE != 'apache county' &
    clearData$EVTYPE != 'drowning'
    ,]

  if (DEBUG & REMOVE_INVALID_DATA) {
    print("RemoveInvalidEvents: drop invalid event types")
    print(paste0("RemoveZeroData: dim =  ", dim(validData)))
    print(head(validData))
  }

  return (validData)
}

```

#### Unify Types

```{r Unify Types}

# removeSynonymTypes ######################################################
UnifyTypes <- function(clearData) {

  clearData$EVTYPE <-
    gsub("^marine hail$", "Marine Hail",
    gsub("^marine high wind$", "Marine High Wind",
    gsub("^marine strong wind$", "Marine Strong Wind",
    gsub("^marine thunderstorm wind$", "Marine Thunderstorm Wind",
    gsub("^marine tstm wind$", "Marine Thunderstorm Wind",
    gsub("^storm force winds$", "Marine Strong Wind",
    gsub("^(high|heavy|rough).+seas.*$", "Marine Strong Wind",
    gsub("^(high|heavy).+swells.*$", "Marine High Wind",
    gsub("^(typhoon|hurricane.*)$", "Hurricane/Typhoon",
    gsub("^tsunami$", "Tsunami",
    gsub("^tropical depression$", "Tropical Depression",
    gsub("^tropical storm.*$", "Tropical Storm",
    clearData$EVTYPE))))))))))))

  clearData$EVTYPE <-
    gsub("^.*coastal.*$", "Coastal Flood",
    gsub("^.*erosion.*$", "Coastal Flood",
    gsub("^.*tidal.*$", "Coastal Flood",
    gsub("^astronomical high tide$", "Coastal Flood",
    gsub("^storm surge.*$", "Coastal Flood",
    gsub("^high.+(tides|waves).*$", "Coastal Flood",
    gsub("^rogue.+$", "Storm Tide",
    clearData$EVTYPE)))))))

  clearData$EVTYPE <-
    gsub("^lake.*snow$", "Lake-Effect Snow",
    gsub("^lake.*$", "Lakeshore Flood",
    clearData$EVTYPE))
    
  clearData$EVTYPE <-
    gsub("^(dam break|ice floes|ice jam( flood.+|))$", "Flash Flood",
    gsub("^.+small stream urban$", "Flash Flood",
    gsub("^urban.+(small|stream).*$", "Flash Flood",
    gsub("^(small|minor).+flood.*$", "Flash Flood",
    gsub("^flood.+flash.*$", "Flash Flood",
    gsub("^flash.*$", "Flash Flood",
    clearData$EVTYPE))))))

  clearData$EVTYPE <-
    gsub("^fog and cold temperatures$", "Freezing Fog",
    gsub("^freezing fog$", "Freezing Fog",
    gsub("^.*freezing (drizzle|rain|spray).*$", "Winter Weather",
    clearData$EVTYPE)))

  # # must come after marine
  clearData$EVTYPE <-
    gsub("^hail.*$", "Hail",
    gsub("^small hail$", "Hail",
    gsub("^thunderstorm.+hail$", "Hail",
    gsub("^.*tstm.+hail$", "Hail",
    gsub("^(wind|gusty).+hail$", "Hail",
    clearData$EVTYPE)))))

  clearData$EVTYPE <-
    gsub("^(wind|non|gusty).+wind.*$", "High Wind",
    gsub("^(strong|gusty).*$", "Strong Wind",
    gsub("^(rain.+wind|wind.+rain)$", "High Wind",
    gsub("^wind.*$", "High Wind",
    gsub("^gradient wind$", "Rip Current",
    gsub("^rip current.*$", "Rip Current",
    clearData$EVTYPE))))))

  clearData$EVTYPE <-
    gsub("^(wind|gusty).+rain$", "Heavy Rain",
    gsub("^(unseasonal|hvy|high.+heavy).+rain.*$", "Heavy Rain",
    gsub("^rain(.*|fall)$", "Heavy Rain",
    gsub("^heavy (shower|precipitation)$", "Heavy Rain",
    gsub("^heavy.(rain|rains)$", "Heavy Rain",
    gsub("^heavy rain/severe weather$", "Heavy Rain",
    gsub("^(torrential|record|excessive) rainfall$", "Heavy Rain",
    clearData$EVTYPE)))))))

  clearData$EVTYPE <-
    gsub("^heavy rain/lightning", "Lightning",
    gsub("^thunderstorm.+lightning", "Lightning",
    gsub("^tstm.+lightning", "Lightning",
    gsub("^ligntning$", "Lightning",
    gsub("^lighting$", "Lightning",
    gsub("^ligntning+rain$", "Heavy Rain",
    gsub("^lightning.*$", "Lightning",
    clearData$EVTYPE)))))))

  clearData$EVTYPE <-
    gsub("^thunderstorm.+flood($|ing$)", "Flood",
    gsub("^high.+water$", "Flood",
    gsub("^(flood|river|rural|major|break).+$", "Flood",
    gsub("^urban.+flood.*$", "Flood",
    gsub("^ice jam flooding$", "Flood",
    gsub("^rapidly rising water$", "Flood",
    gsub("^flood$", "Flood",
    gsub("^heavy rain(s/flooding| and flood)$", "Flood",
    gsub("^heavy snow/high winds & flood$", "Flood",
    clearData$EVTYPE)))))))))

  clearData$EVTYPE <-
    gsub("^thunder.+$", "Thunderstorm Wind",
    gsub("^tstm.+$", "Thunderstorm Wind",
    gsub("^.+burst.*$", "Thunderstorm Wind",
    gsub("^severe thunder.+$", "Thunderstorm Wind",
    gsub("^severe turb.+$", "Thunderstorm Wind",
    gsub("^whirlwind$", "Thunderstorm Wind",
    gsub("^(thude|thune|tund|thundeer).+$", "Thunderstorm Wind",
    clearData$EVTYPE)))))))

  clearData$EVTYPE <-
    gsub("^(cold air torn|torn).+$", "Tornado",
    gsub("^(gustnado|landspout)$", "Tornado",
    clearData$EVTYPE))

  clearData$EVTYPE <-
    gsub("^.*heavy snow$", "Heavy Snow",
    gsub("^(excessive|high|heavy).+snow$", "Heavy Snow",
    gsub("^record snow$", "Winter Weather",
    clearData$EVTYPE)))

  clearData$EVTYPE <-
    gsub("^extreme.+chill$|^(extended|extreme|record) cold$", "Extreme Cold/Wind Chill",
    gsub("^hypo.+$", "Extreme Cold/Wind Chill",
    clearData$EVTYPE))

  clearData$EVTYPE <-
    gsub("^high.+blizzard.*$", "Blizzard",
    gsub("^.*blowing snow$", "Blizzard",
    gsub("^.*blizzard.*$", "Blizzard",
    gsub("^high.+wind.*$", "High Wind",
    gsub("^snow/high winds$", "Blizzard",
    clearData$EVTYPE)))))

  clearData$EVTYPE <-
    gsub("^heavy.+ice$", "Winter Storm",
    gsub("^heavy.+storm$", "Winter Storm",
    gsub("^heavy.+winds$", "Winter Storm",
    gsub("^heavy.+snow.*$", "Winter Storm",
    gsub("^winter.+storm$", "Winter Storm",
    gsub("^.*winter storm.+$", "Winter Storm",
    clearData$EVTYPE))))))

  clearData$EVTYPE <-
    gsub("^.*sl(ide|ump).*$", "Debris Flow",
    gsub("^(snow|sleet|glaze).+ice storm$", "Winter Weather",
    gsub("^glaze.*$", "Winter Weather",
    clearData$EVTYPE)))


  clearData$EVTYPE <-
    gsub("^cool and wet$", "Winter Weather",
    gsub("^(late|light).+snow.*$", "Winter Weather",
    gsub("^.*winter storm.+$", "Winter Storm",
    gsub("^(rain.snow|snow.rain)$", "Winter Weather",
    gsub("^falling snow/ice$", "Winter Weather",
    gsub("^wint.+$", "Winter Weather",
    clearData$EVTYPE))))))

  clearData$EVTYPE <-
    gsub("^.*drought.*$", "Drought",
    gsub("^.*heat.*$", "Excessive Heat",
    gsub("^hyper.+$", "Excessive Heat",
    gsub("^.*warm.*$", "Heat",
    clearData$EVTYPE))))

  clearData$EVTYPE <-
    gsub("^dust storm.*$", "Dust Storm",
    gsub("^blowing dust$", "Dust Storm",
    gsub("^.*waterspout.*$", "Waterspout",
    gsub("^.*dust devil.*$", "Dust Devil",
    clearData$EVTYPE))))

  clearData$EVTYPE <-
    gsub("^.*(frost|freeze).*$", "Frost/Freeze",
    clearData$EVTYPE)

  clearData$EVTYPE <-
    gsub("^ice storm$", "Ice Storm",
    gsub("^ic(e|y).*$", "Winter Weather",
    gsub("^.*mix.*$", "Winter Weather",
    clearData$EVTYPE)))

clearData$EVTYPE <-
  gsub("^snow.*$", "Winter Weather",
  gsub("^sleet$", "Winter Weather",
  gsub("^.*cold.*$", "Cold/Wind Chill",
  gsub("^low.*$", "Cold/Wind Chill",
  clearData$EVTYPE))))

clearData$EVTYPE <-
  gsub("^cold.*(.*|temperature|wave|winds|wind chill)$", "Cold/Wind Chill",
  gsub("^high.+cold$", "Cold/Wind Chill",
  gsub("^.*cold.*$", "Cold/Wind Chill",
  gsub("^low.*$", "Cold/Wind Chill",
  clearData$EVTYPE))))

  clearData$EVTYPE <-
    gsub("^(high|heavy|rough|hazardous).+surf.*$", "High Surf",
    gsub("^avalanc.*$", "Avalanche",
    gsub("^seiche$", "Seiche",
    gsub("^volcanic ash$", "Volcanic Ash",
    gsub("^astronomical low tide$", "Astronomical Low Tide",
    gsub("^black ice$", "Winter Weather",
    gsub("^excessive wetness$", "Winter Weather",
    gsub("^rainstorm$", "Heavy Rain",
    gsub("^heavy precipitation$", "Heavy Rain",
    gsub("^(dense|.*)fog$", "Dense Fog",
    gsub("^falling snow/ice$", "Winter Weather",
    clearData$EVTYPE)))))))))))

  clearData$EVTYPE <-
    gsub("^.*fire.*$", "Wildfire",
    gsub("^.*funnel.*$", "Funnel Cloud",
    gsub("^.*smoke$", "Dense Smoke",
    clearData$EVTYPE)))

  return (clearData)
}

```

#### Finish Analysis Dataset

```{r}
#FINISH_ANALYSIS_DATASET
# FinishAnalysisDataset ###########################################
FinishAnalysisDataset <- function(analysisData) {

  analysisData <- analysisData %>% ungroup(.) %>%
    mutate (PROPDMGEXP = ifelse(PROPDMGEXP == 'k', 1000.,
                                ifelse(PROPDMGEXP == 'm', 
                                       1000000., 1.) ),
            CROPDMGEXP = ifelse(CROPDMGEXP == 'k', 1000.,
                                ifelse(CROPDMGEXP == 'm', 
                                       1000000., 1.) ),
            PROPDMG       = PROPDMG * PROPDMGEXP,
            CROPDMG       = CROPDMG * CROPDMGEXP,
            FATALITIES    = FATALITIES,
            INJURIES      = INJURIES,
            HUMAN_COST    = FATALITIES + INJURIES,
            ECON_COST     = (PROPDMG + CROPDMG)/1000000.0
            ) %>% 
    select(EVTYPE, COUNTYNAME, STATE, HUMAN_COST, ECON_COST)

  colnames(analysisData) <- eval(parse(text = COUNTY_JURISDICTION))

  return(analysisData)
}  ## End of MakeJurisStormList function

```

### Make Analysis Tables

```{r}

# MakeAnalysisTables ##############################################
MakeAnalysisTables <- function(analysisData) 
{
  if (VERBOSE & MAKE_ANALYSIS_TABLES) {
    print("MakeAnalysisTables: start")
  }
  if (DEBUG & MAKE_ANALYSIS_TABLES) {
    print("MakeAnalysisTables: check data after final data set")
    print(head(analysisData))
  }

  jurisAnalysisSet <- MakeJurisAnalysisSet(analysisData)
  groupedTables    <- GroupJurisTables(jurisAnalysisSet)

  if ((VERBOSE | DEBUG) & MAKE_ANALYSIS_TABLES) {
    print("TransformStormToAnalysis: check data after rename")
    for (i in DATA_INDICIES) {
      print(paste0("Analysis Set ", i))
      print(head(groupedTables[[i]]))
    }
  }

  return (groupedTables)
}  ## End of TransformStormToAnalysis function

```

#### Make Jurisidiction Analysis Set

```{r}
# MakeJurisAnalysisSets ###########################################
MakeJurisAnalysisSet <- function(analysisData) {
  if (VERBOSE & MAKE_JURIS_ANALYSIS_SET) {
    print("MakeJurisAnalysisSet: start")
  }

  print(paste0("length of data filters is ",length(DATA_FILTERS)))
  print(DATA_FILTERS)
  
  jurisAnalysisSet = list()
  for (i in DATA_INDICIES) {
    jurisAnalysisData <- analysisData %>%
      select(eval(parse(text = DATA_FIELDS[[i]])))

    if (DATA_FILTERS[[i]] != "NATIONAL") {
      jurisAnalysisData <- jurisAnalysisData %>%
        filter(eval(parse(text = DATA_FILTERS[[i]])))
    }

    jurisAnalysisSet[[length(jurisAnalysisSet)+1]] <- jurisAnalysisData
  }

  if (VERBOSE & MAKE_ANALYSIS_TABLES) {
    print("MakeJurisAnalysisSet: check source data frames")

    for (i in DATA_INDICIES) {
      print(paste0("jurisTable[", i,"]"))
      print(head(jurisAnalysisSet[[i]]))
    }
  }

  return(jurisAnalysisSet)
}  ## End of MakeJurisStormList function

```

#### Group Jurisidiction Tables

```{r}

# GroupJurisCostTables ######################################################
GroupJurisTables <- function(jurisAnalysisSet)
{
  if (VERBOSE & GROUP_JURIS_TABLES) {
    print("GroupJurisCost: start")
  }
  
  jurisTables = list()
  for (juris in jurisAnalysisSet)
  {
    juris <- juris %>% group_by(EVTYPE)

    juris <- juris %>%
    summarise_at(c("HUMAN_COST", "ECON_COST"), sum)

    juris <- juris %>% arrange(.$EVTYPE,
                                       .by_group = TRUE)

    jurisTables[[length(jurisTables)+1]] <- data.frame(juris)

  }

  if (DEBUG & GROUP_JURIS_TABLES) {
    print("GroupJurisTables: JurisCost")
    for (juris in jurisTables) {
      print(paste0("jurisCost class is ", class(juris)))
      print(head(juris))
    }
  }
  
  return(jurisTables)
} ## End of GroupJurisCost function

```

## Analysis Phase

### Make Result List

```{r}

# GenerateResultsList ##########################################
MakeResultList <- function(analysisTables) {
  if (VERBOSE & MAKE_RESULT_LIST) {
    print("MakeResultList: group the rawTables by jurisdiction.")
  }

  resultList <- list()
  resultList[[length(resultList)+1]] <- MakeTop10Tables(analysisTables, HUMAN_COST)
  resultList[[length(resultList)+1]] <- MakeTop10Tables(analysisTables, ECON_COST)

  return (resultList)
}

```

#### Make Top 10 Tables

```{r}

# MakeTop10HumanTable ###########################################
MakeTop10Tables <- function(analysisTables, type) {
  if (VERBOSE  & MAKE_TOP10_TABLES) {
    print("MakeTop10HumanTable: starting data")
  }

  top10Tables = list()
  for (i in DATA_INDICIES) {
    switch(type,
           table <- analysisTables[[i]] %>% 
             arrange(desc(.$HUMAN_COST), .by_group = TRUE),
           table <- analysisTables[[i]] %>% 
             arrange(desc(.$ECON_COST), .by_group = TRUE)
    )
    top10Tables[[length(top10Tables)+1]] <- table
  }

  return(top10Tables)
}

```

#### Make Human vs. Economic Image

```{r image phase}
MakeHvEImages <- function(analysisTables) {
  if ((VERBOSE | DEBUG) & MAKE_HvE_IMAGE) {
    print("MakeCvC: starting processing")
  }

  imageSet = list()
  for (image in analysisTables) {
    sp <- ggplot(image, aes(x = HUMAN_COST, y = ECON_COST)) +
      geom_point()
    imageSet[[length(imageSet) + 1]] <- sp
  }

  return(imageSet)
}

```

## Execute

```{r execute phase}

if (EXECUTE) {
  resultList <- Main(URL, DATAFILE)
}

```

<hr style="background: DarkOrchid; height: 3px"/>

<!-- https://www.dofactory.com/html/hr/style#:~:text=The%20style%20attribute%20specifies%20the,or%20an%20external%20CSS%20file -->

# Results

``` {r}
# 
# countyLabel = paste0("Top 10 Storm Costs (Human Cost)\n",
#                  COUNTY_, ", ", STATE_)
# stateLabel  = paste0("Top 10 Storm Costs (Human Cost)\n",
#                  state.name[grep(STATE_, state.abb)])
# nationLabel = paste0("Top 10 Storm Costs (Human Cost)\n United States")

```

<table border='1'>
<tr><td width="33%">
``` {r, message=TRUE, echo=FALSE}

  # kbl(head(
  #   resultList[[1]], n=10),
  #   caption = countyLabel, digits=2,
  #   col.names = c("Event", "Total Injured/Dead", "Total Economic Cost")) %>%
  #   kable_styling(bootstrap_options = c("striped", "hover"),
  #                 full_width = F,
  #                 position = "left", font_size = 7)
  # 

```

</td><td width="33%">

``` {r, results = 'asis', echo=FALSE}
  # kbl(head(
  #   resultList[[2]], n=10),
  #   caption = stateLabel, digits=2,
  #   col.names = c("Event", "Total Injured/Dead", "Total Economic Cost")) %>%
  #   kable_styling(bootstrap_options = c("striped", "hover"),
  #                 full_width = F, position = "left",
  #                 font_size = 7)
  # 

```
</td><td width="33%">
```{r, results = 'asis', echo=FALSE}
  # kbl(head(
  #   resultList[[3]], n=10),
  #   caption = nationLabel, digits=2,
  #   col.names = c("Event", "Total Injured/Dead", "Total Economic Cost (in $million")) %>%
  #   kable_styling(bootstrap_options = c("striped", "hover"),
  #                 full_width = F, position = "left",
  #                 font_size = 7)

```
</td></tr>
</table>

# Bibliography
[1] NATIONAL WEATHER SERVICE INSTRUCTION 10-1605


# Appendix 1: Source Data Field

<table>
<tr><th width=25%>Parameter</th><th width=7%>Include</th>
<th width=25%>Parameter</th><th width=7%>Include</th>
<th width=25%>Parameter</th><th width=7%>Include</th></tr>

<tr><td>STATE__</td><td>NULL</td><td>BGN_DATE</td><td>NULL</td><td>BGN_TIME</td><td>NULL</td></tr>

<tr><td>TIME_ZONE</td><td>NULL</td><td>COUNTY</td><td>NULL</td><td><font color="green"><strong>COUNTYNAME</strong></font></td><td>NA</td></tr>

<tr><td><font color="green"><strong>STATE</strong></font></td><td>NA</td><td><font color="green"><strong>EVTYPE</strong></font></td><td>NA</td><td>BGN_RANGE</td><td>NULL</td></tr>

<tr><td>BGN_AZI</td><td>NULL</td><td>BGN_LOCATI</td><td>NULL</td><td>END_DATE</td><td>NULL</td></tr>

<tr><td>END_TIME</td><td>NULL</td><td>COUNTY_END</td><td>NULL</td><td>COUNTYENDN</td><td>NULL</td></tr>

<tr><td>END_RANGE</td><td>NULL</td><td>END_AZI</td><td>NULL</td><td>END_LOCATI</td><td>NULL</td></tr>

<tr><td>LENGTH</td><td>NULL</td><td>WIDTH</td><td>NULL</td><td>F</td><td>NULL</td></tr>

<tr><td>MAG</td><td>NULL</td><td><font color="green"><strong>FATALITIES</strong></font></td><td>NA</td><td><font color="green"><strong>INJURIES</strong></font></td><td>NA</td></tr>

<tr><td><font color="green"><strong>PROPDMG</strong></font></td><td>NA</td><td><font color="green"><strong>PROPDMGEXP</strong></font></td><td>NA</td><td><font color="green"><strong>CROPDMG</strong></font></td><td>NA</td></tr>

<tr><td><font color="green"><strong>CROPDMGEXP</strong></font></td><td>NA</td><td>WFO</td><td>NULL</td><td>STATEOFFIC</td><td>NULL</td></tr>

<tr><td>ZONENAMES</td><td>NULL</td><td>LATITUDE</td><td>NULL</td><td>LONGITUDE</td><td>NULL</td></tr>

<tr><td>LATITUDE_E</td><td>NULL</td><td>LONGITUDE_</td><td>NULL</td><td>REMARKS</td><td>NULL</td></tr>

<tr><td>REFNUM</td><td>NULL</td><td></td><td></td><td></td><td></td>

</tr><table>

# Appendix 2: Testing Phase

## INTEGRATION Make Analysis Data

```{r}

integration_MakeAnalysisData <- function(datafile) {
  analysisData <- MakeAnalysisData(datafile)

  i = 1
  for (analysis in analysisData) {
    print(paste0("List[", i, "]"))
    print(paste0("analysisDate type is ", class(analysisData)))
    print(head(analysis))
    # if (i == US_BASE_IDX) {
    #   write.csv(analysis, paste0("./filtered", i,".csv"))
    # }
    i = i + 1
  }
}


```

### UNIT ReadStormFile

```{r testing ReadStormFile}

# ###################################################################
unit_ReadStormFile <- function(datafile) {
  print("unit_ReadStormFile")
  
  sourceData <- ReadStormFile(datafile)
  
  print("unit_ReadStormFile raw data ###########################")
  print(paste0("Dimensions of sourceData", dim(sourceData)))
  print(head(sourceData))

  print("###########################################################")
}

```

### UNIT CleanData

```{r unit_CleanRawData}

unit_CleanData <- function(datafile) {
  sourceData <- ReadStormFile(datafile)
  cleanData  <- CleanData(sourceData)
  
  print("unit_CleanRawData cleaned data ###########################")
  print(paste0("cleanData dimensions ", dim(cleanData)))
  print(head(cleanData))

  print("###########################################################")
}

```

### UNIT RemoveZeroData

```{r unit_RemoveZeroData}

unit_RemoveZeroData <- function(datafile) {
  sourceData  <- ReadStormFile(datafile)
  cleanData   <- CleanData(sourceData)
  clearData   <- RemoveZeroData(cleanData)       
  
  print("unit_RemoveZeroData reduced data ###########################")
  print(paste0("clearData dimensions ", dim(clearData)))
  print(head(clearData))

  print("###########################################################")
}

```

### UNIT RemoveInvalidEvents

```{r unit_RemoveInvalidEvents}

unit_RemoveInvalidEvents <- function(datafile) {
  sourceData  <- ReadStormFile(datafile)
  cleanData   <- CleanData(sourceData)
  clearData   <- RemoveZeroData(cleanData)
  validData   <- RemoveInvalidEvents(clearData)

  print("unit_RemoveInvalidEvents reduced data ###########################")
  print(paste0("validData dimensions ", dim(validData)))
  print(head(validData))

  print("###########################################################")
}

```


### UNIT UnifyTypes

```{r unit_UnifyTypes}

unit_UnifyTypes <- function(datafile) {
  sourceData  <- ReadStormFile(datafile)
  cleanData   <- CleanData(sourceData)
  clearData   <- RemoveZeroData(cleanData)       
  validData   <- RemoveInvalidEvents(clearData)
  stormData   <- UnifyTypes(validData)

  print("unit_UnifyTypes cleaned data ###########################")
  print(paste0("stormData dimensions ", dim(stormData)))
  print(unique(stormData$EVTYPE))
  print(head(stormData))

  print("###########################################################")
}

```

### UNIT FinishAnalysisDataset

```{r unit_FinishAnalysisDataset}

unit_FinishAnalysisDataset <- function(datafile) {
  sourceData   <- ReadStormFile(datafile)
  cleanData    <- CleanData(sourceData)
  clearData    <- RemoveZeroData(cleanData)       
  validData    <- RemoveInvalidEvents(clearData)
  stormData    <- UnifyTypes(validData)
  analysisData <- FinishAnalysisDataset(stormData)

  print("unit_FinishAnalysisDataset  ###########################")
  print(paste0("analysisData dimensions ", dim(analysisData)))
  print(head(analysisData))

  print("###########################################################")
}

```

## INTEGRATION Make Analysis Tables

```{r}

integration_MakeAnalysisTables <- function(datafile) {
  analysisData   <- MakeAnalysisData(datafile)  
  analysisTables <- MakeAnalysisTables(analysisData)

  print("integration_MakeAnalysisTables  ###########")
  for (analysisTable in analysisTables) {
    print(head(analysisTable))
  }
}

```

#### UNIT Make Jurisdiction Analysis Set

```{r}
unit_MakeJurisAnalysisSet <- function(datafile) {
  analysisSet      <- MakeAnalysisData(datafile)  
  jurisAnalysisSet <- MakeJurisAnalysisSet(analysisSet)
  
  for (i in DATA_INDICIES) {
    print(paste0("jurisTable[", i,"]"))
    print(head(jurisAnalysisSet[[i]]))
  }

}

```

#### UNIT Group Juris Cost

```{r}
unit_GroupJurisTables <- function(datafile) {
  analysisSet      <- MakeAnalysisData(datafile)  
  jurisAnalysisSet <- MakeJurisAnalysisSet(analysisSet)
  groupTables      <- GroupJurisTables(jurisAnalysisSet)

  print("unit_GroupJurisTables ###########")

  print("unit_GroupJurisTables: base table ---------")
  for (groupTable in groupTables) {
    print(head(groupTable, n = 3))
  }

}

```

## INTEGRATION Make Result List

```{r}

integration_MakeResultList <- function(datafile) {
  analysisData   <- MakeAnalysisData(datafile)  
  analysisTables <- MakeAnalysisTables(analysisData)
  resultList     <- MakeResultList(analysisTables)

  print("integration_MakeResultList  ###########")
  for (resultSet in resultList[1]) {
    for (result in resultSet) {
      print(head(result, n=10))
    }
  }

  for (resultSet in resultList[2]) {
    for (result in resultSet) {
      print(head(result, n=10))
    }
  }

}

```

#### UNIT Make Top 10 Tables

```{r}

###################################################################
unit_MakeTop10Tables <- function(datafile) {
  analysisData     <- MakeAnalysisData(datafile)  
  analysisTables   <- MakeAnalysisTables(analysisData)
  top10HumanCosts  <- MakeTop10Tables(analysisTables, HUMAN_COST)
  top10EconCosts   <- MakeTop10Tables(analysisTables, ECON_COST)
  i = 1
  for (humanCost in top10HumanCosts) {
    print(paste0("unit_MakeTop10Tables: top10HumanCosts[", i, "]"))
    print(head(humanCost, n=10))
    i = i + 1
  }

  i = 1
  for (econCost in top10EconCosts) {
    print(paste0("unit_MakeTop10Tables: top10EconCosts[", i, "]"))
    print(head(econCost, n=10))
    i = i + 1
  }

}

```

#### UNIT Make HvE Images

```{r}

###################################################################
unit_MakeHvEImages <- function(datafile) {
  analysisData     <- MakeAnalysisData(datafile)  
  analysisTables   <- MakeAnalysisTables(analysisData)
  print("unit_MakeHvEImages: ")
  images           <- MakeHvEImages(analysisTables)
  for (image in images) {
      print(image)
  }
}

```

## Test Calls

```{r}

if (INTEGRATION & MAKE_ANALYSIS_DATA){
  print("MAKING Storm cost tables")
  integration_MakeAnalysisData(DATAFILE)
}

```

```{r}

if (UNIT & READ_STORM_FILE){
  unit_ReadStormFile(DATAFILE)
}

if (UNIT & CLEAN_DATA){
  unit_CleanData(DATAFILE)
}

if (UNIT & REMOVE_ZERO_DATA){
  unit_RemoveZeroData(DATAFILE)
}

if (UNIT & REMOVE_INVALID_DATA){
  unit_RemoveInvalidEvents(DATAFILE)
}

if (UNIT & UNIFY_TYPES){
  unit_UnifyTypes(DATAFILE)
}

if (UNIT & FINISH_ANALYSIS_DATASET){
  unit_FinishAnalysisDataset(DATAFILE)
}

```


```{r}

if (INTEGRATION & MAKE_ANALYSIS_TABLES){
  print("MAKING Storm cost tables")
  integration_MakeAnalysisData(DATAFILE)
}

if (UNIT & MAKE_JURIS_ANALYSIS_SET){
  unit_MakeJurisAnalysisSet(DATAFILE)
}


if (UNIT & GROUP_JURIS_TABLES){
  unit_GroupJurisTables(DATAFILE)
}


```

```{r}

if (INTEGRATION & MAKE_RESULT_LIST){
  print("MAKING Result list")
  integration_MakeResultList(DATAFILE)
}


if (UNIT & MAKE_TOP10_TABLES){
  print("MAKING Top 10")
  unit_MakeTop10Tables(DATAFILE)
}

if (UNIT & MAKE_HvE_IMAGE){
  print("MAKING HvE Images")
  unit_MakeHvEImages(DATAFILE)
}



```


```{r}
# 
# 
# if (SYSTEM & PHASE_MAKE_DATA) {
#   rawData         <- unit_LoadStormCostData()
#   cleanData       <- unit_CleanRawData(rawData)
#   baseData        <- unit_TransformRawToBase(cleanData)
#   baseTableList   <- unit_MakeBaseTables(baseData)
#   jurisTableList  <- unit_jurisStormTable(baseTableList)
# }
# 
# if (SYSTEM & PHASE_ANALYSIS) {
#   jurisTableList <- MakeAnalysisData(URL, DATAFILE)
#   resultList      <- GenerateResultsList(jurisTableList)
#   i = 1
#   for (jurisTable in resultList) {
#     print(paste0("List[", i, "]"))
#     print(head(jurisTable))
#     i = i + 1
#   }
# }

```


# complete